<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>20&nbsp; Activity: Scoring with Rubrics – Integrating Generative AI into R Workflows: From APIs to Shiny Apps</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./21-chained-workflows.html" rel="next">
<link href="./19-rubric-scoring.html" rel="prev">
<link href="./therefore.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-23878c111f7dac4fb735463ab16209b4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="site_libs/datatables-binding-0.34.0/datatables.js"></script><script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script><link href="site_libs/crosstalk-1.2.2/css/crosstalk.min.css" rel="stylesheet">
<script src="site_libs/crosstalk-1.2.2/js/crosstalk.min.js"></script><link rel="stylesheet" href="style.css">
</head>
<body class="nav-sidebar floating fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./13-single-interactions-via-api.html">Transactional Interactions</a></li><li class="breadcrumb-item"><a href="./activity-scoring-with-rubrics.html"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Activity: Scoring with Rubrics</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Integrating Generative AI into R Workflows: From APIs to Shiny Apps</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Setup</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-R-setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R Setup</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-R-packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">R Packages</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-test-connect.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Testing API Connection</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-api-implementation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">API Implementation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-api-keys.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">API Keys</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Generative AI Models</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-gen-ai-fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Generative AI Fundamentals</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-gen-ai-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Foundational Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-gen-ai-parameters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Generation Parameters</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./activity-parameter-testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Activity: Generation Parameter Testing</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Conversational Interactions</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Integrating LLMs into R Workflows</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-conversations-via-api.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chat Conversations via API</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./activity-content-development-revision.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Activity: Content Development and Revision</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Transactional Interactions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-single-interactions-via-api.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Single Interactions via API</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-prompt-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Prompt Engineering</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-prompt-formulas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Example Prompt Formulas</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./activity-prompt-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Activity: Prompt Engineering</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-mitigating-variability.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Mitigating Output Variability</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18-batch-processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Batch Processing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./19-rubric-scoring.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Scoring with Rubrics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./activity-scoring-with-rubrics.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Activity: Scoring with Rubrics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21-chained-workflows.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Chained Workflows</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./activity-chained-workflows.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Activity: Chained Workflows</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23-calling-other-llms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Call other (non-Gen AI) LLMs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24-rag-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Retrieval Augmented Generation</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">Vibe Coding with Shiny</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25-shiny.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">R Shiny</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26-vibe-coding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">“Vibe Coding”</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./27-shiny-integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Vibe Coding R Shiny Apps</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./activity-shiny-app-development.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Activity: Shiny App Development</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./29-saving-shiny-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Saving R Shiny Data</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">Resources</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30-reference-materials.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Reference Materials</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31-acknowledgements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acknowledgements</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./13-single-interactions-via-api.html">Transactional Interactions</a></li><li class="breadcrumb-item"><a href="./activity-scoring-with-rubrics.html"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Activity: Scoring with Rubrics</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-act-rubric-task" class="quarto-section-identifier"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Activity: Scoring with Rubrics</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="task-med-ed-using-llms-to-apply-analytic-rubrics" class="level2" data-number="20.1"><h2 data-number="20.1" class="anchored" data-anchor-id="task-med-ed-using-llms-to-apply-analytic-rubrics">
<span class="header-section-number">20.1</span> Task: <strong>Med Ed:</strong> Using LLMs to Apply Analytic Rubrics</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">'downloads/claude_plus.R'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">osce_note</span> <span class="op">&lt;-</span> <span class="st">"45-year-old male presents with Chest pain. Reports pressure-like chest discomfort that started this morning while walking up stairs. Some SOB. Recalls previous less severe episodes. H/O high blood pressure (takes atorvastatin). Current vitals positive for hypertension and tachycardia; other vitals unremarkable. Symptoms suggest possible angina; anxiety or GERD could also be considered."</span></span>
<span></span>
<span><span class="va">analytic_rubric</span> <span class="op">&lt;-</span> <span class="st">"For each of the following criteria, determine whether the element is Included or Not Included in the response.</span></span>
<span><span class="st"></span></span>
<span><span class="st">1. Chief concern of chest pain</span></span>
<span><span class="st">2. Episodic pattern of symptoms</span></span>
<span><span class="st">3. Poorly controlled history of hypertension</span></span>
<span><span class="st">4. Vitals indicate hypertension</span></span>
<span><span class="st">5. Pain radiates to the back</span></span>
<span><span class="st">6. Likely diagnosis of acute coronary syndrome (ACS), NSTEMI, or STEMI"</span></span>
<span></span>
<span><span class="va">osce_analytic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">student_note</span>, <span class="va">rubric</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">  Using the rubric provided below, score the following OSCE post-encounter note. </span></span>
<span><span class="st">  For each criterion, indicate whether it was met and provide brief justification for your scoring decision. </span></span>
<span><span class="st">    </span></span>
<span><span class="st">  Here is the student note:{student_note}</span></span>
<span><span class="st">    </span></span>
<span><span class="st">  Here is the rubric:{rubric}</span></span>
<span><span class="st">    </span></span>
<span><span class="st">  Return a completed rubric, indicating which criteria are met or not met and justifications for each component.</span></span>
<span><span class="st">  "</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">analytic_prompt</span> <span class="op">&lt;-</span> <span class="fu">osce_analytic</span><span class="op">(</span><span class="va">osce_note</span>, <span class="va">analytic_rubric</span><span class="op">)</span></span>
<span></span>
<span><span class="va">analytic_response</span> <span class="op">&lt;-</span> <span class="fu">claude_plus</span><span class="op">(</span><span class="va">analytic_prompt</span>,</span>
<span>                                 temperature <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
View model application of Med Ed <em>Analytic</em> Rubric
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Some cleaning for the quarto output; not strictly necessary</span></span>
<span><span class="va">analytic_response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">analytic_response</span>, <span class="st">"#"</span>, <span class="st">"*"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">analytic_response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">analytic_response</span>, </span>
<span>                                      <span class="st">"(?m)^(\\*+)\\s+"</span>, </span>
<span>                                      <span class="st">"\\1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">analytic_response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">analytic_response</span>, </span>
<span>                                      <span class="st">"(?m)^(\\*+)(.*?)(?&lt;!\\*)(\\n)"</span>, </span>
<span>                                      <span class="st">"\\1\\2\\1\\3"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">analytic_response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">analytic_response</span>,</span>
<span>                                      <span class="st">"\\*\\*(\\n)\\*\\*"</span>,</span>
<span>                                      <span class="st">"**\\1\\1**"</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/asis_output.html">asis_output</a></span><span class="op">(</span><span class="va">analytic_response</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><em>OSCE Post-Encounter Note Scoring Rubric</em></p>
<p><strong>1. Chief concern of chest pain</strong></p>
<p><strong>Status: INCLUDED</strong></p>
<p><strong>Justification:</strong> The note clearly states “45-year-old male presents with Chest pain” in the opening sentence, explicitly identifying chest pain as the chief concern.**</p>
<p><strong>2. Episodic pattern of symptoms</strong></p>
<p><strong>Status: INCLUDED</strong></p>
<p><strong>Justification:</strong> The note states “Recalls previous less severe episodes,” which indicates a pattern of recurring symptoms, demonstrating episodic nature.**</p>
<p><strong>3. Poorly controlled history of hypertension</strong></p>
<p><strong>Status: INCLUDED</strong></p>
<p><strong>Justification:</strong> The note mentions “H/O high blood pressure” (history of hypertension) and current vitals show “positive for hypertension,” indicating the hypertension is not well controlled despite treatment.**</p>
<p><strong>4. Vitals indicate hypertension</strong></p>
<p><strong>Status: INCLUDED</strong></p>
<p><strong>Justification:</strong> The note explicitly states “Current vitals positive for hypertension,” directly confirming elevated blood pressure on vital signs.**</p>
<p><strong>5. Pain radiates to the back</strong></p>
<p><strong>Status: NOT INCLUDED</strong></p>
<p><strong>Justification:</strong> There is no mention of radiation of pain to the back or any other location. The note only describes “pressure-like chest discomfort” without documenting radiation patterns.**</p>
<p><strong>6. Likely diagnosis of acute coronary syndrome (ACS), NSTEMI, or STEMI</strong></p>
<p><strong>Status: NOT INCLUDED</strong></p>
<p><strong>Justification:</strong> While the note mentions “possible angina” as a consideration, it does not specifically identify ACS, NSTEMI, or STEMI as likely diagnoses. The differential includes anxiety and GERD with equal weight, suggesting the student did not commit to an acute coronary syndrome diagnosis.**</p>
<hr>
<p><strong>Summary: 4 of 6 criteria met</strong></p>
</div>
</div>
</div>
</div>
</div>
<p>What do you think about the model’s application of the analytic rubric? How might you have scored the note differently? Are there any places where the AI’s application of the rubric was too strict or too lenient? Did the AI appropriately recognize when the student phrased elements of the rubric in different words (lexical variants)?</p>
<p>This activity also highlights another important possible use case using AI: seeing how a rubric might be interpreted and identifying places on the rubric for improvement / increased specificity.</p>
</section><section id="task-med-ed-using-llms-to-apply-holistic-rubrics" class="level2" data-number="20.2"><h2 data-number="20.2" class="anchored" data-anchor-id="task-med-ed-using-llms-to-apply-holistic-rubrics">
<span class="header-section-number">20.2</span> Task: Med Ed: Using LLMs to Apply Holistic Rubrics</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">'downloads/claude_plus.R'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">holistic_rubric</span> <span class="op">&lt;-</span> <span class="st">"Each criterion should be rated as Insufficient (0 points), Developing (1 point), or Proficient (2 points) based on the quality of the response.</span></span>
<span><span class="st"></span></span>
<span><span class="st">Chief complaint is clearly documented</span></span>
<span><span class="st">- Insufficient: Missing or unclear</span></span>
<span><span class="st">- Developing: Present but vague</span></span>
<span><span class="st">- Proficient: Clear and specific</span></span>
<span><span class="st"></span></span>
<span><span class="st">Relevant history is included</span></span>
<span><span class="st">- Insufficient: Minimal or missing key details</span></span>
<span><span class="st">- Developing: Some relevant information</span></span>
<span><span class="st">- Proficient: Comprehensive and pertinent</span></span>
<span><span class="st"></span></span>
<span><span class="st">Physical exam findings are documented</span></span>
<span><span class="st">- Insufficient: Absent or incomplete</span></span>
<span><span class="st">- Developing: Basic findings noted</span></span>
<span><span class="st">- Proficient: Thorough and organized</span></span>
<span><span class="st"></span></span>
<span><span class="st">Assessment includes appropriate differential diagnoses</span></span>
<span><span class="st">- Insufficient: Missing or inappropriate</span></span>
<span><span class="st">- Developing: Limited differential</span></span>
<span><span class="st">- Proficient: Well-developed differential</span></span>
<span><span class="st"></span></span>
<span><span class="st">Plan is reasonable and addresses the patient’s concerns</span></span>
<span><span class="st">- Insufficient: Inadequate or missing</span></span>
<span><span class="st">- Developing: Partially addresses concerns</span></span>
<span><span class="st">- Proficient: Complete and appropriate</span></span>
<span><span class="st"></span></span>
<span><span class="st">Documentation is organized</span></span>
<span><span class="st">- Insufficient: Disorganized or difficult to follow</span></span>
<span><span class="st">- Developing: Somewhat structured</span></span>
<span><span class="st">- Proficient: Logical and clear structure"</span></span>
<span></span>
<span><span class="va">osce_holistic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">student_note</span>, <span class="va">rubric</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">  Using the rubric provided below, score the following OSCE post-encounter note. </span></span>
<span><span class="st"></span></span>
<span><span class="st">  Here is the student note: {student_note}</span></span>
<span><span class="st">    </span></span>
<span><span class="st">  Here is the rubric: {rubric}</span></span>
<span><span class="st">    </span></span>
<span><span class="st">  Return a completed rubric, indicating justifications for each component.</span></span>
<span><span class="st">  "</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">holistic_prompt</span> <span class="op">&lt;-</span> <span class="fu">osce_holistic</span><span class="op">(</span><span class="va">osce_note</span>, <span class="va">holistic_rubric</span><span class="op">)</span></span>
<span></span>
<span><span class="va">holistic_response</span> <span class="op">&lt;-</span> <span class="fu">claude_plus</span><span class="op">(</span><span class="va">holistic_prompt</span>,</span>
<span>                                 temperature <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
View model application of Med Ed <em>Holistic</em> Rubric
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Some cleaning for the quarto output; not strictly necessary</span></span>
<span><span class="va">holistic_response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">holistic_response</span>, <span class="st">"#"</span>, <span class="st">"*"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">holistic_response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">holistic_response</span>, </span>
<span>                                      <span class="st">"(?m)^(\\*+)\\s+"</span>, </span>
<span>                                      <span class="st">"\\1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">holistic_response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">holistic_response</span>, </span>
<span>                                      <span class="st">"(?m)^(\\*+)(.*?)(?&lt;!\\*)(\\n)"</span>, </span>
<span>                                      <span class="st">"\\1\\2\\1\\3"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">holistic_response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">holistic_response</span>,</span>
<span>                                      <span class="st">"\\*\\*(\\n)\\*\\*"</span>,</span>
<span>                                      <span class="st">"**\\1\\1**"</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/asis_output.html">asis_output</a></span><span class="op">(</span><span class="va">holistic_response</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><em>OSCE Post-Encounter Note Scoring Rubric</em></p>
<p><strong>Student Performance Evaluation</strong></p>
<p><strong><em>1. Chief complaint is clearly documented</em></strong></p>
<p><strong>Score: Proficient (2 points)</strong></p>
<p><em>Justification:</em> The chief complaint is clearly stated at the beginning: “45-year-old male presents with Chest pain.” This is specific, concise, and immediately identifies the primary concern.*</p>
<hr>
<p><strong><em>2. Relevant history is included</em></strong></p>
<p><strong>Score: Developing (1 point)</strong></p>
<p><em>Justification:</em> The note includes some relevant information (pressure-like quality, timing with exertion, associated SOB, previous episodes, medication history). However, key details are missing such as: duration of current episode, radiation of pain, associated symptoms (diaphoresis, nausea), cardiac risk factors (smoking, diabetes, family history), medication compliance, and specific details about previous episodes. The history is present but not comprehensive enough for a chest pain presentation.*</p>
<hr>
<p><strong><em>3. Physical exam findings are documented</em></strong></p>
<p><strong>Score: Insufficient (0 points)</strong></p>
<p><em>Justification:</em> Only vital signs are mentioned (hypertension and tachycardia). There is no documentation of actual physical examination findings such as cardiovascular exam (heart sounds, murmurs, JVD), lung exam, chest wall tenderness, peripheral pulses, or general appearance. For a chest pain case, a focused physical examination is essential and is essentially absent here.*</p>
<hr>
<p><strong><em>4. Assessment includes appropriate differential diagnoses</em></strong></p>
<p><strong>Score: Developing (1 point)</strong></p>
<p><em>Justification:</em> The note identifies three possible diagnoses: angina (most appropriate given the presentation), anxiety, and GERD. While these are reasonable considerations, the differential is limited. Missing considerations include acute coronary syndrome/MI, pulmonary embolism, aortic dissection, musculoskeletal pain, and pericarditis. The differentials mentioned are appropriate but not well-developed or prioritized.*</p>
<hr>
<p><strong><em>5. Plan is reasonable and addresses the patient’s concerns</em></strong></p>
<p><strong>Score: Insufficient (0 points)</strong></p>
<p><em>Justification:</em> There is no plan documented whatsoever. The note does not include any diagnostic workup (ECG, cardiac enzymes, chest X-ray), treatment interventions, disposition decisions, or follow-up instructions. This is a critical omission, especially for a potentially life-threatening presentation like chest pain.*</p>
<hr>
<p><strong><em>6. Documentation is organized</em></strong></p>
<p><strong>Score: Developing (1 point)</strong></p>
<p><em>Justification:</em> The note has a basic structure with history elements followed by assessment, but it lacks the standard SOAP format or clear section headers. The information flows somewhat logically but would benefit from better organization with distinct sections for History of Present Illness, Past Medical History, Physical Exam, Assessment, and Plan.*</p>
<hr>
<p><strong>Total Score: 5/12 points (42%)</strong></p>
<p><strong>Overall Comments:</strong> This note captures the essential presenting complaint and some relevant history but falls short in documentation of physical examination findings and completely lacks a management plan. For a high-stakes presentation like chest pain, more thorough documentation is essential for patient safety and clinical decision-making.</p>
</div>
</div>
</div>
</div>
</div>
<p>What do you think about the model’s application of the holistic rubric? How might you have scored the note differently? What did the model do well (either in scoring or its justification), and where do you think it could have improved?</p>
<p>As you can see, applying a holistic rubric is generally more difficult for an AI model because it lacks the context of the clinical encounter. Some methods to improve the model performance in these instances would be to submit each rubric element individually and provide examples of each scoring level, and then empirically verify that the model is applying the rubric as intended. In general, using generative AI to apply holistic rubrics may take more work than having the model apply an analytic rubric.</p>
</section><section id="task-using-llms-to-apply-holistic-rubrics" class="level2" data-number="20.3"><h2 data-number="20.3" class="anchored" data-anchor-id="task-using-llms-to-apply-holistic-rubrics">
<span class="header-section-number">20.3</span> Task: Using LLMs to Apply Holistic Rubrics</h2>
<p>Many attending AIME-CON are working in non-medical educational settings, so I wanted to develop a different example that may be more applicable to the work that you’re doing. For this example I’m going to use the rubric that was part of the <a href="https://haneul-yoo.github.io/dress/"><code>Dataset for Rubric-based Essay Scoring (DREsS)</code></a>. This rubric was based on scoring essays from English as a foreign language (EFL) learners. The essays in that dataset are scored on a range from 1 to 5 with increments of 0.5. The full dataset is available after filling out a <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqlywEiCl5Ddei7T7ujMBpMHFDLRyW7OBo033e_Oe-amGqmQ/viewform">consent form</a>.</p>
<p>The rubric has 3 components:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 5%">
<col style="width: 94%">
</colgroup>
<thead><tr class="header">
<th><strong>Criteria</strong></th>
<th><strong>Description</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Content</td>
<td>Paragraph is well-developed and relevant to the argument, supported with strong reasons and examples.</td>
</tr>
<tr class="even">
<td>Organization</td>
<td>The argument is very effectively structured and developed, making it easy for the reader to follow the ideas and understand how the writer is building the argument. Paragraphs use coherence devices effectively while focusing on a single main idea.</td>
</tr>
<tr class="odd">
<td>Language</td>
<td>The writing displays sophisticated control of a wide range of vocabulary and collocations. The essay follows grammar and usage rules throughout the paper. Spelling and punctuation are correct throughout the paper.</td>
</tr>
</tbody>
</table>
<p>One of the prompts in the data is: “Do you think that smartphones have destroyed communication among family and friends? Give specific reasons and details to support your opinion.”</p>
<p>To ensure that I’m compliant with the consent form agreement, I will be using synthetic responses generated (using Claude Sonnet 4.5) based observed student responses. We’ll also be using the <a href="@sec-claude-plus"><code>claude_plus</code> function we used in the parameter testing activity</a>.</p>
<section id="first-model-call" class="level3" data-number="20.3.1"><h3 data-number="20.3.1" class="anchored" data-anchor-id="first-model-call">
<span class="header-section-number">20.3.1</span> First Model Call</h3>
<p>Let’s start by asking the model to apply the rubric to an essay. We’ll use the default parameters for this first</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">'downloads/claude_plus.R'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">'data/student_essays.Rdata'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">focal_student</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">student_essays</span>, <span class="va">id</span> <span class="op">==</span> <span class="fl">2002</span><span class="op">)</span></span>
<span><span class="va">focal_prompt</span> <span class="op">&lt;-</span> <span class="va">focal_student</span><span class="op">$</span><span class="va">prompt</span></span>
<span><span class="va">focal_essay</span> <span class="op">&lt;-</span> <span class="va">focal_student</span><span class="op">$</span><span class="va">essay</span></span>
<span></span>
<span><span class="co"># Building a function to generate the prompt.</span></span>
<span></span>
<span><span class="va">all_rubric_prompt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prompt</span>, <span class="va">essay</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">You are an expert essay grader. Score the following student essay based on three criteria: Content, Organization, and Language. Each criterion should be scored from 1 to 5 in increments of 0.5 (e.g., 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5).</span></span>
<span><span class="st"></span></span>
<span><span class="st">RUBRIC:</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Content (1-5):**</span></span>
<span><span class="st">Paragraph is well-developed and relevant to the argument, supported with strong reasons and examples.</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Organization (1-5):**</span></span>
<span><span class="st">The argument is very effectively structured and developed, making it easy for the reader to follow the ideas and understand how the writer is building the argument. Paragraphs use coherence devices effectively while focusing on a single main idea.</span></span>
<span><span class="st"> </span></span>
<span><span class="st">**Language (1-5):**</span></span>
<span><span class="st">The writing displays sophisticated control of a wide range of vocabulary and collocations. The essay follows grammar and usage rules throughout the paper. Spelling and punctuation are correct throughout the paper.</span></span>
<span><span class="st"></span></span>
<span><span class="st">PROMPT: {prompt}</span></span>
<span><span class="st"></span></span>
<span><span class="st">ESSAY: {essay}</span></span>
<span><span class="st"></span></span>
<span><span class="st">Please provide scores for each criterion and calculate the total score. Format your response as follows:</span></span>
<span><span class="st">Content: [score]</span></span>
<span><span class="st">Organization: [score]</span></span>
<span><span class="st">Language: [score]</span></span>
<span><span class="st">Total: [sum of three scores]</span></span>
<span><span class="st"></span></span>
<span><span class="st">Provide a brief justification (1-2 sentences) for each score.</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">one_rep_essay</span> <span class="op">&lt;-</span> <span class="fu">claude_plus</span><span class="op">(</span>prompt <span class="op">=</span> <span class="fu">all_rubric_prompt</span><span class="op">(</span><span class="va">focal_prompt</span>, <span class="va">focal_essay</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">one_rep_essay</span>, file <span class="op">=</span> <span class="st">'data/one_rep_essay.Rdata'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Claude’s essay evaluation:</p>
<p>Essay Evaluation</p>
<p><strong>Content: 3/5</strong> The essay presents a balanced view with relevant examples (grandmother video calls, phone distraction), but the development is superficial. The argument lacks depth, multiple examples, and detailed elaboration that would make it well-developed and strongly supported.</p>
<p><strong>Organization: 3.5/5</strong> The essay follows a clear structure (introducing both sides, personal example, counterpoint, conclusion) and is easy to follow. However, it’s quite brief and would benefit from additional paragraphs to fully develop each main idea separately rather than condensing everything into one paragraph.</p>
<p><strong>Language: 3.5/5</strong> The writing demonstrates good control of grammar and vocabulary with no significant errors ("on one hand/on the other hand," "responsibly"). However, the vocabulary range is relatively basic and lacks the sophistication and variety expected for a top score.</p>
<p><strong>Total: 10/15</strong></p>
<p>As noted in the previously (in WHAT section), part of the beauty of generative AI model is the variability in output. Great for creative tasks, but not optimal for things like the present task of applying a scoring rubric to a student response.</p>
</section><section id="repeating-score-task" class="level3" data-number="20.3.2"><h3 data-number="20.3.2" class="anchored" data-anchor-id="repeating-score-task">
<span class="header-section-number">20.3.2</span> Repeating Score Task</h3>
<p>Let’s repeat the above process 20 times in a loop, extracting the scores after each model response.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Function to extract scores</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/">httr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jeroen.r-universe.dev/jsonlite">jsonlite</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://glue.tidyverse.org/">glue</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set your Anthropic API key</span></span>
<span><span class="va">ANTHROPIC_API_KEY</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"ANTHROPIC_API_KEY"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the prompt function (from previous artifact)</span></span>
<span><span class="va">all_rubric_prompt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prompt</span>, <span class="va">essay</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">You are an expert essay grader. Score the following student essay based on three criteria: Content, Organization, and Language. Each criterion should be scored from 1 to 5 in increments of 0.5.</span></span>
<span><span class="st"></span></span>
<span><span class="st">RUBRIC:</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Content (1-5):**</span></span>
<span><span class="st">- 5: Exceptionally well-developed and highly relevant, with strong reasons and compelling examples.</span></span>
<span><span class="st">- 4: Well-developed and relevant, with clear reasons and good examples.</span></span>
<span><span class="st">- 3: Adequately developed with acceptable reasons and examples.</span></span>
<span><span class="st">- 2: Underdeveloped with weak or insufficient reasons and examples.</span></span>
<span><span class="st">- 1: Poorly developed and largely irrelevant.</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Organization (1-5):**</span></span>
<span><span class="st">- 5: Exceptionally well-structured, very easy to follow, expert use of coherence devices.</span></span>
<span><span class="st">- 4: Effectively structured, easy to follow, good use of coherence devices.</span></span>
<span><span class="st">- 3: Adequate structure, generally followable.</span></span>
<span><span class="st">- 2: Weak structure, sometimes difficult to follow.</span></span>
<span><span class="st">- 1: Lacks clear structure, confusing.</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Language (1-5):**</span></span>
<span><span class="st">- 5: Sophisticated vocabulary, grammar and spelling correct throughout.</span></span>
<span><span class="st">- 4: Good vocabulary control, generally correct with minor errors.</span></span>
<span><span class="st">- 3: Adequate vocabulary, acceptable with some errors.</span></span>
<span><span class="st">- 2: Limited vocabulary, frequent errors that sometimes impede understanding.</span></span>
<span><span class="st">- 1: Very limited vocabulary, numerous errors.</span></span>
<span><span class="st"></span></span>
<span><span class="st">PROMPT: {prompt}</span></span>
<span><span class="st"></span></span>
<span><span class="st">ESSAY: {essay}</span></span>
<span><span class="st"></span></span>
<span><span class="st">Format your response as:</span></span>
<span><span class="st">Content: [score]</span></span>
<span><span class="st">Organization: [score]</span></span>
<span><span class="st">Language: [score]</span></span>
<span><span class="st">Total: [sum of three scores]</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Score extraction function with debug capability</span></span>
<span><span class="va">extract_scores</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">gpt_output</span>, <span class="va">debug</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">debug</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== DEBUG: Extracting scores ===\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Input text (first 300 chars):\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="fl">1</span>, <span class="fl">300</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Extract Content score - try multiple patterns</span></span>
<span>  <span class="va">content_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"Content:?\\s*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">content_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Try alternate pattern</span></span>
<span>    <span class="va">content_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"\\*\\*Content:?\\*\\*[^0-9]*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">content</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">content_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Extract Organization score</span></span>
<span>  <span class="va">org_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"Organization:?\\s*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">org_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">org_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"\\*\\*Organization:?\\*\\*[^0-9]*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">organization</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">org_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Extract Language score</span></span>
<span>  <span class="va">lang_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"Language:?\\s*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">lang_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">lang_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"\\*\\*Language:?\\*\\*[^0-9]*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">language</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">lang_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Extract Total score</span></span>
<span>  <span class="va">total_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"Total:?\\s*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">total_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">total_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"\\*\\*Total:?\\*\\*[^0-9]*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">total_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">debug</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Extracted values:\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Content:"</span>, <span class="va">content</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Organization:"</span>, <span class="va">organization</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Language:"</span>, <span class="va">language</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Total:"</span>, <span class="va">total</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Return as a named vector</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>content <span class="op">=</span> <span class="va">content</span>, </span>
<span>    organization <span class="op">=</span> <span class="va">organization</span>, </span>
<span>    language <span class="op">=</span> <span class="va">language</span>, </span>
<span>    total <span class="op">=</span> <span class="va">total</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Returns a data frame (useful for binding multiple results)</span></span>
<span><span class="va">extract_scores_df</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">gpt_output</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">scores</span> <span class="op">&lt;-</span> <span class="fu">extract_scores</span><span class="op">(</span><span class="va">gpt_output</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    content <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"content"</span><span class="op">]</span>,</span>
<span>    organization <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"organization"</span><span class="op">]</span>,</span>
<span>    language <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"language"</span><span class="op">]</span>,</span>
<span>    total <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"total"</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">essay_score_df</span> <span class="op">&lt;-</span> <span class="fu">extract_scores_df</span><span class="op">(</span><span class="va">one_rep_essay</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">essay_score_again</span> <span class="op">&lt;-</span> <span class="fu">claude_plus</span><span class="op">(</span>prompt <span class="op">=</span> <span class="fu">all_rubric_prompt</span><span class="op">(</span><span class="va">focal_prompt</span>, <span class="va">focal_essay</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">essay_score_one</span> <span class="op">&lt;-</span> <span class="fu">extract_scores_df</span><span class="op">(</span><span class="va">essay_score_again</span><span class="op">)</span></span>
<span>  <span class="va">essay_score_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">essay_score_df</span>, <span class="va">essay_score_one</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">essay_score_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">essay_score_df</span>, file <span class="op">=</span> <span class="st">"data/essay_score_df.Rdata"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s now see how consistently the model applied the scores to the essay:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Function to get summary statistics for multiple scored essays</span></span>
<span><span class="va">summarize_scores</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">score_df</span><span class="op">)</span><span class="op">{</span></span>
<span> </span>
<span>  <span class="co"># Calculate summary statistics</span></span>
<span>  <span class="va">summary_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Content"</span>, <span class="st">"Organization"</span>, <span class="st">"Language"</span>, <span class="st">"Total"</span><span class="op">)</span>,</span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">summary_stats</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data/essay_score_df.Rdata"</span><span class="op">)</span></span>
<span><span class="va">score_summary</span> <span class="op">&lt;-</span> <span class="fu">summarize_scores</span><span class="op">(</span><span class="va">essay_score_df</span><span class="op">)</span></span>
<span><span class="va">score_summary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>     criterion  mean        sd min  max
1      Content 3.025 0.1118034 3.0  3.5
2 Organization 3.250 0.2564946 3.0  3.5
3     Language 3.500 0.0000000 3.5  3.5
4        Total 9.775 0.2552089 9.5 10.0</code></pre>
</div>
</div>
<p>Pretty good! There is only .5 variation in scores for <code>Content</code> and <code>Organization</code>, and no variation in <code>Language</code> scores.</p>
</section><section id="repeating-score-task-temp-0" class="level3" data-number="20.3.3"><h3 data-number="20.3.3" class="anchored" data-anchor-id="repeating-score-task-temp-0">
<span class="header-section-number">20.3.3</span> Repeating Score Task (<code>Temp = 0</code>)</h3>
<p>Let’s now repeat the task, but turn the temperature down and see how this affects score variability.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">low_temp_essay</span> <span class="op">&lt;-</span> <span class="fu">claude_plus</span><span class="op">(</span>prompt <span class="op">=</span> <span class="fu">all_rubric_prompt</span><span class="op">(</span><span class="va">focal_prompt</span>, <span class="va">focal_essay</span><span class="op">)</span>,</span>
<span>                              temperature <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">low_temp_df</span> <span class="op">&lt;-</span> <span class="fu">extract_scores_df</span><span class="op">(</span><span class="va">low_temp_essay</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">19</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">low_temp_score_again</span> <span class="op">&lt;-</span> <span class="fu">claude_plus</span><span class="op">(</span>prompt <span class="op">=</span> <span class="fu">all_rubric_prompt</span><span class="op">(</span><span class="va">focal_prompt</span>, <span class="va">focal_essay</span><span class="op">)</span>,</span>
<span>                                      temperature <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">low_temp_score_one</span> <span class="op">&lt;-</span> <span class="fu">extract_scores_df</span><span class="op">(</span><span class="va">low_temp_score_again</span><span class="op">)</span></span>
<span>  <span class="va">low_temp_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">low_temp_df</span>, <span class="va">low_temp_score_one</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">low_temp_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">low_temp_df</span>, file <span class="op">=</span> <span class="st">"data/low_temp_df.Rdata"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data/low_temp_df.Rdata"</span><span class="op">)</span></span>
<span><span class="va">low_temp_summary</span> <span class="op">&lt;-</span> <span class="fu">summarize_scores</span><span class="op">(</span><span class="va">low_temp_df</span><span class="op">)</span></span>
<span><span class="va">low_temp_summary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>     criterion mean sd min max
1      Content  3.0  0 3.0 3.0
2 Organization  3.0  0 3.0 3.0
3     Language  3.5  0 3.5 3.5
4        Total  9.5  0 9.5 9.5</code></pre>
</div>
</div>
<p>Nice! The eliminated all of the score variability. However, given the vague nature of the rubric, we still don’t know if these scores are <em>accurate</em> - we may be consistently missing the mark on what the true score should be. The rubric criteria are broad and it’s unclear how one should apply the rubric. What constitutes each score level for the individual criteria?</p>
<p>Interestingly, when I asked Anthropic for help in developing a scoring rubric for the essays, it recognized that having clear descriptions of the different scoring categories was important, so it made them up! The prompt below shows how the model decided to describe each of the score categories. Obviously these descriptions should be developed and reviewed by subject matter experts, but for the purposes of the workshop we’ll just use what Claude generated. In your process you also want to check that your generative AI model is utilizing the rubric correctly - supplying a detailed rubric and obtaining consistent results alone isn’t sufficient.</p>
</section><section id="scoring-with-detailed-rubric" class="level3" data-number="20.3.4"><h3 data-number="20.3.4" class="anchored" data-anchor-id="scoring-with-detailed-rubric">
<span class="header-section-number">20.3.4</span> Scoring with Detailed Rubric</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">claude_all_rubric_prompt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prompt</span>, <span class="va">essay</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">You are an expert essay grader. Score the following student essay based on three criteria: Content, Organization, and Language. Each criterion should be scored from 1 to 5 in increments of 0.5 (e.g., 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5).</span></span>
<span><span class="st"></span></span>
<span><span class="st">RUBRIC:</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Content (1-5):**</span></span>
<span><span class="st">- 5: Paragraph is exceptionally well-developed and highly relevant to the argument, supported with strong, specific reasons and compelling examples.</span></span>
<span><span class="st">- 4: Paragraph is well-developed and relevant to the argument, supported with clear reasons and good examples.</span></span>
<span><span class="st">- 3: Paragraph is adequately developed with some relevance to the argument, supported with acceptable reasons and examples.</span></span>
<span><span class="st">- 2: Paragraph is underdeveloped or somewhat irrelevant to the argument, with weak or insufficient reasons and examples.</span></span>
<span><span class="st">- 1: Paragraph is poorly developed and largely irrelevant to the argument, lacking meaningful reasons and examples.</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Organization (1-5):**</span></span>
<span><span class="st">- 5: The argument is exceptionally well-structured and developed, making it very easy for the reader to follow ideas and understand how the argument is built. Paragraphs use coherence devices expertly while maintaining clear focus on main ideas.</span></span>
<span><span class="st">- 4: The argument is effectively structured and developed, making it easy for the reader to follow ideas. Paragraphs use coherence devices well and focus on main ideas.</span></span>
<span><span class="st">- 3: The argument has adequate structure and development. The reader can follow most ideas. Paragraphs use some coherence devices and generally focus on main ideas.</span></span>
<span><span class="st">- 2: The argument has weak structure and development. Ideas are sometimes difficult to follow. Paragraphs use few coherence devices and may lose focus.</span></span>
<span><span class="st">- 1: The argument lacks clear structure and development. Ideas are confusing and hard to follow. Paragraphs lack coherence devices and focus.</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Language (1-5):**</span></span>
<span><span class="st">- 5: The writing displays sophisticated control of a wide range of vocabulary and collocations. Grammar and usage are correct throughout. Spelling and punctuation are correct throughout.</span></span>
<span><span class="st">- 4: The writing displays good control of vocabulary and collocations. Grammar and usage are generally correct with only minor errors. Spelling and punctuation are generally correct.</span></span>
<span><span class="st">- 3: The writing displays adequate vocabulary with some variety. Grammar and usage are acceptable with some errors that do not impede understanding. Spelling and punctuation are mostly correct.</span></span>
<span><span class="st">- 2: The writing displays limited vocabulary with little variety. Grammar and usage contain frequent errors that sometimes impede understanding. Spelling and punctuation errors are noticeable.</span></span>
<span><span class="st">- 1: The writing displays very limited vocabulary. Grammar and usage contain numerous errors that significantly impede understanding. Spelling and punctuation errors are frequent.</span></span>
<span><span class="st"></span></span>
<span><span class="st">PROMPT: {prompt}</span></span>
<span><span class="st"></span></span>
<span><span class="st">ESSAY: {essay}</span></span>
<span><span class="st"></span></span>
<span><span class="st">Please provide scores for each criterion and calculate the total score. Format your response as follows:</span></span>
<span><span class="st">Content: [score]</span></span>
<span><span class="st">Organization: [score]</span></span>
<span><span class="st">Language: [score]</span></span>
<span><span class="st">Total: [sum of three scores]</span></span>
<span><span class="st"></span></span>
<span><span class="st">Provide a brief justification (1-2 sentences) for each score.</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s now apply this rubric to the example essay and see how it might impact model-generated scores.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">claude_rubric_score</span> <span class="op">&lt;-</span> <span class="fu">claude_plus</span><span class="op">(</span>prompt <span class="op">=</span> <span class="fu">claude_all_rubric_prompt</span><span class="op">(</span><span class="va">focal_prompt</span>, <span class="va">focal_essay</span><span class="op">)</span>,</span>
<span>                                   temperature <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">claude_rubric_df</span> <span class="op">&lt;-</span> <span class="fu">extract_scores_df</span><span class="op">(</span><span class="va">claude_rubric_score</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">19</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">claude_rubric_score_again</span> <span class="op">&lt;-</span> <span class="fu">claude_plus</span><span class="op">(</span>prompt <span class="op">=</span> <span class="fu">claude_all_rubric_prompt</span><span class="op">(</span><span class="va">focal_prompt</span>, <span class="va">focal_essay</span><span class="op">)</span>,</span>
<span>                                           temperature <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">claude_rubric_one</span> <span class="op">&lt;-</span> <span class="fu">extract_scores_df</span><span class="op">(</span><span class="va">claude_rubric_score_again</span><span class="op">)</span></span>
<span>  <span class="va">claude_rubric_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">claude_rubric_df</span>, <span class="va">claude_rubric_one</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">claude_rubric_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">claude_rubric_df</span>, file <span class="op">=</span> <span class="st">"data/claude_rubric_df.Rdata"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data/claude_rubric_df.Rdata"</span><span class="op">)</span></span>
<span><span class="va">claude_rubric_summary</span> <span class="op">&lt;-</span> <span class="fu">summarize_scores</span><span class="op">(</span><span class="va">claude_rubric_df</span><span class="op">)</span></span>
<span><span class="va">claude_rubric_summary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>     criterion mean sd min max
1      Content  3.0  0 3.0 3.0
2 Organization  3.0  0 3.0 3.0
3     Language  3.5  0 3.5 3.5
4        Total  9.5  0 9.5 9.5</code></pre>
</div>
</div>
<p>Whoa! These are the exact same scores as when we didn’t provide detailed rubric explanation in our prompt. This suggests to me that the model is generating a similar rubric each time through <a href="@sec-invisble">invisible instructions</a>, but I can’t know this for sure.</p>
<p>It has also been empirically demonstrated (find the citations, Chris) that these models don’t apply rubrics well at the extremes - the lowest and highest scores. When I used Claude to help generate synthetic student responses, I asked it have a range of score values represented in the 10 generated essays. It’ll be useful to repeat the same experiment on all 10 essays to see if the scoring variability is consistent across the score range. (There’s a strong possibility that it will be - I asked Claude to generate the essays and now I’m asking it to score essays it generated.)</p>
</section><section id="batch-scoring" class="level3" data-number="20.3.5"><h3 data-number="20.3.5" class="anchored" data-anchor-id="batch-scoring">
<span class="header-section-number">20.3.5</span> Batch Scoring</h3>
<p>Now that we’re repeating the same task across a batch of essays, it’s a great time to introduce batch scoring! This generally works as you’d think - you submit multiple tasks at once to the API to complete in parallel - with the one wrinkle that Anthropic requires that the requests be in the JSONL format. In addition to being able to submit multiple requests at once, it’s also cheaper to use than single-call API interactions. As of this writing (Oct 19, 2025), you save 50% with batch pricing. This drops input costs from $3 per 1M tokens to $1.50 per 1M token, and output costs from $15 per 1M tokens to $7.50 per 1M tokens.</p>
<section id="creating-batch-requests" class="level4" data-number="20.3.5.1"><h4 data-number="20.3.5.1" class="anchored" data-anchor-id="creating-batch-requests">
<span class="header-section-number">20.3.5.1</span> Creating Batch Requests</h4>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Step 1: Read essays and create batch requests</span></span>
<span><span class="va">create_batch_requests</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">essays_df</span>, <span class="va">n_repetitions</span> <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Create a list to store batch requests</span></span>
<span>  <span class="va">batch_requests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">request_counter</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="co"># Create n_repetitions requests for each essay (grouped by essay)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">essays_df</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">essay_prompt</span> <span class="op">&lt;-</span> <span class="fu">claude_all_rubric_prompt</span><span class="op">(</span><span class="va">essays_df</span><span class="op">$</span><span class="va">prompt</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">essays_df</span><span class="op">$</span><span class="va">essay</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Create 20 requests for this essay</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">rep</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_repetitions</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        custom_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"essay_"</span>, <span class="va">essays_df</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"_rep_"</span>, <span class="va">rep</span><span class="op">)</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>          model <span class="op">=</span> <span class="st">"claude-sonnet-4-20250514"</span>,</span>
<span>          max_tokens <span class="op">=</span> <span class="fl">1024</span>,</span>
<span>          messages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>              role <span class="op">=</span> <span class="st">"user"</span>,</span>
<span>              content <span class="op">=</span> <span class="va">essay_prompt</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">batch_requests</span><span class="op">[[</span><span class="va">request_counter</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">request</span></span>
<span>      <span class="va">request_counter</span> <span class="op">&lt;-</span> <span class="va">request_counter</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Created"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">batch_requests</span><span class="op">)</span>, <span class="st">"batch requests for"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">essays_df</span><span class="op">)</span>, <span class="st">"essays\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">batch_requests</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">essay_batch_requests</span> <span class="op">&lt;-</span> <span class="fu">create_batch_requests</span><span class="op">(</span><span class="va">student_essays</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="writing-requests-to-jsonl" class="level4" data-number="20.3.5.2"><h4 data-number="20.3.5.2" class="anchored" data-anchor-id="writing-requests-to-jsonl">
<span class="header-section-number">20.3.5.2</span> Writing Requests to JSONL</h4>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Step 2: Write requests to JSONL file</span></span>
<span><span class="va">write_batch_file</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">batch_requests</span>, <span class="va">output_file</span> <span class="op">=</span> <span class="st">"batch_requests.jsonl"</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Write each request as a JSON line</span></span>
<span>  <span class="va">jsonl_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">batch_requests</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html">toJSON</a></span><span class="op">(</span><span class="va">req</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/writeLines.html">writeLines</a></span><span class="op">(</span><span class="va">jsonl_lines</span>, <span class="va">output_file</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_file</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">essay_batch_jsonl</span> <span class="op">&lt;-</span> <span class="fu">write_batch_file</span><span class="op">(</span><span class="va">essay_batch_requests</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="submitting-batch-request" class="level4" data-number="20.3.5.3"><h4 data-number="20.3.5.3" class="anchored" data-anchor-id="submitting-batch-request">
<span class="header-section-number">20.3.5.3</span> Submitting Batch Request</h4>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Step 3: Submit batch job to Anthropic</span></span>
<span><span class="va">submit_batch</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">jsonl_file</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Read and parse each line of the JSONL file</span></span>
<span>  <span class="va">jsonl_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="va">jsonl_file</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Parse each JSON line into a list</span></span>
<span>  <span class="va">requests_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">jsonl_lines</span>, <span class="kw">function</span><span class="op">(</span><span class="va">line</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="va">line</span>, simplifyVector <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Create batch</span></span>
<span>  <span class="va">response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/POST.html">POST</a></span><span class="op">(</span></span>
<span>    url <span class="op">=</span> <span class="st">"https://api.anthropic.com/v1/messages/batches"</span>,</span>
<span>    <span class="fu"><a href="https://httr.r-lib.org/reference/add_headers.html">add_headers</a></span><span class="op">(</span></span>
<span>      <span class="st">"x-api-key"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"ANTHROPIC_API_KEY"</span><span class="op">)</span>,</span>
<span>      <span class="st">"anthropic-version"</span> <span class="op">=</span> <span class="st">"2023-06-01"</span>,</span>
<span>      <span class="st">"content-type"</span> <span class="op">=</span> <span class="st">"application/json"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    body <span class="op">=</span> <span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html">toJSON</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      requests <span class="op">=</span> <span class="va">requests_list</span></span>
<span>    <span class="op">)</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    encode <span class="op">=</span> <span class="st">"json"</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://httr.r-lib.org/reference/status_code.html">status_code</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">200</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Error submitting batch: "</span>, <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span>, <span class="st">"text"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span>, <span class="st">"parsed"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Batch submitted successfully!\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Batch ID:"</span>, <span class="va">result</span><span class="op">$</span><span class="va">id</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">essay_batch_info</span> <span class="op">&lt;-</span> <span class="fu">submit_batch</span><span class="op">(</span><span class="va">essay_batch_jsonl</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Batch submitted successfully!</span></span>
<span><span class="co"># Batch ID: msgbatch_018m5hGS9Lm3Gi28UorfsVTS</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="checking-batch-status" class="level4" data-number="20.3.5.4"><h4 data-number="20.3.5.4" class="anchored" data-anchor-id="checking-batch-status">
<span class="header-section-number">20.3.5.4</span> Checking Batch Status</h4>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Step 4: Check batch status</span></span>
<span><span class="va">check_batch_status</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">batch_id</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span></span>
<span>    url <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://api.anthropic.com/v1/messages/batches/"</span>, <span class="va">batch_id</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://httr.r-lib.org/reference/add_headers.html">add_headers</a></span><span class="op">(</span></span>
<span>      <span class="st">"x-api-key"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"ANTHROPIC_API_KEY"</span><span class="op">)</span>,</span>
<span>      <span class="st">"anthropic-version"</span> <span class="op">=</span> <span class="st">"2023-06-01"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://httr.r-lib.org/reference/status_code.html">status_code</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">200</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Error checking batch status: "</span>, <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span>, <span class="st">"text"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span>, <span class="st">"parsed"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">essay_status</span> <span class="op">&lt;-</span> <span class="fu">check_batch_status</span><span class="op">(</span><span class="va">essay_batch_info</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co"># Finished!</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span></span>
<span><span class="va">batch_start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">ymd_hms</a></span><span class="op">(</span><span class="va">essay_status</span><span class="op">$</span><span class="va">created_at</span><span class="op">)</span></span>
<span><span class="va">batch_stop_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">ymd_hms</a></span><span class="op">(</span><span class="va">essay_status</span><span class="op">$</span><span class="va">ended_at</span><span class="op">)</span></span>
<span><span class="va">batch_run_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">batch_stop_time</span> <span class="op">-</span> <span class="va">batch_start_time</span><span class="op">)</span></span>
<span><span class="co"># Time difference of 1.644671 mins</span></span>
<span><span class="co"># Less than 2 minutes to score 200 essays!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="saving-batch-results" class="level4" data-number="20.3.5.5"><h4 data-number="20.3.5.5" class="anchored" data-anchor-id="saving-batch-results">
<span class="header-section-number">20.3.5.5</span> Saving Batch Results</h4>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_batch_results</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">batch_id</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span></span>
<span>    url <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://api.anthropic.com/v1/messages/batches/"</span>, <span class="va">batch_id</span>, <span class="st">"/results"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://httr.r-lib.org/reference/add_headers.html">add_headers</a></span><span class="op">(</span></span>
<span>      <span class="st">"x-api-key"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"ANTHROPIC_API_KEY"</span><span class="op">)</span>,</span>
<span>      <span class="st">"anthropic-version"</span> <span class="op">=</span> <span class="st">"2023-06-01"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://httr.r-lib.org/reference/status_code.html">status_code</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">200</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Error retrieving results: "</span>, <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span>, <span class="st">"text"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Parse JSONL results</span></span>
<span>  <span class="va">results_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span>, <span class="st">"text"</span>, encoding <span class="op">=</span> <span class="st">"UTF-8"</span><span class="op">)</span></span>
<span>  <span class="va">results_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">results_text</span>, <span class="st">"\n"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">results_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">results_lines</span><span class="op">[</span><span class="va">results_lines</span> <span class="op">!=</span> <span class="st">""</span><span class="op">]</span>, <span class="va">fromJSON</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results_list</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">essay_batch_results</span> <span class="op">&lt;-</span> <span class="fu">get_batch_results</span><span class="op">(</span><span class="va">essay_batch_info</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">essay_batch_results</span>, file <span class="op">=</span> <span class="st">"data/essay_batch_results.Rdata"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="extracting-score-from-results" class="level4" data-number="20.3.5.6"><h4 data-number="20.3.5.6" class="anchored" data-anchor-id="extracting-score-from-results">
<span class="header-section-number">20.3.5.6</span> Extracting Score from Results</h4>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Step 6: Extract scores from batch results</span></span>
<span><span class="va">extract_batch_scores</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">results_list</span>, <span class="va">debug</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">scores_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    essay_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    repetition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    content <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    organization <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    language <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">results_list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="va">results_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">type</span> <span class="op">==</span> <span class="st">"succeeded"</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co"># Extract the response text - handle different possible structures</span></span>
<span>      <span class="va">message_content</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">message</span><span class="op">$</span><span class="va">content</span></span>
<span>      </span>
<span>      <span class="co"># Debug: Print structure if requested</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="va">debug</span> <span class="op">&amp;&amp;</span> <span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== DEBUG: First result structure ===\n"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Content class:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Content length:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"First element class:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Extract text from various possible structures</span></span>
<span>      <span class="va">response_text</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>      </span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">is.data.frame</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="co"># If it's a data frame, look for a 'text' column</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="st">"text"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="va">response_text</span> <span class="op">&lt;-</span> <span class="va">message_content</span><span class="op">$</span><span class="va">text</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">first_elem</span> <span class="op">&lt;-</span> <span class="va">message_content</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>        </span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">first_elem</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="co"># Check for $text field</span></span>
<span>          <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">first_elem</span><span class="op">$</span><span class="va">text</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>            <span class="va">response_text</span> <span class="op">&lt;-</span> <span class="va">first_elem</span><span class="op">$</span><span class="va">text</span></span>
<span>          <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">first_elem</span><span class="op">$</span><span class="va">type</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">first_elem</span><span class="op">$</span><span class="va">type</span> <span class="op">==</span> <span class="st">"text"</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">first_elem</span><span class="op">$</span><span class="va">text</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>            <span class="va">response_text</span> <span class="op">&lt;-</span> <span class="va">first_elem</span><span class="op">$</span><span class="va">text</span></span>
<span>          <span class="op">}</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span><span class="op">(</span><span class="va">first_elem</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="va">response_text</span> <span class="op">&lt;-</span> <span class="va">first_elem</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">response_text</span> <span class="op">&lt;-</span> <span class="va">message_content</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># If we still don't have text, try to extract it more aggressively</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">response_text</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">response_text</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="co"># Try to find any 'text' field in the structure</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="va">text_fields</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">message_content</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="st">"text"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">text</span> <span class="kw">else</span> <span class="cn">NULL</span></span>
<span>          <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">text_fields</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="va">response_text</span> <span class="op">&lt;-</span> <span class="va">text_fields</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">response_text</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">response_text</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"Could not extract text for "</span>, <span class="va">result</span><span class="op">$</span><span class="va">custom_id</span><span class="op">)</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="va">debug</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== Full structure for "</span>, <span class="va">result</span><span class="op">$</span><span class="va">custom_id</span>, <span class="st">" ===\n"</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>        <span class="kw">next</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Debug: Print first response text</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="va">debug</span> <span class="op">&amp;&amp;</span> <span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n=== First response text (first 500 chars) ===\n"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">response_text</span>, <span class="fl">1</span>, <span class="fl">500</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Extract scores using our previous function</span></span>
<span>      <span class="va">scores</span> <span class="op">&lt;-</span> <span class="fu">extract_scores</span><span class="op">(</span><span class="va">response_text</span>, debug <span class="op">=</span> <span class="va">debug</span> <span class="op">&amp;&amp;</span> <span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Debug: Check if scores were extracted</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="va">debug</span> <span class="op">&amp;&amp;</span> <span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== Extracted scores ===\n"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Parse custom_id to extract essay_id and repetition</span></span>
<span>      <span class="co"># Format: essay_2001_rep_1</span></span>
<span>      <span class="va">custom_id_parts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">custom_id</span>, <span class="st">"_"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="va">essay_id</span> <span class="op">&lt;-</span> <span class="va">custom_id_parts</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>      <span class="va">repetition</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">custom_id_parts</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">scores_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">scores_df</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>        essay_id <span class="op">=</span> <span class="va">essay_id</span>,</span>
<span>        repetition <span class="op">=</span> <span class="va">repetition</span>,</span>
<span>        content <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"content"</span><span class="op">]</span>,</span>
<span>        organization <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"organization"</span><span class="op">]</span>,</span>
<span>        language <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"language"</span><span class="op">]</span>,</span>
<span>        total <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"total"</span><span class="op">]</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"Request "</span>, <span class="va">result</span><span class="op">$</span><span class="va">custom_id</span>, <span class="st">" failed: "</span>, <span class="va">result</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">error</span><span class="op">$</span><span class="va">message</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">scores_df</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">essay_batch_df</span> <span class="op">&lt;-</span> <span class="fu">extract_batch_scores</span><span class="op">(</span><span class="va">essay_batch_results</span>, debug <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">essay_batch_df</span>, file <span class="op">=</span> <span class="st">'data/essay_batch_df.Rdata'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/DT">DT</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">'data/essay_batch_df.Rdata'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">essay_summary_detailed</span> <span class="op">&lt;-</span> <span class="va">essay_batch_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">essay_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="co"># Content</span></span>
<span>    content_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    content_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    content_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    content_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co"># Organization</span></span>
<span>    org_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    org_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    org_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    org_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co"># Language</span></span>
<span>    lang_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    lang_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    lang_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    lang_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co"># Total</span></span>
<span>    total_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">total_mean</span><span class="op">)</span></span>
<span></span>
<span><span class="va">essay_summary_detailed</span> <span class="op">&lt;-</span> <span class="va">essay_summary_detailed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">essay_summary_detailed</span>, </span>
<span>          options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pageLength <span class="op">=</span> <span class="fl">10</span>, scrollX <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>          caption <span class="op">=</span> <span class="st">"Summary Statistics by Essay (20 repetitions each)"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-2b6a1983e7475e76f2ae" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-2b6a1983e7475e76f2ae">{"x":{"filter":"none","vertical":false,"caption":"<caption>Summary Statistics by Essay (20 repetitions each)<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10"],["2003","2009","2001","2007","2005","2002","2004","2008","2006","2010"],[20,20,20,20,20,20,20,20,20,20],[2.5,2.5,2.5,2.62,2.62,2.95,3.5,4,4,4.5],[0,0,0,0.22,0.22,0.15,0,0,0,0],[2.5,2.5,2.5,2.5,2.5,2.5,3.5,4,4,4.5],[2.5,2.5,2.5,3,3,3,3.5,4,4,4.5],[2,2,2,2.02,2,2.83,4,3.92,3.92,4.08],[0,0,0,0.11,0,0.29,0,0.18,0.18,0.18],[2,2,2,2,2,2.5,4,3.5,3.5,4],[2,2,2,2.5,2,3.5,4,4,4,4.5],[1.5,1.5,1.6,1.57,1.88,3.6,4,4.38,4.4,4.78],[0,0,0.21,0.18,0.22,0.21,0,0.22,0.21,0.26],[1.5,1.5,1.5,1.5,1.5,3.5,4,4,4,4.5],[1.5,1.5,2,2,2,4,4,4.5,4.5,5],[6,6,6.1,6.22,6.5,9.380000000000001,11.5,12.3,12.32,13.35],[0,0,0.21,0.44,0.36,0.46,0,0.38,0.37,0.37],[6,6,6,6,6,9,11.5,11.5,11.5,13],[6,6,6.5,7.5,7,10.5,11.5,12.5,12.5,14]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>essay_id<\/th>\n      <th>n<\/th>\n      <th>content_mean<\/th>\n      <th>content_sd<\/th>\n      <th>content_min<\/th>\n      <th>content_max<\/th>\n      <th>org_mean<\/th>\n      <th>org_sd<\/th>\n      <th>org_min<\/th>\n      <th>org_max<\/th>\n      <th>lang_mean<\/th>\n      <th>lang_sd<\/th>\n      <th>lang_min<\/th>\n      <th>lang_max<\/th>\n      <th>total_mean<\/th>\n      <th>total_sd<\/th>\n      <th>total_min<\/th>\n      <th>total_max<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"essay_id","targets":1},{"name":"n","targets":2},{"name":"content_mean","targets":3},{"name":"content_sd","targets":4},{"name":"content_min","targets":5},{"name":"content_max","targets":6},{"name":"org_mean","targets":7},{"name":"org_sd","targets":8},{"name":"org_min","targets":9},{"name":"org_max","targets":10},{"name":"lang_mean","targets":11},{"name":"lang_sd","targets":12},{"name":"lang_min","targets":13},{"name":"lang_max","targets":14},{"name":"total_mean","targets":15},{"name":"total_sd","targets":16},{"name":"total_min","targets":17},{"name":"total_max","targets":18}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>So we did see some variation, but I also used the default temperature.</p>
</section></section><section id="batch-scoring-temp-0" class="level3" data-number="20.3.6"><h3 data-number="20.3.6" class="anchored" data-anchor-id="batch-scoring-temp-0">
<span class="header-section-number">20.3.6</span> Batch Scoring (<code>Temp = 0</code>)</h3>
<p>Let’s redo the batch call with <code>temperature = 0</code>.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">create_lowtemp_requests</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">essays_df</span>, <span class="va">n_repetitions</span> <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Create a list to store batch requests</span></span>
<span>  <span class="va">batch_requests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">request_counter</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="co"># Create n_repetitions requests for each essay (grouped by essay)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">essays_df</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">essay_prompt</span> <span class="op">&lt;-</span> <span class="fu">claude_all_rubric_prompt</span><span class="op">(</span><span class="va">essays_df</span><span class="op">$</span><span class="va">prompt</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">essays_df</span><span class="op">$</span><span class="va">essay</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Create 20 requests for this essay</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">rep</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_repetitions</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        custom_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"essay_"</span>, <span class="va">essays_df</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"_rep_"</span>, <span class="va">rep</span><span class="op">)</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>          model <span class="op">=</span> <span class="st">"claude-sonnet-4-20250514"</span>,</span>
<span>          max_tokens <span class="op">=</span> <span class="fl">1024</span>,</span>
<span>          temperature <span class="op">=</span> <span class="fl">0</span>, <span class="co"># added low temp</span></span>
<span>          messages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>              role <span class="op">=</span> <span class="st">"user"</span>,</span>
<span>              content <span class="op">=</span> <span class="va">essay_prompt</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">batch_requests</span><span class="op">[[</span><span class="va">request_counter</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">request</span></span>
<span>      <span class="va">request_counter</span> <span class="op">&lt;-</span> <span class="va">request_counter</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Created"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">batch_requests</span><span class="op">)</span>, <span class="st">"batch requests for"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">essays_df</span><span class="op">)</span>, <span class="st">"essays\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">batch_requests</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">lowtemp_batch_requests</span> <span class="op">&lt;-</span> <span class="fu">create_lowtemp_requests</span><span class="op">(</span><span class="va">student_essays</span><span class="op">)</span></span>
<span><span class="va">lowtemp_batch_jsonl</span> <span class="op">&lt;-</span> <span class="fu">write_batch_file</span><span class="op">(</span><span class="va">lowtemp_batch_requests</span><span class="op">)</span></span>
<span><span class="va">lowtemp_batch_info</span> <span class="op">&lt;-</span> <span class="fu">submit_batch</span><span class="op">(</span><span class="va">lowtemp_batch_jsonl</span><span class="op">)</span></span>
<span><span class="co"># Batch submitted successfully!</span></span>
<span><span class="co"># Batch ID: msgbatch_0184nJ7Kui9v6WVVh47939mn </span></span>
<span></span>
<span><span class="va">lowtemp_status</span> <span class="op">&lt;-</span> <span class="fu">check_batch_status</span><span class="op">(</span><span class="va">lowtemp_batch_info</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="va">lowtemp_start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">ymd_hms</a></span><span class="op">(</span><span class="va">lowtemp_status</span><span class="op">$</span><span class="va">created_at</span><span class="op">)</span></span>
<span><span class="va">lowtemp_stop_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">ymd_hms</a></span><span class="op">(</span><span class="va">lowtemp_status</span><span class="op">$</span><span class="va">ended_at</span><span class="op">)</span></span>
<span><span class="va">lowtemp_run_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">lowtemp_stop_time</span> <span class="op">-</span> <span class="va">lowtemp_start_time</span><span class="op">)</span></span>
<span><span class="co"># Time difference of 1.473892 mins</span></span>
<span></span>
<span><span class="va">lowtemp_batch_results</span> <span class="op">&lt;-</span> <span class="fu">get_batch_results</span><span class="op">(</span><span class="va">lowtemp_batch_info</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">lowtemp_batch_results</span>, file <span class="op">=</span> <span class="st">"data/lowtemp_batch_results.Rdata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lowtemp_batch_df</span> <span class="op">&lt;-</span> <span class="fu">extract_batch_scores</span><span class="op">(</span><span class="va">lowtemp_batch_results</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">lowtemp_batch_df</span>, file <span class="op">=</span> <span class="st">'data/lowtemp_batch_df.Rdata'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">'data/lowtemp_batch_df.Rdata'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lowtemp_summary_detailed</span> <span class="op">&lt;-</span> <span class="va">lowtemp_batch_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">essay_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="co"># Content</span></span>
<span>    content_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    content_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    content_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    content_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co"># Organization</span></span>
<span>    org_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    org_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    org_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    org_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co"># Language</span></span>
<span>    lang_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    lang_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    lang_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    lang_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co"># Total</span></span>
<span>    total_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">total_mean</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lowtemp_summary_detailed</span> <span class="op">&lt;-</span> <span class="va">lowtemp_summary_detailed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">lowtemp_summary_detailed</span>, </span>
<span>          options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pageLength <span class="op">=</span> <span class="fl">10</span>, scrollX <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>          caption <span class="op">=</span> <span class="st">"Summary Statistics by Essay (20 repetitions each) - Temperature = 0"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-17a7d6874f8bead0fc1a" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-17a7d6874f8bead0fc1a">{"x":{"filter":"none","vertical":false,"caption":"<caption>Summary Statistics by Essay (20 repetitions each) - Temperature = 0<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10"],["2001","2003","2005","2007","2009","2002","2004","2006","2008","2010"],[20,20,20,20,20,20,20,20,20,20],[2.5,2.5,2.5,2.5,2.5,3,3.5,4,4,4.5],[0,0,0,0,0,0,0,0,0,0],[2.5,2.5,2.5,2.5,2.5,3,3.5,4,4,4.5],[2.5,2.5,2.5,2.5,2.5,3,3.5,4,4,4.5],[2,2,2,2,2,3,4,4,4,4],[0,0,0,0,0,0,0,0,0,0],[2,2,2,2,2,3,4,4,4,4],[2,2,2,2,2,3,4,4,4,4],[1.5,1.5,1.5,1.5,1.5,3.5,4,4.5,4.5,5],[0,0,0,0,0,0,0,0,0,0],[1.5,1.5,1.5,1.5,1.5,3.5,4,4.5,4.5,5],[1.5,1.5,1.5,1.5,1.5,3.5,4,4.5,4.5,5],[6,6,6,6,6,9.5,11.5,12.5,12.5,13.5],[0,0,0,0,0,0,0,0,0,0],[6,6,6,6,6,9.5,11.5,12.5,12.5,13.5],[6,6,6,6,6,9.5,11.5,12.5,12.5,13.5]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>essay_id<\/th>\n      <th>n<\/th>\n      <th>content_mean<\/th>\n      <th>content_sd<\/th>\n      <th>content_min<\/th>\n      <th>content_max<\/th>\n      <th>org_mean<\/th>\n      <th>org_sd<\/th>\n      <th>org_min<\/th>\n      <th>org_max<\/th>\n      <th>lang_mean<\/th>\n      <th>lang_sd<\/th>\n      <th>lang_min<\/th>\n      <th>lang_max<\/th>\n      <th>total_mean<\/th>\n      <th>total_sd<\/th>\n      <th>total_min<\/th>\n      <th>total_max<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"essay_id","targets":1},{"name":"n","targets":2},{"name":"content_mean","targets":3},{"name":"content_sd","targets":4},{"name":"content_min","targets":5},{"name":"content_max","targets":6},{"name":"org_mean","targets":7},{"name":"org_sd","targets":8},{"name":"org_min","targets":9},{"name":"org_max","targets":10},{"name":"lang_mean","targets":11},{"name":"lang_sd","targets":12},{"name":"lang_min","targets":13},{"name":"lang_max","targets":14},{"name":"total_mean","targets":15},{"name":"total_sd","targets":16},{"name":"total_min","targets":17},{"name":"total_max","targets":18}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Now we’re seeing more consistent scores, and it took <em>less than 90 seconds</em> to process all 200 requests.</p>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./19-rubric-scoring.html" class="pagination-link" aria-label="Scoring with Rubrics">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Scoring with Rubrics</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./21-chained-workflows.html" class="pagination-link" aria-label="Chained Workflows">
        <span class="nav-page-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Chained Workflows</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb29" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Activity: Scoring with Rubrics {#sec-act-rubric-task}</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task: **Med Ed:** Using LLMs to Apply Analytic Rubrics</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'downloads/claude_plus.R'</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>osce_note <span class="ot">&lt;-</span> <span class="st">"45-year-old male presents with Chest pain. Reports pressure-like chest discomfort that started this morning while walking up stairs. Some SOB. Recalls previous less severe episodes. H/O high blood pressure (takes atorvastatin). Current vitals positive for hypertension and tachycardia; other vitals unremarkable. Symptoms suggest possible angina; anxiety or GERD could also be considered."</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>analytic_rubric <span class="ot">&lt;-</span> <span class="st">"For each of the following criteria, determine whether the element is Included or Not Included in the response.</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="st">1. Chief concern of chest pain</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="st">2. Episodic pattern of symptoms</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="st">3. Poorly controlled history of hypertension</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="st">4. Vitals indicate hypertension</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="st">5. Pain radiates to the back</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="st">6. Likely diagnosis of acute coronary syndrome (ACS), NSTEMI, or STEMI"</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>osce_analytic <span class="ot">&lt;-</span> <span class="cf">function</span>(student_note, rubric){</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="st">  Using the rubric provided below, score the following OSCE post-encounter note. </span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="st">  For each criterion, indicate whether it was met and provide brief justification for your scoring decision. </span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="st">  Here is the student note:{student_note}</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="st">  Here is the rubric:{rubric}</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="st">  Return a completed rubric, indicating which criteria are met or not met and justifications for each component.</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="st">  "</span>)</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>analytic_prompt <span class="ot">&lt;-</span> <span class="fu">osce_analytic</span>(osce_note, analytic_rubric)</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>analytic_response <span class="ot">&lt;-</span> <span class="fu">claude_plus</span>(analytic_prompt,</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">temperature =</span> <span class="dv">0</span>)</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE, echo = FALSE}</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(analytic_response, <span class="at">file =</span> <span class="st">"data/analytic_response.Rdata"</span>)</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a><span class="fu">## View model application of Med Ed _Analytic_ Rubric</span></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo = FALSE}</span></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/analytic_response.Rdata"</span>)</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Some cleaning for the quarto output; not strictly necessary</span></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>analytic_response <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(analytic_response, <span class="st">"#"</span>, <span class="st">"*"</span>)</span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>analytic_response <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(analytic_response, </span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"(?m)^(</span><span class="sc">\\</span><span class="st">*+)</span><span class="sc">\\</span><span class="st">s+"</span>, </span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>)</span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>analytic_response <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(analytic_response, </span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"(?m)^(</span><span class="sc">\\</span><span class="st">*+)(.*?)(?&lt;!</span><span class="sc">\\</span><span class="st">*)(</span><span class="sc">\\</span><span class="st">n)"</span>, </span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"</span><span class="sc">\\</span><span class="st">1</span><span class="sc">\\</span><span class="st">2</span><span class="sc">\\</span><span class="st">1</span><span class="sc">\\</span><span class="st">3"</span>)</span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>analytic_response <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(analytic_response,</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*(</span><span class="sc">\\</span><span class="st">n)</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*"</span>,</span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"**</span><span class="sc">\\</span><span class="st">1</span><span class="sc">\\</span><span class="st">1**"</span>)</span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">asis_output</span>(analytic_response)</span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a>What do you think about the model’s application of the analytic rubric? </span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>How might you have scored the note differently? </span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>Are there any places where the AI’s application of the rubric was too strict or too lenient? </span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>Did the AI appropriately recognize when the student phrased elements of the rubric in different words (lexical variants)?</span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a>This activity also highlights another important possible use case using AI: seeing how a rubric might be interpreted and identifying places on the rubric for improvement / increased specificity. </span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task: Med Ed: Using LLMs to Apply Holistic Rubrics</span></span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'downloads/claude_plus.R'</span>)</span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a>holistic_rubric <span class="ot">&lt;-</span> <span class="st">"Each criterion should be rated as Insufficient (0 points), Developing (1 point), or Proficient (2 points) based on the quality of the response.</span></span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a><span class="st">Chief complaint is clearly documented</span></span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a><span class="st">- Insufficient: Missing or unclear</span></span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a><span class="st">- Developing: Present but vague</span></span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a><span class="st">- Proficient: Clear and specific</span></span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a><span class="st">Relevant history is included</span></span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a><span class="st">- Insufficient: Minimal or missing key details</span></span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a><span class="st">- Developing: Some relevant information</span></span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a><span class="st">- Proficient: Comprehensive and pertinent</span></span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a><span class="st">Physical exam findings are documented</span></span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a><span class="st">- Insufficient: Absent or incomplete</span></span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a><span class="st">- Developing: Basic findings noted</span></span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a><span class="st">- Proficient: Thorough and organized</span></span>
<span id="cb29-104"><a href="#cb29-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-105"><a href="#cb29-105" aria-hidden="true" tabindex="-1"></a><span class="st">Assessment includes appropriate differential diagnoses</span></span>
<span id="cb29-106"><a href="#cb29-106" aria-hidden="true" tabindex="-1"></a><span class="st">- Insufficient: Missing or inappropriate</span></span>
<span id="cb29-107"><a href="#cb29-107" aria-hidden="true" tabindex="-1"></a><span class="st">- Developing: Limited differential</span></span>
<span id="cb29-108"><a href="#cb29-108" aria-hidden="true" tabindex="-1"></a><span class="st">- Proficient: Well-developed differential</span></span>
<span id="cb29-109"><a href="#cb29-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-110"><a href="#cb29-110" aria-hidden="true" tabindex="-1"></a><span class="st">Plan is reasonable and addresses the patient’s concerns</span></span>
<span id="cb29-111"><a href="#cb29-111" aria-hidden="true" tabindex="-1"></a><span class="st">- Insufficient: Inadequate or missing</span></span>
<span id="cb29-112"><a href="#cb29-112" aria-hidden="true" tabindex="-1"></a><span class="st">- Developing: Partially addresses concerns</span></span>
<span id="cb29-113"><a href="#cb29-113" aria-hidden="true" tabindex="-1"></a><span class="st">- Proficient: Complete and appropriate</span></span>
<span id="cb29-114"><a href="#cb29-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-115"><a href="#cb29-115" aria-hidden="true" tabindex="-1"></a><span class="st">Documentation is organized</span></span>
<span id="cb29-116"><a href="#cb29-116" aria-hidden="true" tabindex="-1"></a><span class="st">- Insufficient: Disorganized or difficult to follow</span></span>
<span id="cb29-117"><a href="#cb29-117" aria-hidden="true" tabindex="-1"></a><span class="st">- Developing: Somewhat structured</span></span>
<span id="cb29-118"><a href="#cb29-118" aria-hidden="true" tabindex="-1"></a><span class="st">- Proficient: Logical and clear structure"</span></span>
<span id="cb29-119"><a href="#cb29-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-120"><a href="#cb29-120" aria-hidden="true" tabindex="-1"></a>osce_holistic <span class="ot">&lt;-</span> <span class="cf">function</span>(student_note, rubric){</span>
<span id="cb29-121"><a href="#cb29-121" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb29-122"><a href="#cb29-122" aria-hidden="true" tabindex="-1"></a><span class="st">  Using the rubric provided below, score the following OSCE post-encounter note. </span></span>
<span id="cb29-123"><a href="#cb29-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-124"><a href="#cb29-124" aria-hidden="true" tabindex="-1"></a><span class="st">  Here is the student note: {student_note}</span></span>
<span id="cb29-125"><a href="#cb29-125" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb29-126"><a href="#cb29-126" aria-hidden="true" tabindex="-1"></a><span class="st">  Here is the rubric: {rubric}</span></span>
<span id="cb29-127"><a href="#cb29-127" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb29-128"><a href="#cb29-128" aria-hidden="true" tabindex="-1"></a><span class="st">  Return a completed rubric, indicating justifications for each component.</span></span>
<span id="cb29-129"><a href="#cb29-129" aria-hidden="true" tabindex="-1"></a><span class="st">  "</span>)</span>
<span id="cb29-130"><a href="#cb29-130" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-131"><a href="#cb29-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-132"><a href="#cb29-132" aria-hidden="true" tabindex="-1"></a>holistic_prompt <span class="ot">&lt;-</span> <span class="fu">osce_holistic</span>(osce_note, holistic_rubric)</span>
<span id="cb29-133"><a href="#cb29-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-134"><a href="#cb29-134" aria-hidden="true" tabindex="-1"></a>holistic_response <span class="ot">&lt;-</span> <span class="fu">claude_plus</span>(holistic_prompt,</span>
<span id="cb29-135"><a href="#cb29-135" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">temperature =</span> <span class="dv">0</span>)</span>
<span id="cb29-136"><a href="#cb29-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-137"><a href="#cb29-137" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-138"><a href="#cb29-138" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE, echo=FALSE}</span></span>
<span id="cb29-139"><a href="#cb29-139" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(holistic_response, <span class="at">file =</span> <span class="st">"data/holistic_response.Rdata"</span>)</span>
<span id="cb29-140"><a href="#cb29-140" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-141"><a href="#cb29-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-142"><a href="#cb29-142" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb29-143"><a href="#cb29-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-144"><a href="#cb29-144" aria-hidden="true" tabindex="-1"></a><span class="fu">## View model application of Med Ed _Holistic_ Rubric</span></span>
<span id="cb29-145"><a href="#cb29-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-146"><a href="#cb29-146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo = FALSE}</span></span>
<span id="cb29-147"><a href="#cb29-147" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/holistic_response.Rdata"</span>)</span>
<span id="cb29-148"><a href="#cb29-148" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-151"><a href="#cb29-151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-152"><a href="#cb29-152" aria-hidden="true" tabindex="-1"></a><span class="co"># Some cleaning for the quarto output; not strictly necessary</span></span>
<span id="cb29-153"><a href="#cb29-153" aria-hidden="true" tabindex="-1"></a>holistic_response <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(holistic_response, <span class="st">"#"</span>, <span class="st">"*"</span>)</span>
<span id="cb29-154"><a href="#cb29-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-155"><a href="#cb29-155" aria-hidden="true" tabindex="-1"></a>holistic_response <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(holistic_response, </span>
<span id="cb29-156"><a href="#cb29-156" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"(?m)^(</span><span class="sc">\\</span><span class="st">*+)</span><span class="sc">\\</span><span class="st">s+"</span>, </span>
<span id="cb29-157"><a href="#cb29-157" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>)</span>
<span id="cb29-158"><a href="#cb29-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-159"><a href="#cb29-159" aria-hidden="true" tabindex="-1"></a>holistic_response <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(holistic_response, </span>
<span id="cb29-160"><a href="#cb29-160" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"(?m)^(</span><span class="sc">\\</span><span class="st">*+)(.*?)(?&lt;!</span><span class="sc">\\</span><span class="st">*)(</span><span class="sc">\\</span><span class="st">n)"</span>, </span>
<span id="cb29-161"><a href="#cb29-161" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"</span><span class="sc">\\</span><span class="st">1</span><span class="sc">\\</span><span class="st">2</span><span class="sc">\\</span><span class="st">1</span><span class="sc">\\</span><span class="st">3"</span>)</span>
<span id="cb29-162"><a href="#cb29-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-163"><a href="#cb29-163" aria-hidden="true" tabindex="-1"></a>holistic_response <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(holistic_response,</span>
<span id="cb29-164"><a href="#cb29-164" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*(</span><span class="sc">\\</span><span class="st">n)</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*"</span>,</span>
<span id="cb29-165"><a href="#cb29-165" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"**</span><span class="sc">\\</span><span class="st">1</span><span class="sc">\\</span><span class="st">1**"</span>)</span>
<span id="cb29-166"><a href="#cb29-166" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">asis_output</span>(holistic_response)</span>
<span id="cb29-167"><a href="#cb29-167" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-168"><a href="#cb29-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-169"><a href="#cb29-169" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb29-170"><a href="#cb29-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-171"><a href="#cb29-171" aria-hidden="true" tabindex="-1"></a>What do you think about the model’s application of the holistic rubric? </span>
<span id="cb29-172"><a href="#cb29-172" aria-hidden="true" tabindex="-1"></a>How might you have scored the note differently? </span>
<span id="cb29-173"><a href="#cb29-173" aria-hidden="true" tabindex="-1"></a>What did the model do well (either in scoring or its justification), and where do you think it could have improved?</span>
<span id="cb29-174"><a href="#cb29-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-175"><a href="#cb29-175" aria-hidden="true" tabindex="-1"></a>As you can see, applying a holistic rubric is generally more difficult for an AI model because it lacks the context of the clinical encounter. </span>
<span id="cb29-176"><a href="#cb29-176" aria-hidden="true" tabindex="-1"></a>Some methods to improve the model performance in these instances would be to submit each rubric element individually and provide examples of each scoring level, and then empirically verify that the model is applying the rubric as intended. </span>
<span id="cb29-177"><a href="#cb29-177" aria-hidden="true" tabindex="-1"></a>In general, using generative AI to apply holistic rubrics may take more work than having the model apply an analytic rubric. </span>
<span id="cb29-178"><a href="#cb29-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-179"><a href="#cb29-179" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task: Using LLMs to Apply Holistic Rubrics</span></span>
<span id="cb29-180"><a href="#cb29-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-181"><a href="#cb29-181" aria-hidden="true" tabindex="-1"></a>Many attending AIME-CON are working in non-medical educational settings, so I wanted to develop a different example that may be more applicable to the work that you're doing.</span>
<span id="cb29-182"><a href="#cb29-182" aria-hidden="true" tabindex="-1"></a>For this example I'm going to use the rubric that was part of the <span class="co">[</span><span class="ot">`Dataset for Rubric-based Essay Scoring (DREsS)`</span><span class="co">](https://haneul-yoo.github.io/dress/)</span>.</span>
<span id="cb29-183"><a href="#cb29-183" aria-hidden="true" tabindex="-1"></a>This rubric was based on scoring essays from English as a foreign language (EFL) learners.</span>
<span id="cb29-184"><a href="#cb29-184" aria-hidden="true" tabindex="-1"></a>The essays in that dataset are scored on a range from 1 to 5 with increments of 0.5.</span>
<span id="cb29-185"><a href="#cb29-185" aria-hidden="true" tabindex="-1"></a>The full dataset is available after filling out a <span class="co">[</span><span class="ot">consent form</span><span class="co">](https://docs.google.com/forms/d/e/1FAIpQLSdqlywEiCl5Ddei7T7ujMBpMHFDLRyW7OBo033e_Oe-amGqmQ/viewform)</span>.</span>
<span id="cb29-186"><a href="#cb29-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-187"><a href="#cb29-187" aria-hidden="true" tabindex="-1"></a>The rubric has 3 components:</span>
<span id="cb29-188"><a href="#cb29-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-189"><a href="#cb29-189" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Criteria** | **Description**                                                                                                                                                                                                                                         <span class="pp">|</span></span>
<span id="cb29-190"><a href="#cb29-190" aria-hidden="true" tabindex="-1"></a><span class="pp">|--------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|</span></span>
<span id="cb29-191"><a href="#cb29-191" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Content      <span class="pp">|</span> Paragraph is well-developed and relevant to the argument, supported with strong reasons and examples.                                                                                                                                                   <span class="pp">|</span></span>
<span id="cb29-192"><a href="#cb29-192" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Organization <span class="pp">|</span> The argument is very effectively structured and developed, making it easy for the reader to follow the ideas and understand how the writer is building the argument. Paragraphs use coherence devices effectively while focusing on a single main idea. <span class="pp">|</span></span>
<span id="cb29-193"><a href="#cb29-193" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Language     <span class="pp">|</span> The writing displays sophisticated control of a wide range of vocabulary and collocations. The essay follows grammar and usage rules throughout the paper. Spelling and punctuation are correct throughout the paper.                                   <span class="pp">|</span></span>
<span id="cb29-194"><a href="#cb29-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-195"><a href="#cb29-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-196"><a href="#cb29-196" aria-hidden="true" tabindex="-1"></a>One of the prompts in the data is: "Do you think that smartphones have destroyed communication among family and friends? Give specific reasons and details to support your opinion."</span>
<span id="cb29-197"><a href="#cb29-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-198"><a href="#cb29-198" aria-hidden="true" tabindex="-1"></a>To ensure that I'm compliant with the consent form agreement, I will be using synthetic responses generated (using Claude Sonnet 4.5) based observed student responses. We'll also be using the <span class="co">[</span><span class="ot">`claude_plus` function we used in the parameter testing activity</span><span class="co">](@sec-claude-plus)</span>.</span>
<span id="cb29-199"><a href="#cb29-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-200"><a href="#cb29-200" aria-hidden="true" tabindex="-1"></a><span class="fu">### First Model Call </span></span>
<span id="cb29-201"><a href="#cb29-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-202"><a href="#cb29-202" aria-hidden="true" tabindex="-1"></a>Let's start by asking the model to apply the rubric to an essay. We'll use the default parameters for this first</span>
<span id="cb29-203"><a href="#cb29-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-204"><a href="#cb29-204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb29-205"><a href="#cb29-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-206"><a href="#cb29-206" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'downloads/claude_plus.R'</span>)</span>
<span id="cb29-207"><a href="#cb29-207" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">'data/student_essays.Rdata'</span>)</span>
<span id="cb29-208"><a href="#cb29-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-209"><a href="#cb29-209" aria-hidden="true" tabindex="-1"></a>focal_student <span class="ot">&lt;-</span> <span class="fu">subset</span>(student_essays, id <span class="sc">==</span> <span class="dv">2002</span>)</span>
<span id="cb29-210"><a href="#cb29-210" aria-hidden="true" tabindex="-1"></a>focal_prompt <span class="ot">&lt;-</span> focal_student<span class="sc">$</span>prompt</span>
<span id="cb29-211"><a href="#cb29-211" aria-hidden="true" tabindex="-1"></a>focal_essay <span class="ot">&lt;-</span> focal_student<span class="sc">$</span>essay</span>
<span id="cb29-212"><a href="#cb29-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-213"><a href="#cb29-213" aria-hidden="true" tabindex="-1"></a><span class="co"># Building a function to generate the prompt.</span></span>
<span id="cb29-214"><a href="#cb29-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-215"><a href="#cb29-215" aria-hidden="true" tabindex="-1"></a>all_rubric_prompt <span class="ot">&lt;-</span> <span class="cf">function</span>(prompt, essay){</span>
<span id="cb29-216"><a href="#cb29-216" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb29-217"><a href="#cb29-217" aria-hidden="true" tabindex="-1"></a><span class="st">You are an expert essay grader. Score the following student essay based on three criteria: Content, Organization, and Language. Each criterion should be scored from 1 to 5 in increments of 0.5 (e.g., 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5).</span></span>
<span id="cb29-218"><a href="#cb29-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-219"><a href="#cb29-219" aria-hidden="true" tabindex="-1"></a><span class="st">RUBRIC:</span></span>
<span id="cb29-220"><a href="#cb29-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-221"><a href="#cb29-221" aria-hidden="true" tabindex="-1"></a><span class="st">**Content (1-5):**</span></span>
<span id="cb29-222"><a href="#cb29-222" aria-hidden="true" tabindex="-1"></a><span class="st">Paragraph is well-developed and relevant to the argument, supported with strong reasons and examples.</span></span>
<span id="cb29-223"><a href="#cb29-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-224"><a href="#cb29-224" aria-hidden="true" tabindex="-1"></a><span class="st">**Organization (1-5):**</span></span>
<span id="cb29-225"><a href="#cb29-225" aria-hidden="true" tabindex="-1"></a><span class="st">The argument is very effectively structured and developed, making it easy for the reader to follow the ideas and understand how the writer is building the argument. Paragraphs use coherence devices effectively while focusing on a single main idea.</span></span>
<span id="cb29-226"><a href="#cb29-226" aria-hidden="true" tabindex="-1"></a><span class="st"> </span></span>
<span id="cb29-227"><a href="#cb29-227" aria-hidden="true" tabindex="-1"></a><span class="st">**Language (1-5):**</span></span>
<span id="cb29-228"><a href="#cb29-228" aria-hidden="true" tabindex="-1"></a><span class="st">The writing displays sophisticated control of a wide range of vocabulary and collocations. The essay follows grammar and usage rules throughout the paper. Spelling and punctuation are correct throughout the paper.</span></span>
<span id="cb29-229"><a href="#cb29-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-230"><a href="#cb29-230" aria-hidden="true" tabindex="-1"></a><span class="st">PROMPT: {prompt}</span></span>
<span id="cb29-231"><a href="#cb29-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-232"><a href="#cb29-232" aria-hidden="true" tabindex="-1"></a><span class="st">ESSAY: {essay}</span></span>
<span id="cb29-233"><a href="#cb29-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-234"><a href="#cb29-234" aria-hidden="true" tabindex="-1"></a><span class="st">Please provide scores for each criterion and calculate the total score. Format your response as follows:</span></span>
<span id="cb29-235"><a href="#cb29-235" aria-hidden="true" tabindex="-1"></a><span class="st">Content: [score]</span></span>
<span id="cb29-236"><a href="#cb29-236" aria-hidden="true" tabindex="-1"></a><span class="st">Organization: [score]</span></span>
<span id="cb29-237"><a href="#cb29-237" aria-hidden="true" tabindex="-1"></a><span class="st">Language: [score]</span></span>
<span id="cb29-238"><a href="#cb29-238" aria-hidden="true" tabindex="-1"></a><span class="st">Total: [sum of three scores]</span></span>
<span id="cb29-239"><a href="#cb29-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-240"><a href="#cb29-240" aria-hidden="true" tabindex="-1"></a><span class="st">Provide a brief justification (1-2 sentences) for each score.</span></span>
<span id="cb29-241"><a href="#cb29-241" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb29-242"><a href="#cb29-242" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-243"><a href="#cb29-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-244"><a href="#cb29-244" aria-hidden="true" tabindex="-1"></a>one_rep_essay <span class="ot">&lt;-</span> <span class="fu">claude_plus</span>(<span class="at">prompt =</span> <span class="fu">all_rubric_prompt</span>(focal_prompt, focal_essay))</span>
<span id="cb29-245"><a href="#cb29-245" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(one_rep_essay, <span class="at">file =</span> <span class="st">'data/one_rep_essay.Rdata'</span>)</span>
<span id="cb29-246"><a href="#cb29-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-247"><a href="#cb29-247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-248"><a href="#cb29-248" aria-hidden="true" tabindex="-1"></a>Claude's essay evaluation:</span>
<span id="cb29-249"><a href="#cb29-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-250"><a href="#cb29-250" aria-hidden="true" tabindex="-1"></a>Essay Evaluation</span>
<span id="cb29-251"><a href="#cb29-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-252"><a href="#cb29-252" aria-hidden="true" tabindex="-1"></a>**Content: 3/5**</span>
<span id="cb29-253"><a href="#cb29-253" aria-hidden="true" tabindex="-1"></a>The essay presents a balanced view with relevant examples (grandmother video calls, phone distraction), but the development is superficial. The argument lacks depth, multiple examples, and detailed elaboration that would make it well-developed and strongly supported.</span>
<span id="cb29-254"><a href="#cb29-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-255"><a href="#cb29-255" aria-hidden="true" tabindex="-1"></a>**Organization: 3.5/5**</span>
<span id="cb29-256"><a href="#cb29-256" aria-hidden="true" tabindex="-1"></a>The essay follows a clear structure (introducing both sides, personal example, counterpoint, conclusion) and is easy to follow. However, it's quite brief and would benefit from additional paragraphs to fully develop each main idea separately rather than condensing everything into one paragraph.</span>
<span id="cb29-257"><a href="#cb29-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-258"><a href="#cb29-258" aria-hidden="true" tabindex="-1"></a>**Language: 3.5/5**</span>
<span id="cb29-259"><a href="#cb29-259" aria-hidden="true" tabindex="-1"></a>The writing demonstrates good control of grammar and vocabulary with no significant errors (\"on one hand/on the other hand,\" \"responsibly\"). However, the vocabulary range is relatively basic and lacks the sophistication and variety expected for a top score.</span>
<span id="cb29-260"><a href="#cb29-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-261"><a href="#cb29-261" aria-hidden="true" tabindex="-1"></a>**Total: 10/15**</span>
<span id="cb29-262"><a href="#cb29-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-263"><a href="#cb29-263" aria-hidden="true" tabindex="-1"></a>As noted in the previously (in WHAT section), part of the beauty of generative AI model is the variability in output. Great for creative tasks, but not optimal for things like the present task of applying a scoring rubric to a student response.</span>
<span id="cb29-264"><a href="#cb29-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-265"><a href="#cb29-265" aria-hidden="true" tabindex="-1"></a><span class="fu">### Repeating Score Task </span></span>
<span id="cb29-266"><a href="#cb29-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-267"><a href="#cb29-267" aria-hidden="true" tabindex="-1"></a>Let's repeat the above process 20 times in a loop, extracting the scores after each model response.</span>
<span id="cb29-268"><a href="#cb29-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-269"><a href="#cb29-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb29-270"><a href="#cb29-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-271"><a href="#cb29-271" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to extract scores</span></span>
<span id="cb29-272"><a href="#cb29-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-273"><a href="#cb29-273" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb29-274"><a href="#cb29-274" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb29-275"><a href="#cb29-275" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb29-276"><a href="#cb29-276" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb29-277"><a href="#cb29-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-278"><a href="#cb29-278" aria-hidden="true" tabindex="-1"></a><span class="co"># Set your Anthropic API key</span></span>
<span id="cb29-279"><a href="#cb29-279" aria-hidden="true" tabindex="-1"></a>ANTHROPIC_API_KEY <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">"ANTHROPIC_API_KEY"</span>)</span>
<span id="cb29-280"><a href="#cb29-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-281"><a href="#cb29-281" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the prompt function (from previous artifact)</span></span>
<span id="cb29-282"><a href="#cb29-282" aria-hidden="true" tabindex="-1"></a>all_rubric_prompt <span class="ot">&lt;-</span> <span class="cf">function</span>(prompt, essay){</span>
<span id="cb29-283"><a href="#cb29-283" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb29-284"><a href="#cb29-284" aria-hidden="true" tabindex="-1"></a><span class="st">You are an expert essay grader. Score the following student essay based on three criteria: Content, Organization, and Language. Each criterion should be scored from 1 to 5 in increments of 0.5.</span></span>
<span id="cb29-285"><a href="#cb29-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-286"><a href="#cb29-286" aria-hidden="true" tabindex="-1"></a><span class="st">RUBRIC:</span></span>
<span id="cb29-287"><a href="#cb29-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-288"><a href="#cb29-288" aria-hidden="true" tabindex="-1"></a><span class="st">**Content (1-5):**</span></span>
<span id="cb29-289"><a href="#cb29-289" aria-hidden="true" tabindex="-1"></a><span class="st">- 5: Exceptionally well-developed and highly relevant, with strong reasons and compelling examples.</span></span>
<span id="cb29-290"><a href="#cb29-290" aria-hidden="true" tabindex="-1"></a><span class="st">- 4: Well-developed and relevant, with clear reasons and good examples.</span></span>
<span id="cb29-291"><a href="#cb29-291" aria-hidden="true" tabindex="-1"></a><span class="st">- 3: Adequately developed with acceptable reasons and examples.</span></span>
<span id="cb29-292"><a href="#cb29-292" aria-hidden="true" tabindex="-1"></a><span class="st">- 2: Underdeveloped with weak or insufficient reasons and examples.</span></span>
<span id="cb29-293"><a href="#cb29-293" aria-hidden="true" tabindex="-1"></a><span class="st">- 1: Poorly developed and largely irrelevant.</span></span>
<span id="cb29-294"><a href="#cb29-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-295"><a href="#cb29-295" aria-hidden="true" tabindex="-1"></a><span class="st">**Organization (1-5):**</span></span>
<span id="cb29-296"><a href="#cb29-296" aria-hidden="true" tabindex="-1"></a><span class="st">- 5: Exceptionally well-structured, very easy to follow, expert use of coherence devices.</span></span>
<span id="cb29-297"><a href="#cb29-297" aria-hidden="true" tabindex="-1"></a><span class="st">- 4: Effectively structured, easy to follow, good use of coherence devices.</span></span>
<span id="cb29-298"><a href="#cb29-298" aria-hidden="true" tabindex="-1"></a><span class="st">- 3: Adequate structure, generally followable.</span></span>
<span id="cb29-299"><a href="#cb29-299" aria-hidden="true" tabindex="-1"></a><span class="st">- 2: Weak structure, sometimes difficult to follow.</span></span>
<span id="cb29-300"><a href="#cb29-300" aria-hidden="true" tabindex="-1"></a><span class="st">- 1: Lacks clear structure, confusing.</span></span>
<span id="cb29-301"><a href="#cb29-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-302"><a href="#cb29-302" aria-hidden="true" tabindex="-1"></a><span class="st">**Language (1-5):**</span></span>
<span id="cb29-303"><a href="#cb29-303" aria-hidden="true" tabindex="-1"></a><span class="st">- 5: Sophisticated vocabulary, grammar and spelling correct throughout.</span></span>
<span id="cb29-304"><a href="#cb29-304" aria-hidden="true" tabindex="-1"></a><span class="st">- 4: Good vocabulary control, generally correct with minor errors.</span></span>
<span id="cb29-305"><a href="#cb29-305" aria-hidden="true" tabindex="-1"></a><span class="st">- 3: Adequate vocabulary, acceptable with some errors.</span></span>
<span id="cb29-306"><a href="#cb29-306" aria-hidden="true" tabindex="-1"></a><span class="st">- 2: Limited vocabulary, frequent errors that sometimes impede understanding.</span></span>
<span id="cb29-307"><a href="#cb29-307" aria-hidden="true" tabindex="-1"></a><span class="st">- 1: Very limited vocabulary, numerous errors.</span></span>
<span id="cb29-308"><a href="#cb29-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-309"><a href="#cb29-309" aria-hidden="true" tabindex="-1"></a><span class="st">PROMPT: {prompt}</span></span>
<span id="cb29-310"><a href="#cb29-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-311"><a href="#cb29-311" aria-hidden="true" tabindex="-1"></a><span class="st">ESSAY: {essay}</span></span>
<span id="cb29-312"><a href="#cb29-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-313"><a href="#cb29-313" aria-hidden="true" tabindex="-1"></a><span class="st">Format your response as:</span></span>
<span id="cb29-314"><a href="#cb29-314" aria-hidden="true" tabindex="-1"></a><span class="st">Content: [score]</span></span>
<span id="cb29-315"><a href="#cb29-315" aria-hidden="true" tabindex="-1"></a><span class="st">Organization: [score]</span></span>
<span id="cb29-316"><a href="#cb29-316" aria-hidden="true" tabindex="-1"></a><span class="st">Language: [score]</span></span>
<span id="cb29-317"><a href="#cb29-317" aria-hidden="true" tabindex="-1"></a><span class="st">Total: [sum of three scores]</span></span>
<span id="cb29-318"><a href="#cb29-318" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb29-319"><a href="#cb29-319" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-320"><a href="#cb29-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-321"><a href="#cb29-321" aria-hidden="true" tabindex="-1"></a><span class="co"># Score extraction function with debug capability</span></span>
<span id="cb29-322"><a href="#cb29-322" aria-hidden="true" tabindex="-1"></a>extract_scores <span class="ot">&lt;-</span> <span class="cf">function</span>(gpt_output, <span class="at">debug =</span> <span class="cn">FALSE</span>){</span>
<span id="cb29-323"><a href="#cb29-323" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(debug){</span>
<span id="cb29-324"><a href="#cb29-324" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"=== DEBUG: Extracting scores ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-325"><a href="#cb29-325" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Input text (first 300 chars):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-326"><a href="#cb29-326" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">substr</span>(gpt_output, <span class="dv">1</span>, <span class="dv">300</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb29-327"><a href="#cb29-327" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-328"><a href="#cb29-328" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-329"><a href="#cb29-329" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract Content score - try multiple patterns</span></span>
<span id="cb29-330"><a href="#cb29-330" aria-hidden="true" tabindex="-1"></a>  content_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"Content:?</span><span class="sc">\\</span><span class="st">s*([0-9.]+)"</span>)</span>
<span id="cb29-331"><a href="#cb29-331" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(content_match[<span class="dv">1</span>, <span class="dv">2</span>])){</span>
<span id="cb29-332"><a href="#cb29-332" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try alternate pattern</span></span>
<span id="cb29-333"><a href="#cb29-333" aria-hidden="true" tabindex="-1"></a>    content_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*Content:?</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*[^0-9]*([0-9.]+)"</span>)</span>
<span id="cb29-334"><a href="#cb29-334" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-335"><a href="#cb29-335" aria-hidden="true" tabindex="-1"></a>  content <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(content_match[<span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb29-336"><a href="#cb29-336" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-337"><a href="#cb29-337" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract Organization score</span></span>
<span id="cb29-338"><a href="#cb29-338" aria-hidden="true" tabindex="-1"></a>  org_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"Organization:?</span><span class="sc">\\</span><span class="st">s*([0-9.]+)"</span>)</span>
<span id="cb29-339"><a href="#cb29-339" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(org_match[<span class="dv">1</span>, <span class="dv">2</span>])){</span>
<span id="cb29-340"><a href="#cb29-340" aria-hidden="true" tabindex="-1"></a>    org_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*Organization:?</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*[^0-9]*([0-9.]+)"</span>)</span>
<span id="cb29-341"><a href="#cb29-341" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-342"><a href="#cb29-342" aria-hidden="true" tabindex="-1"></a>  organization <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(org_match[<span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb29-343"><a href="#cb29-343" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-344"><a href="#cb29-344" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract Language score</span></span>
<span id="cb29-345"><a href="#cb29-345" aria-hidden="true" tabindex="-1"></a>  lang_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"Language:?</span><span class="sc">\\</span><span class="st">s*([0-9.]+)"</span>)</span>
<span id="cb29-346"><a href="#cb29-346" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(lang_match[<span class="dv">1</span>, <span class="dv">2</span>])){</span>
<span id="cb29-347"><a href="#cb29-347" aria-hidden="true" tabindex="-1"></a>    lang_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*Language:?</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*[^0-9]*([0-9.]+)"</span>)</span>
<span id="cb29-348"><a href="#cb29-348" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-349"><a href="#cb29-349" aria-hidden="true" tabindex="-1"></a>  language <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(lang_match[<span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb29-350"><a href="#cb29-350" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-351"><a href="#cb29-351" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract Total score</span></span>
<span id="cb29-352"><a href="#cb29-352" aria-hidden="true" tabindex="-1"></a>  total_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"Total:?</span><span class="sc">\\</span><span class="st">s*([0-9.]+)"</span>)</span>
<span id="cb29-353"><a href="#cb29-353" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(total_match[<span class="dv">1</span>, <span class="dv">2</span>])){</span>
<span id="cb29-354"><a href="#cb29-354" aria-hidden="true" tabindex="-1"></a>    total_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*Total:?</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*[^0-9]*([0-9.]+)"</span>)</span>
<span id="cb29-355"><a href="#cb29-355" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-356"><a href="#cb29-356" aria-hidden="true" tabindex="-1"></a>  total <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(total_match[<span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb29-357"><a href="#cb29-357" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-358"><a href="#cb29-358" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(debug){</span>
<span id="cb29-359"><a href="#cb29-359" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Extracted values:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-360"><a href="#cb29-360" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Content:"</span>, content, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-361"><a href="#cb29-361" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Organization:"</span>, organization, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-362"><a href="#cb29-362" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Language:"</span>, language, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-363"><a href="#cb29-363" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Total:"</span>, total, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb29-364"><a href="#cb29-364" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-365"><a href="#cb29-365" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-366"><a href="#cb29-366" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return as a named vector</span></span>
<span id="cb29-367"><a href="#cb29-367" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">content =</span> content, </span>
<span id="cb29-368"><a href="#cb29-368" aria-hidden="true" tabindex="-1"></a>    <span class="at">organization =</span> organization, </span>
<span id="cb29-369"><a href="#cb29-369" aria-hidden="true" tabindex="-1"></a>    <span class="at">language =</span> language, </span>
<span id="cb29-370"><a href="#cb29-370" aria-hidden="true" tabindex="-1"></a>    <span class="at">total =</span> total)</span>
<span id="cb29-371"><a href="#cb29-371" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-372"><a href="#cb29-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-373"><a href="#cb29-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-374"><a href="#cb29-374" aria-hidden="true" tabindex="-1"></a><span class="co"># Returns a data frame (useful for binding multiple results)</span></span>
<span id="cb29-375"><a href="#cb29-375" aria-hidden="true" tabindex="-1"></a>extract_scores_df <span class="ot">&lt;-</span> <span class="cf">function</span>(gpt_output){</span>
<span id="cb29-376"><a href="#cb29-376" aria-hidden="true" tabindex="-1"></a>  scores <span class="ot">&lt;-</span> <span class="fu">extract_scores</span>(gpt_output)</span>
<span id="cb29-377"><a href="#cb29-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb29-378"><a href="#cb29-378" aria-hidden="true" tabindex="-1"></a>    <span class="at">content =</span> scores[<span class="st">"content"</span>],</span>
<span id="cb29-379"><a href="#cb29-379" aria-hidden="true" tabindex="-1"></a>    <span class="at">organization =</span> scores[<span class="st">"organization"</span>],</span>
<span id="cb29-380"><a href="#cb29-380" aria-hidden="true" tabindex="-1"></a>    <span class="at">language =</span> scores[<span class="st">"language"</span>],</span>
<span id="cb29-381"><a href="#cb29-381" aria-hidden="true" tabindex="-1"></a>    <span class="at">total =</span> scores[<span class="st">"total"</span>]</span>
<span id="cb29-382"><a href="#cb29-382" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-383"><a href="#cb29-383" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-384"><a href="#cb29-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-385"><a href="#cb29-385" aria-hidden="true" tabindex="-1"></a>essay_score_df <span class="ot">&lt;-</span> <span class="fu">extract_scores_df</span>(one_rep_essay)</span>
<span id="cb29-386"><a href="#cb29-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-387"><a href="#cb29-387" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">18</span>){</span>
<span id="cb29-388"><a href="#cb29-388" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-389"><a href="#cb29-389" aria-hidden="true" tabindex="-1"></a>  essay_score_again <span class="ot">&lt;-</span> <span class="fu">claude_plus</span>(<span class="at">prompt =</span> <span class="fu">all_rubric_prompt</span>(focal_prompt, focal_essay))</span>
<span id="cb29-390"><a href="#cb29-390" aria-hidden="true" tabindex="-1"></a>  essay_score_one <span class="ot">&lt;-</span> <span class="fu">extract_scores_df</span>(essay_score_again)</span>
<span id="cb29-391"><a href="#cb29-391" aria-hidden="true" tabindex="-1"></a>  essay_score_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(essay_score_df, essay_score_one)</span>
<span id="cb29-392"><a href="#cb29-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-393"><a href="#cb29-393" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-394"><a href="#cb29-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-395"><a href="#cb29-395" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(essay_score_df) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb29-396"><a href="#cb29-396" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(essay_score_df, <span class="at">file =</span> <span class="st">"data/essay_score_df.Rdata"</span>)</span>
<span id="cb29-397"><a href="#cb29-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-398"><a href="#cb29-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-399"><a href="#cb29-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-400"><a href="#cb29-400" aria-hidden="true" tabindex="-1"></a>Let's now see how consistently the model applied the scores to the essay:</span>
<span id="cb29-401"><a href="#cb29-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-404"><a href="#cb29-404" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-405"><a href="#cb29-405" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get summary statistics for multiple scored essays</span></span>
<span id="cb29-406"><a href="#cb29-406" aria-hidden="true" tabindex="-1"></a>summarize_scores <span class="ot">&lt;-</span> <span class="cf">function</span>(score_df){</span>
<span id="cb29-407"><a href="#cb29-407" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb29-408"><a href="#cb29-408" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate summary statistics</span></span>
<span id="cb29-409"><a href="#cb29-409" aria-hidden="true" tabindex="-1"></a>  summary_stats <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-410"><a href="#cb29-410" aria-hidden="true" tabindex="-1"></a>    <span class="at">criterion =</span> <span class="fu">c</span>(<span class="st">"Content"</span>, <span class="st">"Organization"</span>, <span class="st">"Language"</span>, <span class="st">"Total"</span>),</span>
<span id="cb29-411"><a href="#cb29-411" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">c</span>(<span class="fu">mean</span>(score_df<span class="sc">$</span>content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-412"><a href="#cb29-412" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mean</span>(score_df<span class="sc">$</span>organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-413"><a href="#cb29-413" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mean</span>(score_df<span class="sc">$</span>language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-414"><a href="#cb29-414" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mean</span>(score_df<span class="sc">$</span>total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb29-415"><a href="#cb29-415" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">c</span>(<span class="fu">sd</span>(score_df<span class="sc">$</span>content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-416"><a href="#cb29-416" aria-hidden="true" tabindex="-1"></a>           <span class="fu">sd</span>(score_df<span class="sc">$</span>organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-417"><a href="#cb29-417" aria-hidden="true" tabindex="-1"></a>           <span class="fu">sd</span>(score_df<span class="sc">$</span>language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-418"><a href="#cb29-418" aria-hidden="true" tabindex="-1"></a>           <span class="fu">sd</span>(score_df<span class="sc">$</span>total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb29-419"><a href="#cb29-419" aria-hidden="true" tabindex="-1"></a>    <span class="at">min =</span> <span class="fu">c</span>(<span class="fu">min</span>(score_df<span class="sc">$</span>content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-420"><a href="#cb29-420" aria-hidden="true" tabindex="-1"></a>            <span class="fu">min</span>(score_df<span class="sc">$</span>organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-421"><a href="#cb29-421" aria-hidden="true" tabindex="-1"></a>            <span class="fu">min</span>(score_df<span class="sc">$</span>language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-422"><a href="#cb29-422" aria-hidden="true" tabindex="-1"></a>            <span class="fu">min</span>(score_df<span class="sc">$</span>total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb29-423"><a href="#cb29-423" aria-hidden="true" tabindex="-1"></a>    <span class="at">max =</span> <span class="fu">c</span>(<span class="fu">max</span>(score_df<span class="sc">$</span>content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-424"><a href="#cb29-424" aria-hidden="true" tabindex="-1"></a>            <span class="fu">max</span>(score_df<span class="sc">$</span>organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-425"><a href="#cb29-425" aria-hidden="true" tabindex="-1"></a>            <span class="fu">max</span>(score_df<span class="sc">$</span>language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-426"><a href="#cb29-426" aria-hidden="true" tabindex="-1"></a>            <span class="fu">max</span>(score_df<span class="sc">$</span>total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb29-427"><a href="#cb29-427" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-428"><a href="#cb29-428" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-429"><a href="#cb29-429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(summary_stats)</span>
<span id="cb29-430"><a href="#cb29-430" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-431"><a href="#cb29-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-432"><a href="#cb29-432" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/essay_score_df.Rdata"</span>)</span>
<span id="cb29-433"><a href="#cb29-433" aria-hidden="true" tabindex="-1"></a>score_summary <span class="ot">&lt;-</span> <span class="fu">summarize_scores</span>(essay_score_df)</span>
<span id="cb29-434"><a href="#cb29-434" aria-hidden="true" tabindex="-1"></a>score_summary</span>
<span id="cb29-435"><a href="#cb29-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-436"><a href="#cb29-436" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-437"><a href="#cb29-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-438"><a href="#cb29-438" aria-hidden="true" tabindex="-1"></a>Pretty good! There is only .5 variation in scores for <span class="in">`Content`</span> and <span class="in">`Organization`</span>, and no variation in <span class="in">`Language`</span> scores.</span>
<span id="cb29-439"><a href="#cb29-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-440"><a href="#cb29-440" aria-hidden="true" tabindex="-1"></a><span class="fu">### Repeating Score Task (`Temp = 0`)</span></span>
<span id="cb29-441"><a href="#cb29-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-442"><a href="#cb29-442" aria-hidden="true" tabindex="-1"></a>Let's now repeat the task, but turn the temperature down and see how this affects score variability.</span>
<span id="cb29-443"><a href="#cb29-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-444"><a href="#cb29-444" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb29-445"><a href="#cb29-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-446"><a href="#cb29-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-447"><a href="#cb29-447" aria-hidden="true" tabindex="-1"></a>low_temp_essay <span class="ot">&lt;-</span> <span class="fu">claude_plus</span>(<span class="at">prompt =</span> <span class="fu">all_rubric_prompt</span>(focal_prompt, focal_essay),</span>
<span id="cb29-448"><a href="#cb29-448" aria-hidden="true" tabindex="-1"></a>                              <span class="at">temperature =</span> <span class="dv">0</span>)</span>
<span id="cb29-449"><a href="#cb29-449" aria-hidden="true" tabindex="-1"></a>low_temp_df <span class="ot">&lt;-</span> <span class="fu">extract_scores_df</span>(low_temp_essay)</span>
<span id="cb29-450"><a href="#cb29-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-451"><a href="#cb29-451" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">19</span>){</span>
<span id="cb29-452"><a href="#cb29-452" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-453"><a href="#cb29-453" aria-hidden="true" tabindex="-1"></a>  low_temp_score_again <span class="ot">&lt;-</span> <span class="fu">claude_plus</span>(<span class="at">prompt =</span> <span class="fu">all_rubric_prompt</span>(focal_prompt, focal_essay),</span>
<span id="cb29-454"><a href="#cb29-454" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">temperature =</span> <span class="dv">0</span>)</span>
<span id="cb29-455"><a href="#cb29-455" aria-hidden="true" tabindex="-1"></a>  low_temp_score_one <span class="ot">&lt;-</span> <span class="fu">extract_scores_df</span>(low_temp_score_again)</span>
<span id="cb29-456"><a href="#cb29-456" aria-hidden="true" tabindex="-1"></a>  low_temp_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(low_temp_df, low_temp_score_one)</span>
<span id="cb29-457"><a href="#cb29-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-458"><a href="#cb29-458" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-459"><a href="#cb29-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-460"><a href="#cb29-460" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(low_temp_df) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb29-461"><a href="#cb29-461" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(low_temp_df, <span class="at">file =</span> <span class="st">"data/low_temp_df.Rdata"</span>)</span>
<span id="cb29-462"><a href="#cb29-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-463"><a href="#cb29-463" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-466"><a href="#cb29-466" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-467"><a href="#cb29-467" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/low_temp_df.Rdata"</span>)</span>
<span id="cb29-468"><a href="#cb29-468" aria-hidden="true" tabindex="-1"></a>low_temp_summary <span class="ot">&lt;-</span> <span class="fu">summarize_scores</span>(low_temp_df)</span>
<span id="cb29-469"><a href="#cb29-469" aria-hidden="true" tabindex="-1"></a>low_temp_summary</span>
<span id="cb29-470"><a href="#cb29-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-471"><a href="#cb29-471" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-472"><a href="#cb29-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-473"><a href="#cb29-473" aria-hidden="true" tabindex="-1"></a>Nice! </span>
<span id="cb29-474"><a href="#cb29-474" aria-hidden="true" tabindex="-1"></a>The eliminated all of the score variability. However, given the vague nature of the rubric, we still don't know if these scores are _accurate_ - we may be consistently missing the mark on what the true score should be.</span>
<span id="cb29-475"><a href="#cb29-475" aria-hidden="true" tabindex="-1"></a>The rubric criteria are broad and it's unclear how one should apply the rubric.</span>
<span id="cb29-476"><a href="#cb29-476" aria-hidden="true" tabindex="-1"></a>What constitutes each score level for the individual criteria?</span>
<span id="cb29-477"><a href="#cb29-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-478"><a href="#cb29-478" aria-hidden="true" tabindex="-1"></a>Interestingly, when I asked Anthropic for help in developing a scoring rubric for the essays, it recognized that having clear descriptions of the different scoring categories was important, so it made them up!</span>
<span id="cb29-479"><a href="#cb29-479" aria-hidden="true" tabindex="-1"></a>The prompt below shows how the model decided to describe each of the score categories.</span>
<span id="cb29-480"><a href="#cb29-480" aria-hidden="true" tabindex="-1"></a>Obviously these descriptions should be developed and reviewed by subject matter experts, but for the purposes of the workshop we'll just use what Claude generated.</span>
<span id="cb29-481"><a href="#cb29-481" aria-hidden="true" tabindex="-1"></a>In your process you also want to check that your generative AI model is utilizing the rubric correctly - supplying a detailed rubric and obtaining consistent results alone isn't sufficient.</span>
<span id="cb29-482"><a href="#cb29-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-483"><a href="#cb29-483" aria-hidden="true" tabindex="-1"></a><span class="fu">### Scoring with Detailed Rubric </span></span>
<span id="cb29-484"><a href="#cb29-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-485"><a href="#cb29-485" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb29-486"><a href="#cb29-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-487"><a href="#cb29-487" aria-hidden="true" tabindex="-1"></a>claude_all_rubric_prompt <span class="ot">&lt;-</span> <span class="cf">function</span>(prompt, essay){</span>
<span id="cb29-488"><a href="#cb29-488" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb29-489"><a href="#cb29-489" aria-hidden="true" tabindex="-1"></a><span class="st">You are an expert essay grader. Score the following student essay based on three criteria: Content, Organization, and Language. Each criterion should be scored from 1 to 5 in increments of 0.5 (e.g., 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5).</span></span>
<span id="cb29-490"><a href="#cb29-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-491"><a href="#cb29-491" aria-hidden="true" tabindex="-1"></a><span class="st">RUBRIC:</span></span>
<span id="cb29-492"><a href="#cb29-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-493"><a href="#cb29-493" aria-hidden="true" tabindex="-1"></a><span class="st">**Content (1-5):**</span></span>
<span id="cb29-494"><a href="#cb29-494" aria-hidden="true" tabindex="-1"></a><span class="st">- 5: Paragraph is exceptionally well-developed and highly relevant to the argument, supported with strong, specific reasons and compelling examples.</span></span>
<span id="cb29-495"><a href="#cb29-495" aria-hidden="true" tabindex="-1"></a><span class="st">- 4: Paragraph is well-developed and relevant to the argument, supported with clear reasons and good examples.</span></span>
<span id="cb29-496"><a href="#cb29-496" aria-hidden="true" tabindex="-1"></a><span class="st">- 3: Paragraph is adequately developed with some relevance to the argument, supported with acceptable reasons and examples.</span></span>
<span id="cb29-497"><a href="#cb29-497" aria-hidden="true" tabindex="-1"></a><span class="st">- 2: Paragraph is underdeveloped or somewhat irrelevant to the argument, with weak or insufficient reasons and examples.</span></span>
<span id="cb29-498"><a href="#cb29-498" aria-hidden="true" tabindex="-1"></a><span class="st">- 1: Paragraph is poorly developed and largely irrelevant to the argument, lacking meaningful reasons and examples.</span></span>
<span id="cb29-499"><a href="#cb29-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-500"><a href="#cb29-500" aria-hidden="true" tabindex="-1"></a><span class="st">**Organization (1-5):**</span></span>
<span id="cb29-501"><a href="#cb29-501" aria-hidden="true" tabindex="-1"></a><span class="st">- 5: The argument is exceptionally well-structured and developed, making it very easy for the reader to follow ideas and understand how the argument is built. Paragraphs use coherence devices expertly while maintaining clear focus on main ideas.</span></span>
<span id="cb29-502"><a href="#cb29-502" aria-hidden="true" tabindex="-1"></a><span class="st">- 4: The argument is effectively structured and developed, making it easy for the reader to follow ideas. Paragraphs use coherence devices well and focus on main ideas.</span></span>
<span id="cb29-503"><a href="#cb29-503" aria-hidden="true" tabindex="-1"></a><span class="st">- 3: The argument has adequate structure and development. The reader can follow most ideas. Paragraphs use some coherence devices and generally focus on main ideas.</span></span>
<span id="cb29-504"><a href="#cb29-504" aria-hidden="true" tabindex="-1"></a><span class="st">- 2: The argument has weak structure and development. Ideas are sometimes difficult to follow. Paragraphs use few coherence devices and may lose focus.</span></span>
<span id="cb29-505"><a href="#cb29-505" aria-hidden="true" tabindex="-1"></a><span class="st">- 1: The argument lacks clear structure and development. Ideas are confusing and hard to follow. Paragraphs lack coherence devices and focus.</span></span>
<span id="cb29-506"><a href="#cb29-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-507"><a href="#cb29-507" aria-hidden="true" tabindex="-1"></a><span class="st">**Language (1-5):**</span></span>
<span id="cb29-508"><a href="#cb29-508" aria-hidden="true" tabindex="-1"></a><span class="st">- 5: The writing displays sophisticated control of a wide range of vocabulary and collocations. Grammar and usage are correct throughout. Spelling and punctuation are correct throughout.</span></span>
<span id="cb29-509"><a href="#cb29-509" aria-hidden="true" tabindex="-1"></a><span class="st">- 4: The writing displays good control of vocabulary and collocations. Grammar and usage are generally correct with only minor errors. Spelling and punctuation are generally correct.</span></span>
<span id="cb29-510"><a href="#cb29-510" aria-hidden="true" tabindex="-1"></a><span class="st">- 3: The writing displays adequate vocabulary with some variety. Grammar and usage are acceptable with some errors that do not impede understanding. Spelling and punctuation are mostly correct.</span></span>
<span id="cb29-511"><a href="#cb29-511" aria-hidden="true" tabindex="-1"></a><span class="st">- 2: The writing displays limited vocabulary with little variety. Grammar and usage contain frequent errors that sometimes impede understanding. Spelling and punctuation errors are noticeable.</span></span>
<span id="cb29-512"><a href="#cb29-512" aria-hidden="true" tabindex="-1"></a><span class="st">- 1: The writing displays very limited vocabulary. Grammar and usage contain numerous errors that significantly impede understanding. Spelling and punctuation errors are frequent.</span></span>
<span id="cb29-513"><a href="#cb29-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-514"><a href="#cb29-514" aria-hidden="true" tabindex="-1"></a><span class="st">PROMPT: {prompt}</span></span>
<span id="cb29-515"><a href="#cb29-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-516"><a href="#cb29-516" aria-hidden="true" tabindex="-1"></a><span class="st">ESSAY: {essay}</span></span>
<span id="cb29-517"><a href="#cb29-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-518"><a href="#cb29-518" aria-hidden="true" tabindex="-1"></a><span class="st">Please provide scores for each criterion and calculate the total score. Format your response as follows:</span></span>
<span id="cb29-519"><a href="#cb29-519" aria-hidden="true" tabindex="-1"></a><span class="st">Content: [score]</span></span>
<span id="cb29-520"><a href="#cb29-520" aria-hidden="true" tabindex="-1"></a><span class="st">Organization: [score]</span></span>
<span id="cb29-521"><a href="#cb29-521" aria-hidden="true" tabindex="-1"></a><span class="st">Language: [score]</span></span>
<span id="cb29-522"><a href="#cb29-522" aria-hidden="true" tabindex="-1"></a><span class="st">Total: [sum of three scores]</span></span>
<span id="cb29-523"><a href="#cb29-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-524"><a href="#cb29-524" aria-hidden="true" tabindex="-1"></a><span class="st">Provide a brief justification (1-2 sentences) for each score.</span></span>
<span id="cb29-525"><a href="#cb29-525" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb29-526"><a href="#cb29-526" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-527"><a href="#cb29-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-528"><a href="#cb29-528" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-529"><a href="#cb29-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-530"><a href="#cb29-530" aria-hidden="true" tabindex="-1"></a>Let's now apply this rubric to the example essay and see how it might impact model-generated scores.</span>
<span id="cb29-531"><a href="#cb29-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-532"><a href="#cb29-532" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb29-533"><a href="#cb29-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-534"><a href="#cb29-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-535"><a href="#cb29-535" aria-hidden="true" tabindex="-1"></a>claude_rubric_score <span class="ot">&lt;-</span> <span class="fu">claude_plus</span>(<span class="at">prompt =</span> <span class="fu">claude_all_rubric_prompt</span>(focal_prompt, focal_essay),</span>
<span id="cb29-536"><a href="#cb29-536" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">temperature =</span> <span class="dv">0</span>)</span>
<span id="cb29-537"><a href="#cb29-537" aria-hidden="true" tabindex="-1"></a>claude_rubric_df <span class="ot">&lt;-</span> <span class="fu">extract_scores_df</span>(claude_rubric_score)</span>
<span id="cb29-538"><a href="#cb29-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-539"><a href="#cb29-539" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">19</span>){</span>
<span id="cb29-540"><a href="#cb29-540" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-541"><a href="#cb29-541" aria-hidden="true" tabindex="-1"></a>  claude_rubric_score_again <span class="ot">&lt;-</span> <span class="fu">claude_plus</span>(<span class="at">prompt =</span> <span class="fu">claude_all_rubric_prompt</span>(focal_prompt, focal_essay),</span>
<span id="cb29-542"><a href="#cb29-542" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">temperature =</span> <span class="dv">0</span>)</span>
<span id="cb29-543"><a href="#cb29-543" aria-hidden="true" tabindex="-1"></a>  claude_rubric_one <span class="ot">&lt;-</span> <span class="fu">extract_scores_df</span>(claude_rubric_score_again)</span>
<span id="cb29-544"><a href="#cb29-544" aria-hidden="true" tabindex="-1"></a>  claude_rubric_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(claude_rubric_df, claude_rubric_one)</span>
<span id="cb29-545"><a href="#cb29-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-546"><a href="#cb29-546" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-547"><a href="#cb29-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-548"><a href="#cb29-548" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(claude_rubric_df) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb29-549"><a href="#cb29-549" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(claude_rubric_df, <span class="at">file =</span> <span class="st">"data/claude_rubric_df.Rdata"</span>)</span>
<span id="cb29-550"><a href="#cb29-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-551"><a href="#cb29-551" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-554"><a href="#cb29-554" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-555"><a href="#cb29-555" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/claude_rubric_df.Rdata"</span>)</span>
<span id="cb29-556"><a href="#cb29-556" aria-hidden="true" tabindex="-1"></a>claude_rubric_summary <span class="ot">&lt;-</span> <span class="fu">summarize_scores</span>(claude_rubric_df)</span>
<span id="cb29-557"><a href="#cb29-557" aria-hidden="true" tabindex="-1"></a>claude_rubric_summary</span>
<span id="cb29-558"><a href="#cb29-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-559"><a href="#cb29-559" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-560"><a href="#cb29-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-561"><a href="#cb29-561" aria-hidden="true" tabindex="-1"></a>Whoa! These are the exact same scores as when we didn't provide detailed rubric explanation in our prompt.</span>
<span id="cb29-562"><a href="#cb29-562" aria-hidden="true" tabindex="-1"></a>This suggests to me that the model is generating a similar rubric each time through <span class="co">[</span><span class="ot">invisible instructions</span><span class="co">](@sec-invisble)</span>, but I can't know this for sure.</span>
<span id="cb29-563"><a href="#cb29-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-564"><a href="#cb29-564" aria-hidden="true" tabindex="-1"></a>It has also been empirically demonstrated (find the citations, Chris) that these models don't apply rubrics well at the extremes - the lowest and highest scores. </span>
<span id="cb29-565"><a href="#cb29-565" aria-hidden="true" tabindex="-1"></a>When I used Claude to help generate synthetic student responses, I asked it have a range of score values represented in the 10 generated essays.</span>
<span id="cb29-566"><a href="#cb29-566" aria-hidden="true" tabindex="-1"></a>It'll be useful to repeat the same experiment on all 10 essays to see if the scoring variability is consistent across the score range.</span>
<span id="cb29-567"><a href="#cb29-567" aria-hidden="true" tabindex="-1"></a>(There's a strong possibility that it will be - I asked Claude to generate the essays and now I'm asking it to score essays it generated.)</span>
<span id="cb29-568"><a href="#cb29-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-569"><a href="#cb29-569" aria-hidden="true" tabindex="-1"></a><span class="fu">### Batch Scoring</span></span>
<span id="cb29-570"><a href="#cb29-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-571"><a href="#cb29-571" aria-hidden="true" tabindex="-1"></a>Now that we're repeating the same task across a batch of essays, it's a great time to introduce batch scoring!</span>
<span id="cb29-572"><a href="#cb29-572" aria-hidden="true" tabindex="-1"></a>This generally works as you'd think - you submit multiple tasks at once to the API to complete in parallel - with the one wrinkle that Anthropic requires that the requests be in the JSONL format.</span>
<span id="cb29-573"><a href="#cb29-573" aria-hidden="true" tabindex="-1"></a>In addition to being able to submit multiple requests at once, it's also cheaper to use than single-call API interactions.</span>
<span id="cb29-574"><a href="#cb29-574" aria-hidden="true" tabindex="-1"></a>As of this writing (Oct 19, 2025), you save 50% with batch pricing. </span>
<span id="cb29-575"><a href="#cb29-575" aria-hidden="true" tabindex="-1"></a>This drops input costs from \$3 per 1M tokens to \$1.50 per 1M token, and output costs from \$15 per 1M tokens to \$7.50 per 1M tokens.</span>
<span id="cb29-576"><a href="#cb29-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-577"><a href="#cb29-577" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Creating Batch Requests</span></span>
<span id="cb29-578"><a href="#cb29-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-579"><a href="#cb29-579" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb29-580"><a href="#cb29-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-581"><a href="#cb29-581" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Read essays and create batch requests</span></span>
<span id="cb29-582"><a href="#cb29-582" aria-hidden="true" tabindex="-1"></a>create_batch_requests <span class="ot">&lt;-</span> <span class="cf">function</span>(essays_df, <span class="at">n_repetitions =</span> <span class="dv">20</span>){</span>
<span id="cb29-583"><a href="#cb29-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-584"><a href="#cb29-584" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a list to store batch requests</span></span>
<span id="cb29-585"><a href="#cb29-585" aria-hidden="true" tabindex="-1"></a>  batch_requests <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb29-586"><a href="#cb29-586" aria-hidden="true" tabindex="-1"></a>  request_counter <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb29-587"><a href="#cb29-587" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-588"><a href="#cb29-588" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create n_repetitions requests for each essay (grouped by essay)</span></span>
<span id="cb29-589"><a href="#cb29-589" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(essays_df)){</span>
<span id="cb29-590"><a href="#cb29-590" aria-hidden="true" tabindex="-1"></a>    essay_prompt <span class="ot">&lt;-</span> <span class="fu">claude_all_rubric_prompt</span>(essays_df<span class="sc">$</span>prompt[i], essays_df<span class="sc">$</span>essay[i])</span>
<span id="cb29-591"><a href="#cb29-591" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-592"><a href="#cb29-592" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create 20 requests for this essay</span></span>
<span id="cb29-593"><a href="#cb29-593" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(rep <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_repetitions){</span>
<span id="cb29-594"><a href="#cb29-594" aria-hidden="true" tabindex="-1"></a>      request <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb29-595"><a href="#cb29-595" aria-hidden="true" tabindex="-1"></a>        <span class="at">custom_id =</span> <span class="fu">paste0</span>(<span class="st">"essay_"</span>, essays_df<span class="sc">$</span>id[i], <span class="st">"_rep_"</span>, rep),</span>
<span id="cb29-596"><a href="#cb29-596" aria-hidden="true" tabindex="-1"></a>        <span class="at">params =</span> <span class="fu">list</span>(</span>
<span id="cb29-597"><a href="#cb29-597" aria-hidden="true" tabindex="-1"></a>          <span class="at">model =</span> <span class="st">"claude-sonnet-4-20250514"</span>,</span>
<span id="cb29-598"><a href="#cb29-598" aria-hidden="true" tabindex="-1"></a>          <span class="at">max_tokens =</span> <span class="dv">1024</span>,</span>
<span id="cb29-599"><a href="#cb29-599" aria-hidden="true" tabindex="-1"></a>          <span class="at">messages =</span> <span class="fu">list</span>(</span>
<span id="cb29-600"><a href="#cb29-600" aria-hidden="true" tabindex="-1"></a>            <span class="fu">list</span>(</span>
<span id="cb29-601"><a href="#cb29-601" aria-hidden="true" tabindex="-1"></a>              <span class="at">role =</span> <span class="st">"user"</span>,</span>
<span id="cb29-602"><a href="#cb29-602" aria-hidden="true" tabindex="-1"></a>              <span class="at">content =</span> essay_prompt</span>
<span id="cb29-603"><a href="#cb29-603" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb29-604"><a href="#cb29-604" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb29-605"><a href="#cb29-605" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-606"><a href="#cb29-606" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb29-607"><a href="#cb29-607" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-608"><a href="#cb29-608" aria-hidden="true" tabindex="-1"></a>      batch_requests[[request_counter]] <span class="ot">&lt;-</span> request</span>
<span id="cb29-609"><a href="#cb29-609" aria-hidden="true" tabindex="-1"></a>      request_counter <span class="ot">&lt;-</span> request_counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb29-610"><a href="#cb29-610" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-611"><a href="#cb29-611" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-612"><a href="#cb29-612" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-613"><a href="#cb29-613" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Created"</span>, <span class="fu">length</span>(batch_requests), <span class="st">"batch requests for"</span>, <span class="fu">nrow</span>(essays_df), <span class="st">"essays</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-614"><a href="#cb29-614" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-615"><a href="#cb29-615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(batch_requests)</span>
<span id="cb29-616"><a href="#cb29-616" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-617"><a href="#cb29-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-618"><a href="#cb29-618" aria-hidden="true" tabindex="-1"></a>essay_batch_requests <span class="ot">&lt;-</span> <span class="fu">create_batch_requests</span>(student_essays)</span>
<span id="cb29-619"><a href="#cb29-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-620"><a href="#cb29-620" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-621"><a href="#cb29-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-622"><a href="#cb29-622" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Writing Requests to JSONL</span></span>
<span id="cb29-623"><a href="#cb29-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-624"><a href="#cb29-624" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb29-625"><a href="#cb29-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-626"><a href="#cb29-626" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Write requests to JSONL file</span></span>
<span id="cb29-627"><a href="#cb29-627" aria-hidden="true" tabindex="-1"></a>write_batch_file <span class="ot">&lt;-</span> <span class="cf">function</span>(batch_requests, <span class="at">output_file =</span> <span class="st">"batch_requests.jsonl"</span>){</span>
<span id="cb29-628"><a href="#cb29-628" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Write each request as a JSON line</span></span>
<span id="cb29-629"><a href="#cb29-629" aria-hidden="true" tabindex="-1"></a>  jsonl_lines <span class="ot">&lt;-</span> <span class="fu">sapply</span>(batch_requests, <span class="cf">function</span>(req){</span>
<span id="cb29-630"><a href="#cb29-630" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toJSON</span>(req, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-631"><a href="#cb29-631" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb29-632"><a href="#cb29-632" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-633"><a href="#cb29-633" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(jsonl_lines, output_file)</span>
<span id="cb29-634"><a href="#cb29-634" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output_file)</span>
<span id="cb29-635"><a href="#cb29-635" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-636"><a href="#cb29-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-637"><a href="#cb29-637" aria-hidden="true" tabindex="-1"></a>essay_batch_jsonl <span class="ot">&lt;-</span> <span class="fu">write_batch_file</span>(essay_batch_requests)</span>
<span id="cb29-638"><a href="#cb29-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-639"><a href="#cb29-639" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-640"><a href="#cb29-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-641"><a href="#cb29-641" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Submitting Batch Request</span></span>
<span id="cb29-642"><a href="#cb29-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-643"><a href="#cb29-643" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb29-644"><a href="#cb29-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-645"><a href="#cb29-645" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Submit batch job to Anthropic</span></span>
<span id="cb29-646"><a href="#cb29-646" aria-hidden="true" tabindex="-1"></a>submit_batch <span class="ot">&lt;-</span> <span class="cf">function</span>(jsonl_file){</span>
<span id="cb29-647"><a href="#cb29-647" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read and parse each line of the JSONL file</span></span>
<span id="cb29-648"><a href="#cb29-648" aria-hidden="true" tabindex="-1"></a>  jsonl_lines <span class="ot">&lt;-</span> <span class="fu">readLines</span>(jsonl_file)</span>
<span id="cb29-649"><a href="#cb29-649" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-650"><a href="#cb29-650" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse each JSON line into a list</span></span>
<span id="cb29-651"><a href="#cb29-651" aria-hidden="true" tabindex="-1"></a>  requests_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(jsonl_lines, <span class="cf">function</span>(line){</span>
<span id="cb29-652"><a href="#cb29-652" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fromJSON</span>(line, <span class="at">simplifyVector =</span> <span class="cn">FALSE</span>)</span>
<span id="cb29-653"><a href="#cb29-653" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb29-654"><a href="#cb29-654" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-655"><a href="#cb29-655" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create batch</span></span>
<span id="cb29-656"><a href="#cb29-656" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> <span class="fu">POST</span>(</span>
<span id="cb29-657"><a href="#cb29-657" aria-hidden="true" tabindex="-1"></a>    <span class="at">url =</span> <span class="st">"https://api.anthropic.com/v1/messages/batches"</span>,</span>
<span id="cb29-658"><a href="#cb29-658" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_headers</span>(</span>
<span id="cb29-659"><a href="#cb29-659" aria-hidden="true" tabindex="-1"></a>      <span class="st">"x-api-key"</span> <span class="ot">=</span> <span class="fu">Sys.getenv</span>(<span class="st">"ANTHROPIC_API_KEY"</span>),</span>
<span id="cb29-660"><a href="#cb29-660" aria-hidden="true" tabindex="-1"></a>      <span class="st">"anthropic-version"</span> <span class="ot">=</span> <span class="st">"2023-06-01"</span>,</span>
<span id="cb29-661"><a href="#cb29-661" aria-hidden="true" tabindex="-1"></a>      <span class="st">"content-type"</span> <span class="ot">=</span> <span class="st">"application/json"</span></span>
<span id="cb29-662"><a href="#cb29-662" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb29-663"><a href="#cb29-663" aria-hidden="true" tabindex="-1"></a>    <span class="at">body =</span> <span class="fu">toJSON</span>(<span class="fu">list</span>(</span>
<span id="cb29-664"><a href="#cb29-664" aria-hidden="true" tabindex="-1"></a>      <span class="at">requests =</span> requests_list</span>
<span id="cb29-665"><a href="#cb29-665" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-666"><a href="#cb29-666" aria-hidden="true" tabindex="-1"></a>    <span class="at">encode =</span> <span class="st">"json"</span></span>
<span id="cb29-667"><a href="#cb29-667" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-668"><a href="#cb29-668" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-669"><a href="#cb29-669" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">status_code</span>(response) <span class="sc">!=</span> <span class="dv">200</span>){</span>
<span id="cb29-670"><a href="#cb29-670" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Error submitting batch: "</span>, <span class="fu">content</span>(response, <span class="st">"text"</span>))</span>
<span id="cb29-671"><a href="#cb29-671" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-672"><a href="#cb29-672" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-673"><a href="#cb29-673" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">content</span>(response, <span class="st">"parsed"</span>)</span>
<span id="cb29-674"><a href="#cb29-674" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Batch submitted successfully!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-675"><a href="#cb29-675" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Batch ID:"</span>, result<span class="sc">$</span>id, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-676"><a href="#cb29-676" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-677"><a href="#cb29-677" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb29-678"><a href="#cb29-678" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-679"><a href="#cb29-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-680"><a href="#cb29-680" aria-hidden="true" tabindex="-1"></a>essay_batch_info <span class="ot">&lt;-</span> <span class="fu">submit_batch</span>(essay_batch_jsonl)</span>
<span id="cb29-681"><a href="#cb29-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-682"><a href="#cb29-682" aria-hidden="true" tabindex="-1"></a><span class="co"># Batch submitted successfully!</span></span>
<span id="cb29-683"><a href="#cb29-683" aria-hidden="true" tabindex="-1"></a><span class="co"># Batch ID: msgbatch_018m5hGS9Lm3Gi28UorfsVTS</span></span>
<span id="cb29-684"><a href="#cb29-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-685"><a href="#cb29-685" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-686"><a href="#cb29-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-687"><a href="#cb29-687" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Checking Batch Status</span></span>
<span id="cb29-688"><a href="#cb29-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-689"><a href="#cb29-689" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb29-690"><a href="#cb29-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-691"><a href="#cb29-691" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Check batch status</span></span>
<span id="cb29-692"><a href="#cb29-692" aria-hidden="true" tabindex="-1"></a>check_batch_status <span class="ot">&lt;-</span> <span class="cf">function</span>(batch_id){</span>
<span id="cb29-693"><a href="#cb29-693" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> <span class="fu">GET</span>(</span>
<span id="cb29-694"><a href="#cb29-694" aria-hidden="true" tabindex="-1"></a>    <span class="at">url =</span> <span class="fu">paste0</span>(<span class="st">"https://api.anthropic.com/v1/messages/batches/"</span>, batch_id),</span>
<span id="cb29-695"><a href="#cb29-695" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_headers</span>(</span>
<span id="cb29-696"><a href="#cb29-696" aria-hidden="true" tabindex="-1"></a>      <span class="st">"x-api-key"</span> <span class="ot">=</span> <span class="fu">Sys.getenv</span>(<span class="st">"ANTHROPIC_API_KEY"</span>),</span>
<span id="cb29-697"><a href="#cb29-697" aria-hidden="true" tabindex="-1"></a>      <span class="st">"anthropic-version"</span> <span class="ot">=</span> <span class="st">"2023-06-01"</span></span>
<span id="cb29-698"><a href="#cb29-698" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-699"><a href="#cb29-699" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-700"><a href="#cb29-700" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-701"><a href="#cb29-701" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">status_code</span>(response) <span class="sc">!=</span> <span class="dv">200</span>){</span>
<span id="cb29-702"><a href="#cb29-702" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Error checking batch status: "</span>, <span class="fu">content</span>(response, <span class="st">"text"</span>))</span>
<span id="cb29-703"><a href="#cb29-703" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-704"><a href="#cb29-704" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-705"><a href="#cb29-705" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">content</span>(response, <span class="st">"parsed"</span>)</span>
<span id="cb29-706"><a href="#cb29-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb29-707"><a href="#cb29-707" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-708"><a href="#cb29-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-709"><a href="#cb29-709" aria-hidden="true" tabindex="-1"></a>essay_status <span class="ot">&lt;-</span> <span class="fu">check_batch_status</span>(essay_batch_info<span class="sc">$</span>id)</span>
<span id="cb29-710"><a href="#cb29-710" aria-hidden="true" tabindex="-1"></a><span class="co"># Finished!</span></span>
<span id="cb29-711"><a href="#cb29-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-712"><a href="#cb29-712" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb29-713"><a href="#cb29-713" aria-hidden="true" tabindex="-1"></a>batch_start_time <span class="ot">&lt;-</span> <span class="fu">ymd_hms</span>(essay_status<span class="sc">$</span>created_at)</span>
<span id="cb29-714"><a href="#cb29-714" aria-hidden="true" tabindex="-1"></a>batch_stop_time <span class="ot">&lt;-</span> <span class="fu">ymd_hms</span>(essay_status<span class="sc">$</span>ended_at)</span>
<span id="cb29-715"><a href="#cb29-715" aria-hidden="true" tabindex="-1"></a>batch_run_time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(batch_stop_time <span class="sc">-</span> batch_start_time)</span>
<span id="cb29-716"><a href="#cb29-716" aria-hidden="true" tabindex="-1"></a><span class="co"># Time difference of 1.644671 mins</span></span>
<span id="cb29-717"><a href="#cb29-717" aria-hidden="true" tabindex="-1"></a><span class="co"># Less than 2 minutes to score 200 essays!</span></span>
<span id="cb29-718"><a href="#cb29-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-719"><a href="#cb29-719" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-720"><a href="#cb29-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-721"><a href="#cb29-721" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Saving Batch Results</span></span>
<span id="cb29-722"><a href="#cb29-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-723"><a href="#cb29-723" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb29-724"><a href="#cb29-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-725"><a href="#cb29-725" aria-hidden="true" tabindex="-1"></a>get_batch_results <span class="ot">&lt;-</span> <span class="cf">function</span>(batch_id){</span>
<span id="cb29-726"><a href="#cb29-726" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> <span class="fu">GET</span>(</span>
<span id="cb29-727"><a href="#cb29-727" aria-hidden="true" tabindex="-1"></a>    <span class="at">url =</span> <span class="fu">paste0</span>(<span class="st">"https://api.anthropic.com/v1/messages/batches/"</span>, batch_id, <span class="st">"/results"</span>),</span>
<span id="cb29-728"><a href="#cb29-728" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_headers</span>(</span>
<span id="cb29-729"><a href="#cb29-729" aria-hidden="true" tabindex="-1"></a>      <span class="st">"x-api-key"</span> <span class="ot">=</span> <span class="fu">Sys.getenv</span>(<span class="st">"ANTHROPIC_API_KEY"</span>),</span>
<span id="cb29-730"><a href="#cb29-730" aria-hidden="true" tabindex="-1"></a>      <span class="st">"anthropic-version"</span> <span class="ot">=</span> <span class="st">"2023-06-01"</span></span>
<span id="cb29-731"><a href="#cb29-731" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-732"><a href="#cb29-732" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-733"><a href="#cb29-733" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-734"><a href="#cb29-734" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">status_code</span>(response) <span class="sc">!=</span> <span class="dv">200</span>){</span>
<span id="cb29-735"><a href="#cb29-735" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Error retrieving results: "</span>, <span class="fu">content</span>(response, <span class="st">"text"</span>))</span>
<span id="cb29-736"><a href="#cb29-736" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-737"><a href="#cb29-737" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-738"><a href="#cb29-738" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse JSONL results</span></span>
<span id="cb29-739"><a href="#cb29-739" aria-hidden="true" tabindex="-1"></a>  results_text <span class="ot">&lt;-</span> <span class="fu">content</span>(response, <span class="st">"text"</span>, <span class="at">encoding =</span> <span class="st">"UTF-8"</span>)</span>
<span id="cb29-740"><a href="#cb29-740" aria-hidden="true" tabindex="-1"></a>  results_lines <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(results_text, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)[[<span class="dv">1</span>]]</span>
<span id="cb29-741"><a href="#cb29-741" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(results_lines[results_lines <span class="sc">!=</span> <span class="st">""</span>], fromJSON)</span>
<span id="cb29-742"><a href="#cb29-742" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-743"><a href="#cb29-743" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb29-744"><a href="#cb29-744" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-745"><a href="#cb29-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-746"><a href="#cb29-746" aria-hidden="true" tabindex="-1"></a>essay_batch_results <span class="ot">&lt;-</span> <span class="fu">get_batch_results</span>(essay_batch_info<span class="sc">$</span>id)</span>
<span id="cb29-747"><a href="#cb29-747" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(essay_batch_results, <span class="at">file =</span> <span class="st">"data/essay_batch_results.Rdata"</span>)</span>
<span id="cb29-748"><a href="#cb29-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-749"><a href="#cb29-749" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-750"><a href="#cb29-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-751"><a href="#cb29-751" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Extracting Score from Results</span></span>
<span id="cb29-752"><a href="#cb29-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-753"><a href="#cb29-753" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb29-754"><a href="#cb29-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-755"><a href="#cb29-755" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Extract scores from batch results</span></span>
<span id="cb29-756"><a href="#cb29-756" aria-hidden="true" tabindex="-1"></a>extract_batch_scores <span class="ot">&lt;-</span> <span class="cf">function</span>(results_list, <span class="at">debug =</span> <span class="cn">FALSE</span>){</span>
<span id="cb29-757"><a href="#cb29-757" aria-hidden="true" tabindex="-1"></a>  scores_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-758"><a href="#cb29-758" aria-hidden="true" tabindex="-1"></a>    <span class="at">essay_id =</span> <span class="fu">character</span>(),</span>
<span id="cb29-759"><a href="#cb29-759" aria-hidden="true" tabindex="-1"></a>    <span class="at">repetition =</span> <span class="fu">integer</span>(),</span>
<span id="cb29-760"><a href="#cb29-760" aria-hidden="true" tabindex="-1"></a>    <span class="at">content =</span> <span class="fu">numeric</span>(),</span>
<span id="cb29-761"><a href="#cb29-761" aria-hidden="true" tabindex="-1"></a>    <span class="at">organization =</span> <span class="fu">numeric</span>(),</span>
<span id="cb29-762"><a href="#cb29-762" aria-hidden="true" tabindex="-1"></a>    <span class="at">language =</span> <span class="fu">numeric</span>(),</span>
<span id="cb29-763"><a href="#cb29-763" aria-hidden="true" tabindex="-1"></a>    <span class="at">total =</span> <span class="fu">numeric</span>(),</span>
<span id="cb29-764"><a href="#cb29-764" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb29-765"><a href="#cb29-765" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-766"><a href="#cb29-766" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-767"><a href="#cb29-767" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(results_list)){</span>
<span id="cb29-768"><a href="#cb29-768" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> results_list[[i]]</span>
<span id="cb29-769"><a href="#cb29-769" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-770"><a href="#cb29-770" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(result<span class="sc">$</span>result<span class="sc">$</span>type <span class="sc">==</span> <span class="st">"succeeded"</span>){</span>
<span id="cb29-771"><a href="#cb29-771" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Extract the response text - handle different possible structures</span></span>
<span id="cb29-772"><a href="#cb29-772" aria-hidden="true" tabindex="-1"></a>      message_content <span class="ot">&lt;-</span> result<span class="sc">$</span>result<span class="sc">$</span>message<span class="sc">$</span>content</span>
<span id="cb29-773"><a href="#cb29-773" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-774"><a href="#cb29-774" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Debug: Print structure if requested</span></span>
<span id="cb29-775"><a href="#cb29-775" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(debug <span class="sc">&amp;&amp;</span> i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb29-776"><a href="#cb29-776" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"=== DEBUG: First result structure ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-777"><a href="#cb29-777" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Content class:"</span>, <span class="fu">class</span>(message_content), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-778"><a href="#cb29-778" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Content length:"</span>, <span class="fu">length</span>(message_content), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-779"><a href="#cb29-779" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is.list</span>(message_content) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(message_content) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb29-780"><a href="#cb29-780" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"First element class:"</span>, <span class="fu">class</span>(message_content[[<span class="dv">1</span>]]), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-781"><a href="#cb29-781" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(<span class="fu">str</span>(message_content[[<span class="dv">1</span>]]))</span>
<span id="cb29-782"><a href="#cb29-782" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb29-783"><a href="#cb29-783" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb29-784"><a href="#cb29-784" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-785"><a href="#cb29-785" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Extract text from various possible structures</span></span>
<span id="cb29-786"><a href="#cb29-786" aria-hidden="true" tabindex="-1"></a>      response_text <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb29-787"><a href="#cb29-787" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-788"><a href="#cb29-788" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.data.frame</span>(message_content)){</span>
<span id="cb29-789"><a href="#cb29-789" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If it's a data frame, look for a 'text' column</span></span>
<span id="cb29-790"><a href="#cb29-790" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="st">"text"</span> <span class="sc">%in%</span> <span class="fu">names</span>(message_content)){</span>
<span id="cb29-791"><a href="#cb29-791" aria-hidden="true" tabindex="-1"></a>          response_text <span class="ot">&lt;-</span> message_content<span class="sc">$</span>text[<span class="dv">1</span>]</span>
<span id="cb29-792"><a href="#cb29-792" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb29-793"><a href="#cb29-793" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is.list</span>(message_content) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(message_content) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb29-794"><a href="#cb29-794" aria-hidden="true" tabindex="-1"></a>        first_elem <span class="ot">&lt;-</span> message_content[[<span class="dv">1</span>]]</span>
<span id="cb29-795"><a href="#cb29-795" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb29-796"><a href="#cb29-796" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is.list</span>(first_elem)){</span>
<span id="cb29-797"><a href="#cb29-797" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Check for $text field</span></span>
<span id="cb29-798"><a href="#cb29-798" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(first_elem<span class="sc">$</span>text)){</span>
<span id="cb29-799"><a href="#cb29-799" aria-hidden="true" tabindex="-1"></a>            response_text <span class="ot">&lt;-</span> first_elem<span class="sc">$</span>text</span>
<span id="cb29-800"><a href="#cb29-800" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(first_elem<span class="sc">$</span>type) <span class="sc">&amp;&amp;</span> first_elem<span class="sc">$</span>type <span class="sc">==</span> <span class="st">"text"</span> <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(first_elem<span class="sc">$</span>text)){</span>
<span id="cb29-801"><a href="#cb29-801" aria-hidden="true" tabindex="-1"></a>            response_text <span class="ot">&lt;-</span> first_elem<span class="sc">$</span>text</span>
<span id="cb29-802"><a href="#cb29-802" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb29-803"><a href="#cb29-803" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is.character</span>(first_elem)){</span>
<span id="cb29-804"><a href="#cb29-804" aria-hidden="true" tabindex="-1"></a>          response_text <span class="ot">&lt;-</span> first_elem</span>
<span id="cb29-805"><a href="#cb29-805" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb29-806"><a href="#cb29-806" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is.character</span>(message_content)){</span>
<span id="cb29-807"><a href="#cb29-807" aria-hidden="true" tabindex="-1"></a>        response_text <span class="ot">&lt;-</span> message_content</span>
<span id="cb29-808"><a href="#cb29-808" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb29-809"><a href="#cb29-809" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-810"><a href="#cb29-810" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If we still don't have text, try to extract it more aggressively</span></span>
<span id="cb29-811"><a href="#cb29-811" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.null</span>(response_text) <span class="sc">||</span> <span class="fu">length</span>(response_text) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb29-812"><a href="#cb29-812" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try to find any 'text' field in the structure</span></span>
<span id="cb29-813"><a href="#cb29-813" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is.list</span>(message_content)){</span>
<span id="cb29-814"><a href="#cb29-814" aria-hidden="true" tabindex="-1"></a>          text_fields <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(message_content, <span class="cf">function</span>(x) {</span>
<span id="cb29-815"><a href="#cb29-815" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">is.list</span>(x) <span class="sc">&amp;&amp;</span> <span class="st">"text"</span> <span class="sc">%in%</span> <span class="fu">names</span>(x)) x<span class="sc">$</span>text <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb29-816"><a href="#cb29-816" aria-hidden="true" tabindex="-1"></a>          }))</span>
<span id="cb29-817"><a href="#cb29-817" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">length</span>(text_fields) <span class="sc">&gt;</span> <span class="dv">0</span>) response_text <span class="ot">&lt;-</span> text_fields[<span class="dv">1</span>]</span>
<span id="cb29-818"><a href="#cb29-818" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb29-819"><a href="#cb29-819" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb29-820"><a href="#cb29-820" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-821"><a href="#cb29-821" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.null</span>(response_text) <span class="sc">||</span> <span class="fu">length</span>(response_text) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb29-822"><a href="#cb29-822" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">"Could not extract text for "</span>, result<span class="sc">$</span>custom_id)</span>
<span id="cb29-823"><a href="#cb29-823" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(debug){</span>
<span id="cb29-824"><a href="#cb29-824" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"=== Full structure for "</span>, result<span class="sc">$</span>custom_id, <span class="st">" ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-825"><a href="#cb29-825" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(<span class="fu">str</span>(message_content))</span>
<span id="cb29-826"><a href="#cb29-826" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb29-827"><a href="#cb29-827" aria-hidden="true" tabindex="-1"></a>        <span class="cf">next</span></span>
<span id="cb29-828"><a href="#cb29-828" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb29-829"><a href="#cb29-829" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-830"><a href="#cb29-830" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Debug: Print first response text</span></span>
<span id="cb29-831"><a href="#cb29-831" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(debug <span class="sc">&amp;&amp;</span> i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb29-832"><a href="#cb29-832" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== First response text (first 500 chars) ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-833"><a href="#cb29-833" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">substr</span>(response_text, <span class="dv">1</span>, <span class="dv">500</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb29-834"><a href="#cb29-834" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb29-835"><a href="#cb29-835" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-836"><a href="#cb29-836" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Extract scores using our previous function</span></span>
<span id="cb29-837"><a href="#cb29-837" aria-hidden="true" tabindex="-1"></a>      scores <span class="ot">&lt;-</span> <span class="fu">extract_scores</span>(response_text, <span class="at">debug =</span> debug <span class="sc">&amp;&amp;</span> i <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb29-838"><a href="#cb29-838" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-839"><a href="#cb29-839" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Debug: Check if scores were extracted</span></span>
<span id="cb29-840"><a href="#cb29-840" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(debug <span class="sc">&amp;&amp;</span> i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb29-841"><a href="#cb29-841" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"=== Extracted scores ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-842"><a href="#cb29-842" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(scores)</span>
<span id="cb29-843"><a href="#cb29-843" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb29-844"><a href="#cb29-844" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-845"><a href="#cb29-845" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Parse custom_id to extract essay_id and repetition</span></span>
<span id="cb29-846"><a href="#cb29-846" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Format: essay_2001_rep_1</span></span>
<span id="cb29-847"><a href="#cb29-847" aria-hidden="true" tabindex="-1"></a>      custom_id_parts <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(result<span class="sc">$</span>custom_id, <span class="st">"_"</span>)[[<span class="dv">1</span>]]</span>
<span id="cb29-848"><a href="#cb29-848" aria-hidden="true" tabindex="-1"></a>      essay_id <span class="ot">&lt;-</span> custom_id_parts[<span class="dv">2</span>]</span>
<span id="cb29-849"><a href="#cb29-849" aria-hidden="true" tabindex="-1"></a>      repetition <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(custom_id_parts[<span class="dv">4</span>])</span>
<span id="cb29-850"><a href="#cb29-850" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-851"><a href="#cb29-851" aria-hidden="true" tabindex="-1"></a>      scores_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(scores_df, <span class="fu">data.frame</span>(</span>
<span id="cb29-852"><a href="#cb29-852" aria-hidden="true" tabindex="-1"></a>        <span class="at">essay_id =</span> essay_id,</span>
<span id="cb29-853"><a href="#cb29-853" aria-hidden="true" tabindex="-1"></a>        <span class="at">repetition =</span> repetition,</span>
<span id="cb29-854"><a href="#cb29-854" aria-hidden="true" tabindex="-1"></a>        <span class="at">content =</span> scores[<span class="st">"content"</span>],</span>
<span id="cb29-855"><a href="#cb29-855" aria-hidden="true" tabindex="-1"></a>        <span class="at">organization =</span> scores[<span class="st">"organization"</span>],</span>
<span id="cb29-856"><a href="#cb29-856" aria-hidden="true" tabindex="-1"></a>        <span class="at">language =</span> scores[<span class="st">"language"</span>],</span>
<span id="cb29-857"><a href="#cb29-857" aria-hidden="true" tabindex="-1"></a>        <span class="at">total =</span> scores[<span class="st">"total"</span>]</span>
<span id="cb29-858"><a href="#cb29-858" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb29-859"><a href="#cb29-859" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb29-860"><a href="#cb29-860" aria-hidden="true" tabindex="-1"></a>      <span class="fu">warning</span>(<span class="st">"Request "</span>, result<span class="sc">$</span>custom_id, <span class="st">" failed: "</span>, result<span class="sc">$</span>result<span class="sc">$</span>error<span class="sc">$</span>message)</span>
<span id="cb29-861"><a href="#cb29-861" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-862"><a href="#cb29-862" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-863"><a href="#cb29-863" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-864"><a href="#cb29-864" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(scores_df)</span>
<span id="cb29-865"><a href="#cb29-865" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-866"><a href="#cb29-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-867"><a href="#cb29-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-868"><a href="#cb29-868" aria-hidden="true" tabindex="-1"></a>essay_batch_df <span class="ot">&lt;-</span> <span class="fu">extract_batch_scores</span>(essay_batch_results, <span class="at">debug =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-869"><a href="#cb29-869" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(essay_batch_df, <span class="at">file =</span> <span class="st">'data/essay_batch_df.Rdata'</span>)</span>
<span id="cb29-870"><a href="#cb29-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-871"><a href="#cb29-871" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-874"><a href="#cb29-874" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-875"><a href="#cb29-875" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb29-876"><a href="#cb29-876" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb29-877"><a href="#cb29-877" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">'data/essay_batch_df.Rdata'</span>)</span>
<span id="cb29-878"><a href="#cb29-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-879"><a href="#cb29-879" aria-hidden="true" tabindex="-1"></a>essay_summary_detailed <span class="ot">&lt;-</span> essay_batch_df <span class="sc">%&gt;%</span></span>
<span id="cb29-880"><a href="#cb29-880" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(essay_id) <span class="sc">%&gt;%</span></span>
<span id="cb29-881"><a href="#cb29-881" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb29-882"><a href="#cb29-882" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb29-883"><a href="#cb29-883" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Content</span></span>
<span id="cb29-884"><a href="#cb29-884" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_mean =</span> <span class="fu">mean</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-885"><a href="#cb29-885" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_sd =</span> <span class="fu">sd</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-886"><a href="#cb29-886" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_min =</span> <span class="fu">min</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-887"><a href="#cb29-887" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_max =</span> <span class="fu">max</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-888"><a href="#cb29-888" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Organization</span></span>
<span id="cb29-889"><a href="#cb29-889" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_mean =</span> <span class="fu">mean</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-890"><a href="#cb29-890" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_sd =</span> <span class="fu">sd</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-891"><a href="#cb29-891" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_min =</span> <span class="fu">min</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-892"><a href="#cb29-892" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_max =</span> <span class="fu">max</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-893"><a href="#cb29-893" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Language</span></span>
<span id="cb29-894"><a href="#cb29-894" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_mean =</span> <span class="fu">mean</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-895"><a href="#cb29-895" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_sd =</span> <span class="fu">sd</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-896"><a href="#cb29-896" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_min =</span> <span class="fu">min</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-897"><a href="#cb29-897" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_max =</span> <span class="fu">max</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-898"><a href="#cb29-898" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total</span></span>
<span id="cb29-899"><a href="#cb29-899" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_mean =</span> <span class="fu">mean</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-900"><a href="#cb29-900" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_sd =</span> <span class="fu">sd</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-901"><a href="#cb29-901" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_min =</span> <span class="fu">min</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-902"><a href="#cb29-902" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_max =</span> <span class="fu">max</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-903"><a href="#cb29-903" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb29-904"><a href="#cb29-904" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(total_mean)</span>
<span id="cb29-905"><a href="#cb29-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-906"><a href="#cb29-906" aria-hidden="true" tabindex="-1"></a>essay_summary_detailed <span class="ot">&lt;-</span> essay_summary_detailed <span class="sc">%&gt;%</span></span>
<span id="cb29-907"><a href="#cb29-907" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">round</span>(.x, <span class="dv">2</span>)))</span>
<span id="cb29-908"><a href="#cb29-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-909"><a href="#cb29-909" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(essay_summary_detailed, </span>
<span id="cb29-910"><a href="#cb29-910" aria-hidden="true" tabindex="-1"></a>          <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>, <span class="at">scrollX =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-911"><a href="#cb29-911" aria-hidden="true" tabindex="-1"></a>          <span class="at">caption =</span> <span class="st">"Summary Statistics by Essay (20 repetitions each)"</span>)</span>
<span id="cb29-912"><a href="#cb29-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-913"><a href="#cb29-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-914"><a href="#cb29-914" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-915"><a href="#cb29-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-916"><a href="#cb29-916" aria-hidden="true" tabindex="-1"></a>So we did see some variation, but I also used the default temperature. </span>
<span id="cb29-917"><a href="#cb29-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-918"><a href="#cb29-918" aria-hidden="true" tabindex="-1"></a><span class="fu">### Batch Scoring (`Temp = 0`)</span></span>
<span id="cb29-919"><a href="#cb29-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-920"><a href="#cb29-920" aria-hidden="true" tabindex="-1"></a>Let's redo the batch call with <span class="in">`temperature = 0`</span>. </span>
<span id="cb29-921"><a href="#cb29-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-922"><a href="#cb29-922" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb29-923"><a href="#cb29-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-924"><a href="#cb29-924" aria-hidden="true" tabindex="-1"></a>create_lowtemp_requests <span class="ot">&lt;-</span> <span class="cf">function</span>(essays_df, <span class="at">n_repetitions =</span> <span class="dv">20</span>){</span>
<span id="cb29-925"><a href="#cb29-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-926"><a href="#cb29-926" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a list to store batch requests</span></span>
<span id="cb29-927"><a href="#cb29-927" aria-hidden="true" tabindex="-1"></a>  batch_requests <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb29-928"><a href="#cb29-928" aria-hidden="true" tabindex="-1"></a>  request_counter <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb29-929"><a href="#cb29-929" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-930"><a href="#cb29-930" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create n_repetitions requests for each essay (grouped by essay)</span></span>
<span id="cb29-931"><a href="#cb29-931" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(essays_df)){</span>
<span id="cb29-932"><a href="#cb29-932" aria-hidden="true" tabindex="-1"></a>    essay_prompt <span class="ot">&lt;-</span> <span class="fu">claude_all_rubric_prompt</span>(essays_df<span class="sc">$</span>prompt[i], essays_df<span class="sc">$</span>essay[i])</span>
<span id="cb29-933"><a href="#cb29-933" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-934"><a href="#cb29-934" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create 20 requests for this essay</span></span>
<span id="cb29-935"><a href="#cb29-935" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(rep <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_repetitions){</span>
<span id="cb29-936"><a href="#cb29-936" aria-hidden="true" tabindex="-1"></a>      request <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb29-937"><a href="#cb29-937" aria-hidden="true" tabindex="-1"></a>        <span class="at">custom_id =</span> <span class="fu">paste0</span>(<span class="st">"essay_"</span>, essays_df<span class="sc">$</span>id[i], <span class="st">"_rep_"</span>, rep),</span>
<span id="cb29-938"><a href="#cb29-938" aria-hidden="true" tabindex="-1"></a>        <span class="at">params =</span> <span class="fu">list</span>(</span>
<span id="cb29-939"><a href="#cb29-939" aria-hidden="true" tabindex="-1"></a>          <span class="at">model =</span> <span class="st">"claude-sonnet-4-20250514"</span>,</span>
<span id="cb29-940"><a href="#cb29-940" aria-hidden="true" tabindex="-1"></a>          <span class="at">max_tokens =</span> <span class="dv">1024</span>,</span>
<span id="cb29-941"><a href="#cb29-941" aria-hidden="true" tabindex="-1"></a>          <span class="at">temperature =</span> <span class="dv">0</span>, <span class="co"># added low temp</span></span>
<span id="cb29-942"><a href="#cb29-942" aria-hidden="true" tabindex="-1"></a>          <span class="at">messages =</span> <span class="fu">list</span>(</span>
<span id="cb29-943"><a href="#cb29-943" aria-hidden="true" tabindex="-1"></a>            <span class="fu">list</span>(</span>
<span id="cb29-944"><a href="#cb29-944" aria-hidden="true" tabindex="-1"></a>              <span class="at">role =</span> <span class="st">"user"</span>,</span>
<span id="cb29-945"><a href="#cb29-945" aria-hidden="true" tabindex="-1"></a>              <span class="at">content =</span> essay_prompt</span>
<span id="cb29-946"><a href="#cb29-946" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb29-947"><a href="#cb29-947" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb29-948"><a href="#cb29-948" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-949"><a href="#cb29-949" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb29-950"><a href="#cb29-950" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-951"><a href="#cb29-951" aria-hidden="true" tabindex="-1"></a>      batch_requests[[request_counter]] <span class="ot">&lt;-</span> request</span>
<span id="cb29-952"><a href="#cb29-952" aria-hidden="true" tabindex="-1"></a>      request_counter <span class="ot">&lt;-</span> request_counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb29-953"><a href="#cb29-953" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-954"><a href="#cb29-954" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-955"><a href="#cb29-955" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-956"><a href="#cb29-956" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Created"</span>, <span class="fu">length</span>(batch_requests), <span class="st">"batch requests for"</span>, <span class="fu">nrow</span>(essays_df), <span class="st">"essays</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-957"><a href="#cb29-957" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-958"><a href="#cb29-958" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(batch_requests)</span>
<span id="cb29-959"><a href="#cb29-959" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-960"><a href="#cb29-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-961"><a href="#cb29-961" aria-hidden="true" tabindex="-1"></a>lowtemp_batch_requests <span class="ot">&lt;-</span> <span class="fu">create_lowtemp_requests</span>(student_essays)</span>
<span id="cb29-962"><a href="#cb29-962" aria-hidden="true" tabindex="-1"></a>lowtemp_batch_jsonl <span class="ot">&lt;-</span> <span class="fu">write_batch_file</span>(lowtemp_batch_requests)</span>
<span id="cb29-963"><a href="#cb29-963" aria-hidden="true" tabindex="-1"></a>lowtemp_batch_info <span class="ot">&lt;-</span> <span class="fu">submit_batch</span>(lowtemp_batch_jsonl)</span>
<span id="cb29-964"><a href="#cb29-964" aria-hidden="true" tabindex="-1"></a><span class="co"># Batch submitted successfully!</span></span>
<span id="cb29-965"><a href="#cb29-965" aria-hidden="true" tabindex="-1"></a><span class="co"># Batch ID: msgbatch_0184nJ7Kui9v6WVVh47939mn </span></span>
<span id="cb29-966"><a href="#cb29-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-967"><a href="#cb29-967" aria-hidden="true" tabindex="-1"></a>lowtemp_status <span class="ot">&lt;-</span> <span class="fu">check_batch_status</span>(lowtemp_batch_info<span class="sc">$</span>id)</span>
<span id="cb29-968"><a href="#cb29-968" aria-hidden="true" tabindex="-1"></a>lowtemp_start_time <span class="ot">&lt;-</span> <span class="fu">ymd_hms</span>(lowtemp_status<span class="sc">$</span>created_at)</span>
<span id="cb29-969"><a href="#cb29-969" aria-hidden="true" tabindex="-1"></a>lowtemp_stop_time <span class="ot">&lt;-</span> <span class="fu">ymd_hms</span>(lowtemp_status<span class="sc">$</span>ended_at)</span>
<span id="cb29-970"><a href="#cb29-970" aria-hidden="true" tabindex="-1"></a>lowtemp_run_time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(lowtemp_stop_time <span class="sc">-</span> lowtemp_start_time)</span>
<span id="cb29-971"><a href="#cb29-971" aria-hidden="true" tabindex="-1"></a><span class="co"># Time difference of 1.473892 mins</span></span>
<span id="cb29-972"><a href="#cb29-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-973"><a href="#cb29-973" aria-hidden="true" tabindex="-1"></a>lowtemp_batch_results <span class="ot">&lt;-</span> <span class="fu">get_batch_results</span>(lowtemp_batch_info<span class="sc">$</span>id)</span>
<span id="cb29-974"><a href="#cb29-974" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(lowtemp_batch_results, <span class="at">file =</span> <span class="st">"data/lowtemp_batch_results.Rdata"</span>)</span>
<span id="cb29-975"><a href="#cb29-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-976"><a href="#cb29-976" aria-hidden="true" tabindex="-1"></a>lowtemp_batch_df <span class="ot">&lt;-</span> <span class="fu">extract_batch_scores</span>(lowtemp_batch_results)</span>
<span id="cb29-977"><a href="#cb29-977" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(lowtemp_batch_df, <span class="at">file =</span> <span class="st">'data/lowtemp_batch_df.Rdata'</span>)</span>
<span id="cb29-978"><a href="#cb29-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-979"><a href="#cb29-979" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-982"><a href="#cb29-982" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-983"><a href="#cb29-983" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">'data/lowtemp_batch_df.Rdata'</span>)</span>
<span id="cb29-984"><a href="#cb29-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-985"><a href="#cb29-985" aria-hidden="true" tabindex="-1"></a>lowtemp_summary_detailed <span class="ot">&lt;-</span> lowtemp_batch_df <span class="sc">%&gt;%</span></span>
<span id="cb29-986"><a href="#cb29-986" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(essay_id) <span class="sc">%&gt;%</span></span>
<span id="cb29-987"><a href="#cb29-987" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb29-988"><a href="#cb29-988" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb29-989"><a href="#cb29-989" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Content</span></span>
<span id="cb29-990"><a href="#cb29-990" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_mean =</span> <span class="fu">mean</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-991"><a href="#cb29-991" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_sd =</span> <span class="fu">sd</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-992"><a href="#cb29-992" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_min =</span> <span class="fu">min</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-993"><a href="#cb29-993" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_max =</span> <span class="fu">max</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-994"><a href="#cb29-994" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Organization</span></span>
<span id="cb29-995"><a href="#cb29-995" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_mean =</span> <span class="fu">mean</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-996"><a href="#cb29-996" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_sd =</span> <span class="fu">sd</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-997"><a href="#cb29-997" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_min =</span> <span class="fu">min</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-998"><a href="#cb29-998" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_max =</span> <span class="fu">max</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-999"><a href="#cb29-999" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Language</span></span>
<span id="cb29-1000"><a href="#cb29-1000" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_mean =</span> <span class="fu">mean</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-1001"><a href="#cb29-1001" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_sd =</span> <span class="fu">sd</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-1002"><a href="#cb29-1002" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_min =</span> <span class="fu">min</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-1003"><a href="#cb29-1003" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_max =</span> <span class="fu">max</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-1004"><a href="#cb29-1004" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total</span></span>
<span id="cb29-1005"><a href="#cb29-1005" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_mean =</span> <span class="fu">mean</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-1006"><a href="#cb29-1006" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_sd =</span> <span class="fu">sd</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-1007"><a href="#cb29-1007" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_min =</span> <span class="fu">min</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-1008"><a href="#cb29-1008" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_max =</span> <span class="fu">max</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-1009"><a href="#cb29-1009" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb29-1010"><a href="#cb29-1010" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(total_mean)</span>
<span id="cb29-1011"><a href="#cb29-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-1012"><a href="#cb29-1012" aria-hidden="true" tabindex="-1"></a>lowtemp_summary_detailed <span class="ot">&lt;-</span> lowtemp_summary_detailed <span class="sc">%&gt;%</span></span>
<span id="cb29-1013"><a href="#cb29-1013" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">round</span>(.x, <span class="dv">2</span>)))</span>
<span id="cb29-1014"><a href="#cb29-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-1015"><a href="#cb29-1015" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(lowtemp_summary_detailed, </span>
<span id="cb29-1016"><a href="#cb29-1016" aria-hidden="true" tabindex="-1"></a>          <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>, <span class="at">scrollX =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-1017"><a href="#cb29-1017" aria-hidden="true" tabindex="-1"></a>          <span class="at">caption =</span> <span class="st">"Summary Statistics by Essay (20 repetitions each) - Temperature = 0"</span>)</span>
<span id="cb29-1018"><a href="#cb29-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-1019"><a href="#cb29-1019" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-1020"><a href="#cb29-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-1021"><a href="#cb29-1021" aria-hidden="true" tabindex="-1"></a>Now we're seeing more consistent scores, and it took _less than 90 seconds_ to process all 200 requests.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>This workshop was developed by Christopher Runyon.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


</body></html>