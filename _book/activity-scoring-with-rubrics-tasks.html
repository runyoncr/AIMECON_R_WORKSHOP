<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Activity: Scoring with Rubrics – Integrating Generative AI into R Workflows: From APIs to Shiny Apps</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./05-shiny-integration.html" rel="next">
<link href="./activity-scoring-with-rubrics-intro.html" rel="prev">
<link href="./therefore.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-23878c111f7dac4fb735463ab16209b4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="site_libs/datatables-binding-0.34.0/datatables.js"></script><script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script><link href="site_libs/crosstalk-1.2.2/css/crosstalk.min.css" rel="stylesheet">
<script src="site_libs/crosstalk-1.2.2/js/crosstalk.min.js"></script><link rel="stylesheet" href="style.css">
</head>
<body class="nav-sidebar floating fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./activity-scoring-with-rubrics-tasks.html">Activity: Scoring with Rubrics</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Integrating Generative AI into R Workflows: From APIs to Shiny Apps</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00a-R-setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R Setup</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00b-R-packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">R Packages</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00c-test-connect.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Testing API Connection</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./03-api-implementation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">API Implementation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03a-api-keys.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">API Keys</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03b-prompting-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Prompting LLMs via API</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./01-gen-ai-fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generative AI Fundamentals</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01a-gen-ai-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Foundational Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01b-gen-ai-parameters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Generation Parameters</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./activity-parameter-testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Activity: Generation Parameter Testing</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./02-prompt-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prompt Engineering</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02a-general-prompt-information.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">General Prompt Engineering</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02b-prompt-formulas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Example Prompt Formulas</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02c-chained-workflows.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chained Workflows</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./activity-prompt-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Activity: Prompt Engineering</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./04-integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Integrating LLMs into R Workflows</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04a-single-interactions-via-api.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Single Interactions via API</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04b-conversations-via-api.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Chat Conversations via API</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04c-rag-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Retrieval Augmented Generation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04d-batch-processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Batch Processing</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./activity-content-development-revision.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activity: Content Development and Revision</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./activity-scoring-with-rubrics-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction: Scoring with Rubrics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./activity-scoring-with-rubrics-tasks.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Activity: Scoring with Rubrics</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./05-shiny-integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Shiny Integration</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05a-shiny.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Shiny</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05b-vibe-coding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">“Vibe Coding”</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./activity-shiny-app-development.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activity: Shiny App Development</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-reference-materials.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reference Materials</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-acknowledgements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acknowledgements</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-act-rubric-task" class="quarto-section-identifier">Activity: Scoring with Rubrics</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="task-med-ed-using-llms-to-apply-analytic-rubrics" class="level2"><h2 class="anchored" data-anchor-id="task-med-ed-using-llms-to-apply-analytic-rubrics">Task: Med Ed: Using LLMs to Apply Analytic Rubrics</h2>
</section><section id="task-med-ed-using-llms-to-apply-holistic-rubrics" class="level2"><h2 class="anchored" data-anchor-id="task-med-ed-using-llms-to-apply-holistic-rubrics">Task: Med Ed: Using LLMs to Apply Holistic Rubrics</h2>
</section><section id="task-using-llms-to-apply-holistic-rubrics" class="level2"><h2 class="anchored" data-anchor-id="task-using-llms-to-apply-holistic-rubrics">Task: Using LLMs to Apply Holistic Rubrics</h2>
<p>Many attending AIME-CON are working in non-medical educational settings, so I wanted to develop a different example that may be more applicable to the work that you’re doing. For this example I’m going to use the rubric that was part of the <a href="https://haneul-yoo.github.io/dress/"><code>Dataset for Rubric-based Essay Scoring (DREsS)</code></a>. This rubric was based on scoring essays from English as a foreign language (EFL) learners. The essays in that dataset are scored on a range from 1 to 5 with increments of 0.5. The full dataset is available after filling out a <a href="https://docs.google.com/forms/d/e/1FAIpQLSdqlywEiCl5Ddei7T7ujMBpMHFDLRyW7OBo033e_Oe-amGqmQ/viewform">consent form</a>.</p>
<p>The rubric has 3 components:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 5%">
<col style="width: 94%">
</colgroup>
<thead><tr class="header">
<th><strong>Criteria</strong></th>
<th><strong>Description</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Content</td>
<td>Paragraph is well-developed and relevant to the argument, supported with strong reasons and examples.</td>
</tr>
<tr class="even">
<td>Organization</td>
<td>The argument is very effectively structured and developed, making it easy for the reader to follow the ideas and understand how the writer is building the argument. Paragraphs use coherence devices effectively while focusing on a single main idea.</td>
</tr>
<tr class="odd">
<td>Language</td>
<td>The writing displays sophisticated control of a wide range of vocabulary and collocations. The essay follows grammar and usage rules throughout the paper. Spelling and punctuation are correct throughout the paper.</td>
</tr>
</tbody>
</table>
<p>One of the prompts in the data is: “Do you think that smartphones have destroyed communication among family and friends? Give specific reasons and details to support your opinion.”</p>
<p>To ensure that I’m compliant with the consent form agreement, I will be using synthetic responses generated (using Claude Sonnet 4.5) based observed student responses. We’ll also be using the <a href="@sec-claude-plus"><code>claude_plus</code> function we used in the parameter testing activity</a>.</p>
<section id="first-model-call" class="level3"><h3 class="anchored" data-anchor-id="first-model-call">First Model Call</h3>
<p>Let’s start by asking the model to apply the rubric to an essay. We’ll use the default parameters for this first</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">'downloads/claude_plus.R'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">'data/student_essays.Rdata'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">focal_student</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">student_essays</span>, <span class="va">id</span> <span class="op">==</span> <span class="fl">2002</span><span class="op">)</span></span>
<span><span class="va">focal_prompt</span> <span class="op">&lt;-</span> <span class="va">focal_student</span><span class="op">$</span><span class="va">prompt</span></span>
<span><span class="va">focal_essay</span> <span class="op">&lt;-</span> <span class="va">focal_student</span><span class="op">$</span><span class="va">essay</span></span>
<span></span>
<span><span class="co"># Building a function to generate the prompt.</span></span>
<span></span>
<span><span class="va">all_rubric_prompt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prompt</span>, <span class="va">essay</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">You are an expert essay grader. Score the following student essay based on three criteria: Content, Organization, and Language. Each criterion should be scored from 1 to 5 in increments of 0.5 (e.g., 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5).</span></span>
<span><span class="st"></span></span>
<span><span class="st">RUBRIC:</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Content (1-5):**</span></span>
<span><span class="st">Paragraph is well-developed and relevant to the argument, supported with strong reasons and examples.</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Organization (1-5):**</span></span>
<span><span class="st">The argument is very effectively structured and developed, making it easy for the reader to follow the ideas and understand how the writer is building the argument. Paragraphs use coherence devices effectively while focusing on a single main idea.</span></span>
<span><span class="st"> </span></span>
<span><span class="st">**Language (1-5):**</span></span>
<span><span class="st">The writing displays sophisticated control of a wide range of vocabulary and collocations. The essay follows grammar and usage rules throughout the paper. Spelling and punctuation are correct throughout the paper.</span></span>
<span><span class="st"></span></span>
<span><span class="st">PROMPT: {prompt}</span></span>
<span><span class="st"></span></span>
<span><span class="st">ESSAY: {essay}</span></span>
<span><span class="st"></span></span>
<span><span class="st">Please provide scores for each criterion and calculate the total score. Format your response as follows:</span></span>
<span><span class="st">Content: [score]</span></span>
<span><span class="st">Organization: [score]</span></span>
<span><span class="st">Language: [score]</span></span>
<span><span class="st">Total: [sum of three scores]</span></span>
<span><span class="st"></span></span>
<span><span class="st">Provide a brief justification (1-2 sentences) for each score.</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">one_rep_essay</span> <span class="op">&lt;-</span> <span class="fu">claude_plus</span><span class="op">(</span>prompt <span class="op">=</span> <span class="fu">all_rubric_prompt</span><span class="op">(</span><span class="va">focal_prompt</span>, <span class="va">focal_essay</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">one_rep_essay</span>, file <span class="op">=</span> <span class="st">'data/one_rep_essay.Rdata'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Claude’s essay evaluation:</p>
<p>Essay Evaluation</p>
<p><strong>Content: 3/5</strong> The essay presents a balanced view with relevant examples (grandmother video calls, phone distraction), but the development is superficial. The argument lacks depth, multiple examples, and detailed elaboration that would make it well-developed and strongly supported.</p>
<p><strong>Organization: 3.5/5</strong> The essay follows a clear structure (introducing both sides, personal example, counterpoint, conclusion) and is easy to follow. However, it’s quite brief and would benefit from additional paragraphs to fully develop each main idea separately rather than condensing everything into one paragraph.</p>
<p><strong>Language: 3.5/5</strong> The writing demonstrates good control of grammar and vocabulary with no significant errors ("on one hand/on the other hand," "responsibly"). However, the vocabulary range is relatively basic and lacks the sophistication and variety expected for a top score.</p>
<p><strong>Total: 10/15</strong></p>
<p>As noted in the previously (in WHAT section), part of the beauty of generative AI model is the variability in output. Great for creative tasks, but not optimal for things like the present task of applying a scoring rubric to a student response.</p>
</section><section id="repeating-score-task" class="level3"><h3 class="anchored" data-anchor-id="repeating-score-task">Repeating Score Task</h3>
<p>Let’s repeat the above process 20 times, extracting the scores after each model response.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Function to extract scores</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/">httr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jeroen.r-universe.dev/jsonlite">jsonlite</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://glue.tidyverse.org/">glue</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set your Anthropic API key</span></span>
<span><span class="va">ANTHROPIC_API_KEY</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"ANTHROPIC_API_KEY"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the prompt function (from previous artifact)</span></span>
<span><span class="va">all_rubric_prompt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prompt</span>, <span class="va">essay</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">You are an expert essay grader. Score the following student essay based on three criteria: Content, Organization, and Language. Each criterion should be scored from 1 to 5 in increments of 0.5.</span></span>
<span><span class="st"></span></span>
<span><span class="st">RUBRIC:</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Content (1-5):**</span></span>
<span><span class="st">- 5: Exceptionally well-developed and highly relevant, with strong reasons and compelling examples.</span></span>
<span><span class="st">- 4: Well-developed and relevant, with clear reasons and good examples.</span></span>
<span><span class="st">- 3: Adequately developed with acceptable reasons and examples.</span></span>
<span><span class="st">- 2: Underdeveloped with weak or insufficient reasons and examples.</span></span>
<span><span class="st">- 1: Poorly developed and largely irrelevant.</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Organization (1-5):**</span></span>
<span><span class="st">- 5: Exceptionally well-structured, very easy to follow, expert use of coherence devices.</span></span>
<span><span class="st">- 4: Effectively structured, easy to follow, good use of coherence devices.</span></span>
<span><span class="st">- 3: Adequate structure, generally followable.</span></span>
<span><span class="st">- 2: Weak structure, sometimes difficult to follow.</span></span>
<span><span class="st">- 1: Lacks clear structure, confusing.</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Language (1-5):**</span></span>
<span><span class="st">- 5: Sophisticated vocabulary, grammar and spelling correct throughout.</span></span>
<span><span class="st">- 4: Good vocabulary control, generally correct with minor errors.</span></span>
<span><span class="st">- 3: Adequate vocabulary, acceptable with some errors.</span></span>
<span><span class="st">- 2: Limited vocabulary, frequent errors that sometimes impede understanding.</span></span>
<span><span class="st">- 1: Very limited vocabulary, numerous errors.</span></span>
<span><span class="st"></span></span>
<span><span class="st">PROMPT: {prompt}</span></span>
<span><span class="st"></span></span>
<span><span class="st">ESSAY: {essay}</span></span>
<span><span class="st"></span></span>
<span><span class="st">Format your response as:</span></span>
<span><span class="st">Content: [score]</span></span>
<span><span class="st">Organization: [score]</span></span>
<span><span class="st">Language: [score]</span></span>
<span><span class="st">Total: [sum of three scores]</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Score extraction function with debug capability</span></span>
<span><span class="va">extract_scores</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">gpt_output</span>, <span class="va">debug</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">debug</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== DEBUG: Extracting scores ===\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Input text (first 300 chars):\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="fl">1</span>, <span class="fl">300</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Extract Content score - try multiple patterns</span></span>
<span>  <span class="va">content_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"Content:?\\s*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">content_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Try alternate pattern</span></span>
<span>    <span class="va">content_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"\\*\\*Content:?\\*\\*[^0-9]*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">content</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">content_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Extract Organization score</span></span>
<span>  <span class="va">org_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"Organization:?\\s*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">org_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">org_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"\\*\\*Organization:?\\*\\*[^0-9]*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">organization</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">org_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Extract Language score</span></span>
<span>  <span class="va">lang_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"Language:?\\s*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">lang_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">lang_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"\\*\\*Language:?\\*\\*[^0-9]*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">language</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">lang_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Extract Total score</span></span>
<span>  <span class="va">total_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"Total:?\\s*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">total_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">total_match</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">gpt_output</span>, <span class="st">"\\*\\*Total:?\\*\\*[^0-9]*([0-9.]+)"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">total_match</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">debug</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Extracted values:\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Content:"</span>, <span class="va">content</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Organization:"</span>, <span class="va">organization</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Language:"</span>, <span class="va">language</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Total:"</span>, <span class="va">total</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Return as a named vector</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>content <span class="op">=</span> <span class="va">content</span>, </span>
<span>    organization <span class="op">=</span> <span class="va">organization</span>, </span>
<span>    language <span class="op">=</span> <span class="va">language</span>, </span>
<span>    total <span class="op">=</span> <span class="va">total</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Returns a data frame (useful for binding multiple results)</span></span>
<span><span class="va">extract_scores_df</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">gpt_output</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">scores</span> <span class="op">&lt;-</span> <span class="fu">extract_scores</span><span class="op">(</span><span class="va">gpt_output</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    content <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"content"</span><span class="op">]</span>,</span>
<span>    organization <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"organization"</span><span class="op">]</span>,</span>
<span>    language <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"language"</span><span class="op">]</span>,</span>
<span>    total <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"total"</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">essay_score_df</span> <span class="op">&lt;-</span> <span class="fu">extract_scores_df</span><span class="op">(</span><span class="va">one_rep_essay</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">essay_score_again</span> <span class="op">&lt;-</span> <span class="fu">claude_plus</span><span class="op">(</span>prompt <span class="op">=</span> <span class="fu">all_rubric_prompt</span><span class="op">(</span><span class="va">focal_prompt</span>, <span class="va">focal_essay</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">essay_score_one</span> <span class="op">&lt;-</span> <span class="fu">extract_scores_df</span><span class="op">(</span><span class="va">essay_score_again</span><span class="op">)</span></span>
<span>  <span class="va">essay_score_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">essay_score_df</span>, <span class="va">essay_score_one</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">essay_score_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">essay_score_df</span>, file <span class="op">=</span> <span class="st">"data/essay_score_df.Rdata"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s now see how consistently the model applied the scores to the essay:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Function to get summary statistics for multiple scored essays</span></span>
<span><span class="va">summarize_scores</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">score_df</span><span class="op">)</span><span class="op">{</span></span>
<span> </span>
<span>  <span class="co"># Calculate summary statistics</span></span>
<span>  <span class="va">summary_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Content"</span>, <span class="st">"Organization"</span>, <span class="st">"Language"</span>, <span class="st">"Total"</span><span class="op">)</span>,</span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">score_df</span><span class="op">$</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">summary_stats</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data/essay_score_df.Rdata"</span><span class="op">)</span></span>
<span><span class="va">score_summary</span> <span class="op">&lt;-</span> <span class="fu">summarize_scores</span><span class="op">(</span><span class="va">essay_score_df</span><span class="op">)</span></span>
<span><span class="va">score_summary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>     criterion  mean        sd min  max
1      Content 3.025 0.1118034 3.0  3.5
2 Organization 3.250 0.2564946 3.0  3.5
3     Language 3.500 0.0000000 3.5  3.5
4        Total 9.775 0.2552089 9.5 10.0</code></pre>
</div>
</div>
<p>Pretty good! There is only .5 variation in scores for <code>Content</code> and <code>Organization</code>, and no variation in <code>Language</code> scores.</p>
</section><section id="repeating-score-task-temp-0" class="level3"><h3 class="anchored" data-anchor-id="repeating-score-task-temp-0">Repeating Score Task (<code>Temp = 0</code>)</h3>
<p>Let’s now repeat the task, but turn the temperature down and see how this affects score variability.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">low_temp_essay</span> <span class="op">&lt;-</span> <span class="fu">claude_plus</span><span class="op">(</span>prompt <span class="op">=</span> <span class="fu">all_rubric_prompt</span><span class="op">(</span><span class="va">focal_prompt</span>, <span class="va">focal_essay</span><span class="op">)</span>,</span>
<span>                              temperature <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">low_temp_df</span> <span class="op">&lt;-</span> <span class="fu">extract_scores_df</span><span class="op">(</span><span class="va">low_temp_essay</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">19</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">low_temp_score_again</span> <span class="op">&lt;-</span> <span class="fu">claude_plus</span><span class="op">(</span>prompt <span class="op">=</span> <span class="fu">all_rubric_prompt</span><span class="op">(</span><span class="va">focal_prompt</span>, <span class="va">focal_essay</span><span class="op">)</span>,</span>
<span>                                      temperature <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">low_temp_score_one</span> <span class="op">&lt;-</span> <span class="fu">extract_scores_df</span><span class="op">(</span><span class="va">low_temp_score_again</span><span class="op">)</span></span>
<span>  <span class="va">low_temp_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">low_temp_df</span>, <span class="va">low_temp_score_one</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">low_temp_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">low_temp_df</span>, file <span class="op">=</span> <span class="st">"data/low_temp_df.Rdata"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data/low_temp_df.Rdata"</span><span class="op">)</span></span>
<span><span class="va">low_temp_summary</span> <span class="op">&lt;-</span> <span class="fu">summarize_scores</span><span class="op">(</span><span class="va">low_temp_df</span><span class="op">)</span></span>
<span><span class="va">low_temp_summary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>     criterion mean sd min max
1      Content  3.0  0 3.0 3.0
2 Organization  3.0  0 3.0 3.0
3     Language  3.5  0 3.5 3.5
4        Total  9.5  0 9.5 9.5</code></pre>
</div>
</div>
<p>Nice! The eliminated all of the score variability. However, given the vague nature of the rubric, we still don’t know if these scores are <em>accurate</em> - we may be consistently missing the mark on what the true score should be. The rubric criteria are broad and it’s unclear how one should apply the rubric. What constitutes each score level for the individual criteria?</p>
<p>Interestingly, when I asked Anthropic for help in developing a scoring rubric for the essays, it recognized that having clear descriptions of the different scoring categories was important, so it made them up! The prompt below shows how the model decided to describe each of the score categories. Obviously these descriptions should be developed and reviewed by subject matter experts, but for the purposes of the workshop we’ll just use what Claude generated. In your process you also want to check that your generative AI model is utilizing the rubric correctly - supplying a detailed rubric and obtaining consistent results alone isn’t sufficient.</p>
</section><section id="scoring-with-detailed-rubric" class="level3"><h3 class="anchored" data-anchor-id="scoring-with-detailed-rubric">Scoring with Detailed Rubric</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">claude_all_rubric_prompt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prompt</span>, <span class="va">essay</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">You are an expert essay grader. Score the following student essay based on three criteria: Content, Organization, and Language. Each criterion should be scored from 1 to 5 in increments of 0.5 (e.g., 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5).</span></span>
<span><span class="st"></span></span>
<span><span class="st">RUBRIC:</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Content (1-5):**</span></span>
<span><span class="st">- 5: Paragraph is exceptionally well-developed and highly relevant to the argument, supported with strong, specific reasons and compelling examples.</span></span>
<span><span class="st">- 4: Paragraph is well-developed and relevant to the argument, supported with clear reasons and good examples.</span></span>
<span><span class="st">- 3: Paragraph is adequately developed with some relevance to the argument, supported with acceptable reasons and examples.</span></span>
<span><span class="st">- 2: Paragraph is underdeveloped or somewhat irrelevant to the argument, with weak or insufficient reasons and examples.</span></span>
<span><span class="st">- 1: Paragraph is poorly developed and largely irrelevant to the argument, lacking meaningful reasons and examples.</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Organization (1-5):**</span></span>
<span><span class="st">- 5: The argument is exceptionally well-structured and developed, making it very easy for the reader to follow ideas and understand how the argument is built. Paragraphs use coherence devices expertly while maintaining clear focus on main ideas.</span></span>
<span><span class="st">- 4: The argument is effectively structured and developed, making it easy for the reader to follow ideas. Paragraphs use coherence devices well and focus on main ideas.</span></span>
<span><span class="st">- 3: The argument has adequate structure and development. The reader can follow most ideas. Paragraphs use some coherence devices and generally focus on main ideas.</span></span>
<span><span class="st">- 2: The argument has weak structure and development. Ideas are sometimes difficult to follow. Paragraphs use few coherence devices and may lose focus.</span></span>
<span><span class="st">- 1: The argument lacks clear structure and development. Ideas are confusing and hard to follow. Paragraphs lack coherence devices and focus.</span></span>
<span><span class="st"></span></span>
<span><span class="st">**Language (1-5):**</span></span>
<span><span class="st">- 5: The writing displays sophisticated control of a wide range of vocabulary and collocations. Grammar and usage are correct throughout. Spelling and punctuation are correct throughout.</span></span>
<span><span class="st">- 4: The writing displays good control of vocabulary and collocations. Grammar and usage are generally correct with only minor errors. Spelling and punctuation are generally correct.</span></span>
<span><span class="st">- 3: The writing displays adequate vocabulary with some variety. Grammar and usage are acceptable with some errors that do not impede understanding. Spelling and punctuation are mostly correct.</span></span>
<span><span class="st">- 2: The writing displays limited vocabulary with little variety. Grammar and usage contain frequent errors that sometimes impede understanding. Spelling and punctuation errors are noticeable.</span></span>
<span><span class="st">- 1: The writing displays very limited vocabulary. Grammar and usage contain numerous errors that significantly impede understanding. Spelling and punctuation errors are frequent.</span></span>
<span><span class="st"></span></span>
<span><span class="st">PROMPT: {prompt}</span></span>
<span><span class="st"></span></span>
<span><span class="st">ESSAY: {essay}</span></span>
<span><span class="st"></span></span>
<span><span class="st">Please provide scores for each criterion and calculate the total score. Format your response as follows:</span></span>
<span><span class="st">Content: [score]</span></span>
<span><span class="st">Organization: [score]</span></span>
<span><span class="st">Language: [score]</span></span>
<span><span class="st">Total: [sum of three scores]</span></span>
<span><span class="st"></span></span>
<span><span class="st">Provide a brief justification (1-2 sentences) for each score.</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s now apply this rubric to the example essay and see how it might impact model-generated scores.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">claude_rubric_score</span> <span class="op">&lt;-</span> <span class="fu">claude_plus</span><span class="op">(</span>prompt <span class="op">=</span> <span class="fu">claude_all_rubric_prompt</span><span class="op">(</span><span class="va">focal_prompt</span>, <span class="va">focal_essay</span><span class="op">)</span>,</span>
<span>                                   temperature <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">claude_rubric_df</span> <span class="op">&lt;-</span> <span class="fu">extract_scores_df</span><span class="op">(</span><span class="va">claude_rubric_score</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">19</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">claude_rubric_score_again</span> <span class="op">&lt;-</span> <span class="fu">claude_plus</span><span class="op">(</span>prompt <span class="op">=</span> <span class="fu">claude_all_rubric_prompt</span><span class="op">(</span><span class="va">focal_prompt</span>, <span class="va">focal_essay</span><span class="op">)</span>,</span>
<span>                                           temperature <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">claude_rubric_one</span> <span class="op">&lt;-</span> <span class="fu">extract_scores_df</span><span class="op">(</span><span class="va">claude_rubric_score_again</span><span class="op">)</span></span>
<span>  <span class="va">claude_rubric_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">claude_rubric_df</span>, <span class="va">claude_rubric_one</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">claude_rubric_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">claude_rubric_df</span>, file <span class="op">=</span> <span class="st">"data/claude_rubric_df.Rdata"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data/claude_rubric_df.Rdata"</span><span class="op">)</span></span>
<span><span class="va">claude_rubric_summary</span> <span class="op">&lt;-</span> <span class="fu">summarize_scores</span><span class="op">(</span><span class="va">claude_rubric_df</span><span class="op">)</span></span>
<span><span class="va">claude_rubric_summary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>     criterion mean sd min max
1      Content  3.0  0 3.0 3.0
2 Organization  3.0  0 3.0 3.0
3     Language  3.5  0 3.5 3.5
4        Total  9.5  0 9.5 9.5</code></pre>
</div>
</div>
<p>Whoa! These are the exact same scores as when we didn’t provide detailed rubric explanation in our prompt. This suggests to me that the model is generating a similar rubric each time through <a href="@sec-invisble">invisible instructions</a>, but I can’t know this for sure.</p>
<p>It has also been empirically demonstrated (find the citations, Chris) that these models don’t apply rubrics well at the extremes - the lowest and highest scores. When I used Claude to help generate synthetic student responses, I asked it have a range of score values represented in the 10 generated essays. It’ll be useful to repeat the same experiment on all 10 essays to see if the scoring variability is consistent across the score range. (There’s a strong possibility that it will be - I asked Claude to generate the essays and now I’m asking it to score essays it generated.)</p>
</section><section id="batch-scoring" class="level3"><h3 class="anchored" data-anchor-id="batch-scoring">Batch Scoring</h3>
<p>Now that we’re repeating the same task across a batch of essays, it’s a great time to introduce batch scoring! This generally works as you’d think - you submit multiple tasks at once to the API to complete in parallel - with the one wrinkle that Anthropic requires that the requests be in the JSONL format. In addition to being able to submit multiple requests at once, it’s also cheaper to use than single-call API interactions. As of this writing (Oct 19, 2025), you save 50% with batch pricing. This drops input costs from $3 per 1M tokens to $1.50 per 1M token, and output costs from $15 per 1M tokens to $7.50 per 1M tokens.</p>
<section id="creating-batch-requests" class="level4"><h4 class="anchored" data-anchor-id="creating-batch-requests">Creating Batch Requests</h4>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Step 1: Read essays and create batch requests</span></span>
<span><span class="va">create_batch_requests</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">essays_df</span>, <span class="va">n_repetitions</span> <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Create a list to store batch requests</span></span>
<span>  <span class="va">batch_requests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">request_counter</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="co"># Create n_repetitions requests for each essay (grouped by essay)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">essays_df</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">essay_prompt</span> <span class="op">&lt;-</span> <span class="fu">claude_all_rubric_prompt</span><span class="op">(</span><span class="va">essays_df</span><span class="op">$</span><span class="va">prompt</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">essays_df</span><span class="op">$</span><span class="va">essay</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Create 20 requests for this essay</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">rep</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_repetitions</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        custom_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"essay_"</span>, <span class="va">essays_df</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"_rep_"</span>, <span class="va">rep</span><span class="op">)</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>          model <span class="op">=</span> <span class="st">"claude-sonnet-4-20250514"</span>,</span>
<span>          max_tokens <span class="op">=</span> <span class="fl">1024</span>,</span>
<span>          messages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>              role <span class="op">=</span> <span class="st">"user"</span>,</span>
<span>              content <span class="op">=</span> <span class="va">essay_prompt</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">batch_requests</span><span class="op">[[</span><span class="va">request_counter</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">request</span></span>
<span>      <span class="va">request_counter</span> <span class="op">&lt;-</span> <span class="va">request_counter</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Created"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">batch_requests</span><span class="op">)</span>, <span class="st">"batch requests for"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">essays_df</span><span class="op">)</span>, <span class="st">"essays\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">batch_requests</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">essay_batch_requests</span> <span class="op">&lt;-</span> <span class="fu">create_batch_requests</span><span class="op">(</span><span class="va">student_essays</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="writing-requests-to-jsonl" class="level4"><h4 class="anchored" data-anchor-id="writing-requests-to-jsonl">Writing Requests to JSONL</h4>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Step 2: Write requests to JSONL file</span></span>
<span><span class="va">write_batch_file</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">batch_requests</span>, <span class="va">output_file</span> <span class="op">=</span> <span class="st">"batch_requests.jsonl"</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Write each request as a JSON line</span></span>
<span>  <span class="va">jsonl_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">batch_requests</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html">toJSON</a></span><span class="op">(</span><span class="va">req</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/writeLines.html">writeLines</a></span><span class="op">(</span><span class="va">jsonl_lines</span>, <span class="va">output_file</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_file</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">essay_batch_jsonl</span> <span class="op">&lt;-</span> <span class="fu">write_batch_file</span><span class="op">(</span><span class="va">essay_batch_requests</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="submitting-batch-request" class="level4"><h4 class="anchored" data-anchor-id="submitting-batch-request">Submitting Batch Request</h4>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Step 3: Submit batch job to Anthropic</span></span>
<span><span class="va">submit_batch</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">jsonl_file</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Read and parse each line of the JSONL file</span></span>
<span>  <span class="va">jsonl_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="va">jsonl_file</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Parse each JSON line into a list</span></span>
<span>  <span class="va">requests_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">jsonl_lines</span>, <span class="kw">function</span><span class="op">(</span><span class="va">line</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="va">line</span>, simplifyVector <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Create batch</span></span>
<span>  <span class="va">response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/POST.html">POST</a></span><span class="op">(</span></span>
<span>    url <span class="op">=</span> <span class="st">"https://api.anthropic.com/v1/messages/batches"</span>,</span>
<span>    <span class="fu"><a href="https://httr.r-lib.org/reference/add_headers.html">add_headers</a></span><span class="op">(</span></span>
<span>      <span class="st">"x-api-key"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"ANTHROPIC_API_KEY"</span><span class="op">)</span>,</span>
<span>      <span class="st">"anthropic-version"</span> <span class="op">=</span> <span class="st">"2023-06-01"</span>,</span>
<span>      <span class="st">"content-type"</span> <span class="op">=</span> <span class="st">"application/json"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    body <span class="op">=</span> <span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html">toJSON</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      requests <span class="op">=</span> <span class="va">requests_list</span></span>
<span>    <span class="op">)</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    encode <span class="op">=</span> <span class="st">"json"</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://httr.r-lib.org/reference/status_code.html">status_code</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">200</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Error submitting batch: "</span>, <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span>, <span class="st">"text"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span>, <span class="st">"parsed"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Batch submitted successfully!\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Batch ID:"</span>, <span class="va">result</span><span class="op">$</span><span class="va">id</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">essay_batch_info</span> <span class="op">&lt;-</span> <span class="fu">submit_batch</span><span class="op">(</span><span class="va">essay_batch_jsonl</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Batch submitted successfully!</span></span>
<span><span class="co"># Batch ID: msgbatch_018m5hGS9Lm3Gi28UorfsVTS</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="checking-batch-status" class="level4"><h4 class="anchored" data-anchor-id="checking-batch-status">Checking Batch Status</h4>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Step 4: Check batch status</span></span>
<span><span class="va">check_batch_status</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">batch_id</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span></span>
<span>    url <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://api.anthropic.com/v1/messages/batches/"</span>, <span class="va">batch_id</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://httr.r-lib.org/reference/add_headers.html">add_headers</a></span><span class="op">(</span></span>
<span>      <span class="st">"x-api-key"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"ANTHROPIC_API_KEY"</span><span class="op">)</span>,</span>
<span>      <span class="st">"anthropic-version"</span> <span class="op">=</span> <span class="st">"2023-06-01"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://httr.r-lib.org/reference/status_code.html">status_code</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">200</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Error checking batch status: "</span>, <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span>, <span class="st">"text"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span>, <span class="st">"parsed"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">essay_status</span> <span class="op">&lt;-</span> <span class="fu">check_batch_status</span><span class="op">(</span><span class="va">essay_batch_info</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co"># Finished!</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span></span>
<span><span class="va">batch_start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">ymd_hms</a></span><span class="op">(</span><span class="va">essay_status</span><span class="op">$</span><span class="va">created_at</span><span class="op">)</span></span>
<span><span class="va">batch_stop_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">ymd_hms</a></span><span class="op">(</span><span class="va">essay_status</span><span class="op">$</span><span class="va">ended_at</span><span class="op">)</span></span>
<span><span class="va">batch_run_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">batch_stop_time</span> <span class="op">-</span> <span class="va">batch_start_time</span><span class="op">)</span></span>
<span><span class="co"># Time difference of 1.644671 mins</span></span>
<span><span class="co"># Less than 2 minutes to score 200 essays!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="saving-batch-results" class="level4"><h4 class="anchored" data-anchor-id="saving-batch-results">Saving Batch Results</h4>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_batch_results</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">batch_id</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span></span>
<span>    url <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://api.anthropic.com/v1/messages/batches/"</span>, <span class="va">batch_id</span>, <span class="st">"/results"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://httr.r-lib.org/reference/add_headers.html">add_headers</a></span><span class="op">(</span></span>
<span>      <span class="st">"x-api-key"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"ANTHROPIC_API_KEY"</span><span class="op">)</span>,</span>
<span>      <span class="st">"anthropic-version"</span> <span class="op">=</span> <span class="st">"2023-06-01"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://httr.r-lib.org/reference/status_code.html">status_code</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">200</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Error retrieving results: "</span>, <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span>, <span class="st">"text"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Parse JSONL results</span></span>
<span>  <span class="va">results_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span>, <span class="st">"text"</span>, encoding <span class="op">=</span> <span class="st">"UTF-8"</span><span class="op">)</span></span>
<span>  <span class="va">results_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">results_text</span>, <span class="st">"\n"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">results_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">results_lines</span><span class="op">[</span><span class="va">results_lines</span> <span class="op">!=</span> <span class="st">""</span><span class="op">]</span>, <span class="va">fromJSON</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results_list</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">essay_batch_results</span> <span class="op">&lt;-</span> <span class="fu">get_batch_results</span><span class="op">(</span><span class="va">essay_batch_info</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">essay_batch_results</span>, file <span class="op">=</span> <span class="st">"data/essay_batch_results.Rdata"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="extracting-score-from-results" class="level4"><h4 class="anchored" data-anchor-id="extracting-score-from-results">Extracting Score from Results</h4>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Step 6: Extract scores from batch results</span></span>
<span><span class="va">extract_batch_scores</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">results_list</span>, <span class="va">debug</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">scores_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    essay_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    repetition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    content <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    organization <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    language <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">results_list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="va">results_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">type</span> <span class="op">==</span> <span class="st">"succeeded"</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co"># Extract the response text - handle different possible structures</span></span>
<span>      <span class="va">message_content</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">message</span><span class="op">$</span><span class="va">content</span></span>
<span>      </span>
<span>      <span class="co"># Debug: Print structure if requested</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="va">debug</span> <span class="op">&amp;&amp;</span> <span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== DEBUG: First result structure ===\n"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Content class:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Content length:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"First element class:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Extract text from various possible structures</span></span>
<span>      <span class="va">response_text</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>      </span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">is.data.frame</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="co"># If it's a data frame, look for a 'text' column</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="st">"text"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="va">response_text</span> <span class="op">&lt;-</span> <span class="va">message_content</span><span class="op">$</span><span class="va">text</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">first_elem</span> <span class="op">&lt;-</span> <span class="va">message_content</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>        </span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">first_elem</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="co"># Check for $text field</span></span>
<span>          <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">first_elem</span><span class="op">$</span><span class="va">text</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>            <span class="va">response_text</span> <span class="op">&lt;-</span> <span class="va">first_elem</span><span class="op">$</span><span class="va">text</span></span>
<span>          <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">first_elem</span><span class="op">$</span><span class="va">type</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">first_elem</span><span class="op">$</span><span class="va">type</span> <span class="op">==</span> <span class="st">"text"</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">first_elem</span><span class="op">$</span><span class="va">text</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>            <span class="va">response_text</span> <span class="op">&lt;-</span> <span class="va">first_elem</span><span class="op">$</span><span class="va">text</span></span>
<span>          <span class="op">}</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span><span class="op">(</span><span class="va">first_elem</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="va">response_text</span> <span class="op">&lt;-</span> <span class="va">first_elem</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">response_text</span> <span class="op">&lt;-</span> <span class="va">message_content</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># If we still don't have text, try to extract it more aggressively</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">response_text</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">response_text</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="co"># Try to find any 'text' field in the structure</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="va">text_fields</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">message_content</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="st">"text"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">text</span> <span class="kw">else</span> <span class="cn">NULL</span></span>
<span>          <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">text_fields</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="va">response_text</span> <span class="op">&lt;-</span> <span class="va">text_fields</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">response_text</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">response_text</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"Could not extract text for "</span>, <span class="va">result</span><span class="op">$</span><span class="va">custom_id</span><span class="op">)</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="va">debug</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== Full structure for "</span>, <span class="va">result</span><span class="op">$</span><span class="va">custom_id</span>, <span class="st">" ===\n"</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">message_content</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>        <span class="kw">next</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Debug: Print first response text</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="va">debug</span> <span class="op">&amp;&amp;</span> <span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n=== First response text (first 500 chars) ===\n"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">response_text</span>, <span class="fl">1</span>, <span class="fl">500</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Extract scores using our previous function</span></span>
<span>      <span class="va">scores</span> <span class="op">&lt;-</span> <span class="fu">extract_scores</span><span class="op">(</span><span class="va">response_text</span>, debug <span class="op">=</span> <span class="va">debug</span> <span class="op">&amp;&amp;</span> <span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Debug: Check if scores were extracted</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="va">debug</span> <span class="op">&amp;&amp;</span> <span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== Extracted scores ===\n"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Parse custom_id to extract essay_id and repetition</span></span>
<span>      <span class="co"># Format: essay_2001_rep_1</span></span>
<span>      <span class="va">custom_id_parts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">custom_id</span>, <span class="st">"_"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="va">essay_id</span> <span class="op">&lt;-</span> <span class="va">custom_id_parts</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>      <span class="va">repetition</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">custom_id_parts</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">scores_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">scores_df</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>        essay_id <span class="op">=</span> <span class="va">essay_id</span>,</span>
<span>        repetition <span class="op">=</span> <span class="va">repetition</span>,</span>
<span>        content <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"content"</span><span class="op">]</span>,</span>
<span>        organization <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"organization"</span><span class="op">]</span>,</span>
<span>        language <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"language"</span><span class="op">]</span>,</span>
<span>        total <span class="op">=</span> <span class="va">scores</span><span class="op">[</span><span class="st">"total"</span><span class="op">]</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"Request "</span>, <span class="va">result</span><span class="op">$</span><span class="va">custom_id</span>, <span class="st">" failed: "</span>, <span class="va">result</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">error</span><span class="op">$</span><span class="va">message</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">scores_df</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">essay_batch_df</span> <span class="op">&lt;-</span> <span class="fu">extract_batch_scores</span><span class="op">(</span><span class="va">essay_batch_results</span>, debug <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">essay_batch_df</span>, file <span class="op">=</span> <span class="st">'data/essay_batch_df.Rdata'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/DT">DT</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">'data/essay_batch_df.Rdata'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">essay_summary_detailed</span> <span class="op">&lt;-</span> <span class="va">essay_batch_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">essay_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="co"># Content</span></span>
<span>    content_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    content_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    content_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    content_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co"># Organization</span></span>
<span>    org_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    org_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    org_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    org_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co"># Language</span></span>
<span>    lang_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    lang_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    lang_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    lang_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co"># Total</span></span>
<span>    total_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">total_mean</span><span class="op">)</span></span>
<span></span>
<span><span class="va">essay_summary_detailed</span> <span class="op">&lt;-</span> <span class="va">essay_summary_detailed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">essay_summary_detailed</span>, </span>
<span>          options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pageLength <span class="op">=</span> <span class="fl">10</span>, scrollX <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>          caption <span class="op">=</span> <span class="st">"Summary Statistics by Essay (20 repetitions each)"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-9cb6e798e14212b22738" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-9cb6e798e14212b22738">{"x":{"filter":"none","vertical":false,"caption":"<caption>Summary Statistics by Essay (20 repetitions each)<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10"],["2003","2009","2001","2007","2005","2002","2004","2008","2006","2010"],[20,20,20,20,20,20,20,20,20,20],[2.5,2.5,2.5,2.62,2.62,2.95,3.5,4,4,4.5],[0,0,0,0.22,0.22,0.15,0,0,0,0],[2.5,2.5,2.5,2.5,2.5,2.5,3.5,4,4,4.5],[2.5,2.5,2.5,3,3,3,3.5,4,4,4.5],[2,2,2,2.02,2,2.83,4,3.92,3.92,4.08],[0,0,0,0.11,0,0.29,0,0.18,0.18,0.18],[2,2,2,2,2,2.5,4,3.5,3.5,4],[2,2,2,2.5,2,3.5,4,4,4,4.5],[1.5,1.5,1.6,1.57,1.88,3.6,4,4.38,4.4,4.78],[0,0,0.21,0.18,0.22,0.21,0,0.22,0.21,0.26],[1.5,1.5,1.5,1.5,1.5,3.5,4,4,4,4.5],[1.5,1.5,2,2,2,4,4,4.5,4.5,5],[6,6,6.1,6.22,6.5,9.380000000000001,11.5,12.3,12.32,13.35],[0,0,0.21,0.44,0.36,0.46,0,0.38,0.37,0.37],[6,6,6,6,6,9,11.5,11.5,11.5,13],[6,6,6.5,7.5,7,10.5,11.5,12.5,12.5,14]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>essay_id<\/th>\n      <th>n<\/th>\n      <th>content_mean<\/th>\n      <th>content_sd<\/th>\n      <th>content_min<\/th>\n      <th>content_max<\/th>\n      <th>org_mean<\/th>\n      <th>org_sd<\/th>\n      <th>org_min<\/th>\n      <th>org_max<\/th>\n      <th>lang_mean<\/th>\n      <th>lang_sd<\/th>\n      <th>lang_min<\/th>\n      <th>lang_max<\/th>\n      <th>total_mean<\/th>\n      <th>total_sd<\/th>\n      <th>total_min<\/th>\n      <th>total_max<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"essay_id","targets":1},{"name":"n","targets":2},{"name":"content_mean","targets":3},{"name":"content_sd","targets":4},{"name":"content_min","targets":5},{"name":"content_max","targets":6},{"name":"org_mean","targets":7},{"name":"org_sd","targets":8},{"name":"org_min","targets":9},{"name":"org_max","targets":10},{"name":"lang_mean","targets":11},{"name":"lang_sd","targets":12},{"name":"lang_min","targets":13},{"name":"lang_max","targets":14},{"name":"total_mean","targets":15},{"name":"total_sd","targets":16},{"name":"total_min","targets":17},{"name":"total_max","targets":18}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>So we did see some variation, but I also used the default temperature.</p>
</section></section><section id="batch-scoring-temp-0" class="level3"><h3 class="anchored" data-anchor-id="batch-scoring-temp-0">Batch Scoring (<code>Temp = 0</code>)</h3>
<p>Let’s redo the batch call with <code>temperature = 0</code>.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">create_lowtemp_requests</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">essays_df</span>, <span class="va">n_repetitions</span> <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Create a list to store batch requests</span></span>
<span>  <span class="va">batch_requests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">request_counter</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="co"># Create n_repetitions requests for each essay (grouped by essay)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">essays_df</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">essay_prompt</span> <span class="op">&lt;-</span> <span class="fu">claude_all_rubric_prompt</span><span class="op">(</span><span class="va">essays_df</span><span class="op">$</span><span class="va">prompt</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">essays_df</span><span class="op">$</span><span class="va">essay</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Create 20 requests for this essay</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">rep</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_repetitions</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        custom_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"essay_"</span>, <span class="va">essays_df</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"_rep_"</span>, <span class="va">rep</span><span class="op">)</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>          model <span class="op">=</span> <span class="st">"claude-sonnet-4-20250514"</span>,</span>
<span>          max_tokens <span class="op">=</span> <span class="fl">1024</span>,</span>
<span>          temperature <span class="op">=</span> <span class="fl">0</span>, <span class="co"># added low temp</span></span>
<span>          messages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>              role <span class="op">=</span> <span class="st">"user"</span>,</span>
<span>              content <span class="op">=</span> <span class="va">essay_prompt</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">batch_requests</span><span class="op">[[</span><span class="va">request_counter</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">request</span></span>
<span>      <span class="va">request_counter</span> <span class="op">&lt;-</span> <span class="va">request_counter</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Created"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">batch_requests</span><span class="op">)</span>, <span class="st">"batch requests for"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">essays_df</span><span class="op">)</span>, <span class="st">"essays\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">batch_requests</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">lowtemp_batch_requests</span> <span class="op">&lt;-</span> <span class="fu">create_lowtemp_requests</span><span class="op">(</span><span class="va">student_essays</span><span class="op">)</span></span>
<span><span class="va">lowtemp_batch_jsonl</span> <span class="op">&lt;-</span> <span class="fu">write_batch_file</span><span class="op">(</span><span class="va">lowtemp_batch_requests</span><span class="op">)</span></span>
<span><span class="va">lowtemp_batch_info</span> <span class="op">&lt;-</span> <span class="fu">submit_batch</span><span class="op">(</span><span class="va">lowtemp_batch_jsonl</span><span class="op">)</span></span>
<span><span class="co"># Batch submitted successfully!</span></span>
<span><span class="co"># Batch ID: msgbatch_0184nJ7Kui9v6WVVh47939mn </span></span>
<span></span>
<span><span class="va">lowtemp_status</span> <span class="op">&lt;-</span> <span class="fu">check_batch_status</span><span class="op">(</span><span class="va">lowtemp_batch_info</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="va">lowtemp_start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">ymd_hms</a></span><span class="op">(</span><span class="va">lowtemp_status</span><span class="op">$</span><span class="va">created_at</span><span class="op">)</span></span>
<span><span class="va">lowtemp_stop_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">ymd_hms</a></span><span class="op">(</span><span class="va">lowtemp_status</span><span class="op">$</span><span class="va">ended_at</span><span class="op">)</span></span>
<span><span class="va">lowtemp_run_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">lowtemp_stop_time</span> <span class="op">-</span> <span class="va">lowtemp_start_time</span><span class="op">)</span></span>
<span><span class="co"># Time difference of 1.473892 mins</span></span>
<span></span>
<span><span class="va">lowtemp_batch_results</span> <span class="op">&lt;-</span> <span class="fu">get_batch_results</span><span class="op">(</span><span class="va">lowtemp_batch_info</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">lowtemp_batch_results</span>, file <span class="op">=</span> <span class="st">"data/lowtemp_batch_results.Rdata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lowtemp_batch_df</span> <span class="op">&lt;-</span> <span class="fu">extract_batch_scores</span><span class="op">(</span><span class="va">lowtemp_batch_results</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">lowtemp_batch_df</span>, file <span class="op">=</span> <span class="st">'data/lowtemp_batch_df.Rdata'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">'data/lowtemp_batch_df.Rdata'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lowtemp_summary_detailed</span> <span class="op">&lt;-</span> <span class="va">lowtemp_batch_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">essay_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="co"># Content</span></span>
<span>    content_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    content_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    content_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    content_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">content</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co"># Organization</span></span>
<span>    org_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    org_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    org_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    org_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">organization</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co"># Language</span></span>
<span>    lang_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    lang_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    lang_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    lang_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">language</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co"># Total</span></span>
<span>    total_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">total</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">total_mean</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lowtemp_summary_detailed</span> <span class="op">&lt;-</span> <span class="va">lowtemp_summary_detailed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">lowtemp_summary_detailed</span>, </span>
<span>          options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pageLength <span class="op">=</span> <span class="fl">10</span>, scrollX <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>          caption <span class="op">=</span> <span class="st">"Summary Statistics by Essay (20 repetitions each) - Temperature = 0"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-b053fd8583923f8d367c" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-b053fd8583923f8d367c">{"x":{"filter":"none","vertical":false,"caption":"<caption>Summary Statistics by Essay (20 repetitions each) - Temperature = 0<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10"],["2001","2003","2005","2007","2009","2002","2004","2006","2008","2010"],[20,20,20,20,20,20,20,20,20,20],[2.5,2.5,2.5,2.5,2.5,3,3.5,4,4,4.5],[0,0,0,0,0,0,0,0,0,0],[2.5,2.5,2.5,2.5,2.5,3,3.5,4,4,4.5],[2.5,2.5,2.5,2.5,2.5,3,3.5,4,4,4.5],[2,2,2,2,2,3,4,4,4,4],[0,0,0,0,0,0,0,0,0,0],[2,2,2,2,2,3,4,4,4,4],[2,2,2,2,2,3,4,4,4,4],[1.5,1.5,1.5,1.5,1.5,3.5,4,4.5,4.5,5],[0,0,0,0,0,0,0,0,0,0],[1.5,1.5,1.5,1.5,1.5,3.5,4,4.5,4.5,5],[1.5,1.5,1.5,1.5,1.5,3.5,4,4.5,4.5,5],[6,6,6,6,6,9.5,11.5,12.5,12.5,13.5],[0,0,0,0,0,0,0,0,0,0],[6,6,6,6,6,9.5,11.5,12.5,12.5,13.5],[6,6,6,6,6,9.5,11.5,12.5,12.5,13.5]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>essay_id<\/th>\n      <th>n<\/th>\n      <th>content_mean<\/th>\n      <th>content_sd<\/th>\n      <th>content_min<\/th>\n      <th>content_max<\/th>\n      <th>org_mean<\/th>\n      <th>org_sd<\/th>\n      <th>org_min<\/th>\n      <th>org_max<\/th>\n      <th>lang_mean<\/th>\n      <th>lang_sd<\/th>\n      <th>lang_min<\/th>\n      <th>lang_max<\/th>\n      <th>total_mean<\/th>\n      <th>total_sd<\/th>\n      <th>total_min<\/th>\n      <th>total_max<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"essay_id","targets":1},{"name":"n","targets":2},{"name":"content_mean","targets":3},{"name":"content_sd","targets":4},{"name":"content_min","targets":5},{"name":"content_max","targets":6},{"name":"org_mean","targets":7},{"name":"org_sd","targets":8},{"name":"org_min","targets":9},{"name":"org_max","targets":10},{"name":"lang_mean","targets":11},{"name":"lang_sd","targets":12},{"name":"lang_min","targets":13},{"name":"lang_max","targets":14},{"name":"total_mean","targets":15},{"name":"total_sd","targets":16},{"name":"total_min","targets":17},{"name":"total_max","targets":18}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Now we’re seeing more consistent scores, and it took less than 90 seconds to process all 200 requests.</p>
</section><section id="batch-processing-notes" class="level3"><h3 class="anchored" data-anchor-id="batch-processing-notes">Batch Processing Notes</h3>
<p>More notes on batch processing (<a href="https://docs.claude.com/en/docs/build-with-claude/batch-processing">via the Anthropic page about batching</a>; each provider will likely have different functionality):</p>
<ul>
<li>This approach is well-suited to tasks that do not require immediate responses, with most batches finishing in less than 1 hour while reducing costs by 50% and increasing throughput.</li>
<li>A Message Batch is limited to either 100,000 Message requests or 256 MB in size, whichever is reached first.</li>
<li>We process each batch as fast as possible, with most batches completing within 1 hour. You will be able to access batch results when all messages have completed or after 24 hours, whichever comes first. Batches will expire if processing does not complete within 24 hours.</li>
<li>Batch results are available for 29 days after creation. After that, you may still view the Batch, but its results will no longer be available for download.</li>
<li>Rate limits apply to both Batches API HTTP requests and the number of requests within a batch waiting to be processed. <a href="https://docs.claude.com/en/api/rate-limits#message-batches-api">See Message Batches API rate limits.</a> Additionally, we may slow down processing based on current demand and your request volume. In that case, you may see more requests expiring after 24 hours.</li>
</ul>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./activity-scoring-with-rubrics-intro.html" class="pagination-link" aria-label="Introduction: Scoring with Rubrics">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Introduction: Scoring with Rubrics</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./05-shiny-integration.html" class="pagination-link" aria-label="Shiny Integration">
        <span class="nav-page-text">Shiny Integration</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb25" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Activity: Scoring with Rubrics {#sec-act-rubric-task .unnumbered}</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task: Med Ed: Using LLMs to Apply Analytic Rubrics</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task: Med Ed: Using LLMs to Apply Holistic Rubrics</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task: Using LLMs to Apply Holistic Rubrics</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>Many attending AIME-CON are working in non-medical educational settings, so I wanted to develop a different example that may be more applicable to the work that you're doing.</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>For this example I'm going to use the rubric that was part of the <span class="co">[</span><span class="ot">`Dataset for Rubric-based Essay Scoring (DREsS)`</span><span class="co">](https://haneul-yoo.github.io/dress/)</span>.</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>This rubric was based on scoring essays from English as a foreign language (EFL) learners.</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>The essays in that dataset are scored on a range from 1 to 5 with increments of 0.5.</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>The full dataset is available after filling out a <span class="co">[</span><span class="ot">consent form</span><span class="co">](https://docs.google.com/forms/d/e/1FAIpQLSdqlywEiCl5Ddei7T7ujMBpMHFDLRyW7OBo033e_Oe-amGqmQ/viewform)</span>.</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>The rubric has 3 components:</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Criteria** | **Description**                                                                                                                                                                                                                                         <span class="pp">|</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="pp">|--------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Content      <span class="pp">|</span> Paragraph is well-developed and relevant to the argument, supported with strong reasons and examples.                                                                                                                                                   <span class="pp">|</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Organization <span class="pp">|</span> The argument is very effectively structured and developed, making it easy for the reader to follow the ideas and understand how the writer is building the argument. Paragraphs use coherence devices effectively while focusing on a single main idea. <span class="pp">|</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Language     <span class="pp">|</span> The writing displays sophisticated control of a wide range of vocabulary and collocations. The essay follows grammar and usage rules throughout the paper. Spelling and punctuation are correct throughout the paper.                                   <span class="pp">|</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>One of the prompts in the data is: "Do you think that smartphones have destroyed communication among family and friends? Give specific reasons and details to support your opinion."</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>To ensure that I'm compliant with the consent form agreement, I will be using synthetic responses generated (using Claude Sonnet 4.5) based observed student responses. We'll also be using the <span class="co">[</span><span class="ot">`claude_plus` function we used in the parameter testing activity</span><span class="co">](@sec-claude-plus)</span>.</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="fu">### First Model Call </span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>Let's start by asking the model to apply the rubric to an essay. We'll use the default parameters for this first</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'downloads/claude_plus.R'</span>)</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">'data/student_essays.Rdata'</span>)</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>focal_student <span class="ot">&lt;-</span> <span class="fu">subset</span>(student_essays, id <span class="sc">==</span> <span class="dv">2002</span>)</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>focal_prompt <span class="ot">&lt;-</span> focal_student<span class="sc">$</span>prompt</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>focal_essay <span class="ot">&lt;-</span> focal_student<span class="sc">$</span>essay</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Building a function to generate the prompt.</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>all_rubric_prompt <span class="ot">&lt;-</span> <span class="cf">function</span>(prompt, essay){</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a><span class="st">You are an expert essay grader. Score the following student essay based on three criteria: Content, Organization, and Language. Each criterion should be scored from 1 to 5 in increments of 0.5 (e.g., 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5).</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a><span class="st">RUBRIC:</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a><span class="st">**Content (1-5):**</span></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a><span class="st">Paragraph is well-developed and relevant to the argument, supported with strong reasons and examples.</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a><span class="st">**Organization (1-5):**</span></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a><span class="st">The argument is very effectively structured and developed, making it easy for the reader to follow the ideas and understand how the writer is building the argument. Paragraphs use coherence devices effectively while focusing on a single main idea.</span></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a><span class="st"> </span></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a><span class="st">**Language (1-5):**</span></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a><span class="st">The writing displays sophisticated control of a wide range of vocabulary and collocations. The essay follows grammar and usage rules throughout the paper. Spelling and punctuation are correct throughout the paper.</span></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a><span class="st">PROMPT: {prompt}</span></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a><span class="st">ESSAY: {essay}</span></span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a><span class="st">Please provide scores for each criterion and calculate the total score. Format your response as follows:</span></span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a><span class="st">Content: [score]</span></span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a><span class="st">Organization: [score]</span></span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a><span class="st">Language: [score]</span></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a><span class="st">Total: [sum of three scores]</span></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a><span class="st">Provide a brief justification (1-2 sentences) for each score.</span></span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>one_rep_essay <span class="ot">&lt;-</span> <span class="fu">claude_plus</span>(<span class="at">prompt =</span> <span class="fu">all_rubric_prompt</span>(focal_prompt, focal_essay))</span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(one_rep_essay, <span class="at">file =</span> <span class="st">'data/one_rep_essay.Rdata'</span>)</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>Claude's essay evaluation:</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>Essay Evaluation</span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>**Content: 3/5**</span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>The essay presents a balanced view with relevant examples (grandmother video calls, phone distraction), but the development is superficial. The argument lacks depth, multiple examples, and detailed elaboration that would make it well-developed and strongly supported.</span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>**Organization: 3.5/5**</span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>The essay follows a clear structure (introducing both sides, personal example, counterpoint, conclusion) and is easy to follow. However, it's quite brief and would benefit from additional paragraphs to fully develop each main idea separately rather than condensing everything into one paragraph.</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>**Language: 3.5/5**</span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>The writing demonstrates good control of grammar and vocabulary with no significant errors (\"on one hand/on the other hand,\" \"responsibly\"). However, the vocabulary range is relatively basic and lacks the sophistication and variety expected for a top score.</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>**Total: 10/15**</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>As noted in the previously (in WHAT section), part of the beauty of generative AI model is the variability in output. Great for creative tasks, but not optimal for things like the present task of applying a scoring rubric to a student response.</span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a><span class="fu">### Repeating Score Task </span></span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>Let's repeat the above process 20 times, extracting the scores after each model response.</span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to extract scores</span></span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Set your Anthropic API key</span></span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a>ANTHROPIC_API_KEY <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">"ANTHROPIC_API_KEY"</span>)</span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the prompt function (from previous artifact)</span></span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a>all_rubric_prompt <span class="ot">&lt;-</span> <span class="cf">function</span>(prompt, essay){</span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a><span class="st">You are an expert essay grader. Score the following student essay based on three criteria: Content, Organization, and Language. Each criterion should be scored from 1 to 5 in increments of 0.5.</span></span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a><span class="st">RUBRIC:</span></span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a><span class="st">**Content (1-5):**</span></span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a><span class="st">- 5: Exceptionally well-developed and highly relevant, with strong reasons and compelling examples.</span></span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a><span class="st">- 4: Well-developed and relevant, with clear reasons and good examples.</span></span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a><span class="st">- 3: Adequately developed with acceptable reasons and examples.</span></span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a><span class="st">- 2: Underdeveloped with weak or insufficient reasons and examples.</span></span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a><span class="st">- 1: Poorly developed and largely irrelevant.</span></span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a><span class="st">**Organization (1-5):**</span></span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a><span class="st">- 5: Exceptionally well-structured, very easy to follow, expert use of coherence devices.</span></span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a><span class="st">- 4: Effectively structured, easy to follow, good use of coherence devices.</span></span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a><span class="st">- 3: Adequate structure, generally followable.</span></span>
<span id="cb25-128"><a href="#cb25-128" aria-hidden="true" tabindex="-1"></a><span class="st">- 2: Weak structure, sometimes difficult to follow.</span></span>
<span id="cb25-129"><a href="#cb25-129" aria-hidden="true" tabindex="-1"></a><span class="st">- 1: Lacks clear structure, confusing.</span></span>
<span id="cb25-130"><a href="#cb25-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-131"><a href="#cb25-131" aria-hidden="true" tabindex="-1"></a><span class="st">**Language (1-5):**</span></span>
<span id="cb25-132"><a href="#cb25-132" aria-hidden="true" tabindex="-1"></a><span class="st">- 5: Sophisticated vocabulary, grammar and spelling correct throughout.</span></span>
<span id="cb25-133"><a href="#cb25-133" aria-hidden="true" tabindex="-1"></a><span class="st">- 4: Good vocabulary control, generally correct with minor errors.</span></span>
<span id="cb25-134"><a href="#cb25-134" aria-hidden="true" tabindex="-1"></a><span class="st">- 3: Adequate vocabulary, acceptable with some errors.</span></span>
<span id="cb25-135"><a href="#cb25-135" aria-hidden="true" tabindex="-1"></a><span class="st">- 2: Limited vocabulary, frequent errors that sometimes impede understanding.</span></span>
<span id="cb25-136"><a href="#cb25-136" aria-hidden="true" tabindex="-1"></a><span class="st">- 1: Very limited vocabulary, numerous errors.</span></span>
<span id="cb25-137"><a href="#cb25-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-138"><a href="#cb25-138" aria-hidden="true" tabindex="-1"></a><span class="st">PROMPT: {prompt}</span></span>
<span id="cb25-139"><a href="#cb25-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-140"><a href="#cb25-140" aria-hidden="true" tabindex="-1"></a><span class="st">ESSAY: {essay}</span></span>
<span id="cb25-141"><a href="#cb25-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-142"><a href="#cb25-142" aria-hidden="true" tabindex="-1"></a><span class="st">Format your response as:</span></span>
<span id="cb25-143"><a href="#cb25-143" aria-hidden="true" tabindex="-1"></a><span class="st">Content: [score]</span></span>
<span id="cb25-144"><a href="#cb25-144" aria-hidden="true" tabindex="-1"></a><span class="st">Organization: [score]</span></span>
<span id="cb25-145"><a href="#cb25-145" aria-hidden="true" tabindex="-1"></a><span class="st">Language: [score]</span></span>
<span id="cb25-146"><a href="#cb25-146" aria-hidden="true" tabindex="-1"></a><span class="st">Total: [sum of three scores]</span></span>
<span id="cb25-147"><a href="#cb25-147" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb25-148"><a href="#cb25-148" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-149"><a href="#cb25-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-150"><a href="#cb25-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Score extraction function with debug capability</span></span>
<span id="cb25-151"><a href="#cb25-151" aria-hidden="true" tabindex="-1"></a>extract_scores <span class="ot">&lt;-</span> <span class="cf">function</span>(gpt_output, <span class="at">debug =</span> <span class="cn">FALSE</span>){</span>
<span id="cb25-152"><a href="#cb25-152" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(debug){</span>
<span id="cb25-153"><a href="#cb25-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"=== DEBUG: Extracting scores ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-154"><a href="#cb25-154" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Input text (first 300 chars):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-155"><a href="#cb25-155" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">substr</span>(gpt_output, <span class="dv">1</span>, <span class="dv">300</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb25-156"><a href="#cb25-156" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-157"><a href="#cb25-157" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-158"><a href="#cb25-158" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract Content score - try multiple patterns</span></span>
<span id="cb25-159"><a href="#cb25-159" aria-hidden="true" tabindex="-1"></a>  content_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"Content:?</span><span class="sc">\\</span><span class="st">s*([0-9.]+)"</span>)</span>
<span id="cb25-160"><a href="#cb25-160" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(content_match[<span class="dv">1</span>, <span class="dv">2</span>])){</span>
<span id="cb25-161"><a href="#cb25-161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try alternate pattern</span></span>
<span id="cb25-162"><a href="#cb25-162" aria-hidden="true" tabindex="-1"></a>    content_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*Content:?</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*[^0-9]*([0-9.]+)"</span>)</span>
<span id="cb25-163"><a href="#cb25-163" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-164"><a href="#cb25-164" aria-hidden="true" tabindex="-1"></a>  content <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(content_match[<span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb25-165"><a href="#cb25-165" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-166"><a href="#cb25-166" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract Organization score</span></span>
<span id="cb25-167"><a href="#cb25-167" aria-hidden="true" tabindex="-1"></a>  org_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"Organization:?</span><span class="sc">\\</span><span class="st">s*([0-9.]+)"</span>)</span>
<span id="cb25-168"><a href="#cb25-168" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(org_match[<span class="dv">1</span>, <span class="dv">2</span>])){</span>
<span id="cb25-169"><a href="#cb25-169" aria-hidden="true" tabindex="-1"></a>    org_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*Organization:?</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*[^0-9]*([0-9.]+)"</span>)</span>
<span id="cb25-170"><a href="#cb25-170" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-171"><a href="#cb25-171" aria-hidden="true" tabindex="-1"></a>  organization <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(org_match[<span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb25-172"><a href="#cb25-172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-173"><a href="#cb25-173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract Language score</span></span>
<span id="cb25-174"><a href="#cb25-174" aria-hidden="true" tabindex="-1"></a>  lang_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"Language:?</span><span class="sc">\\</span><span class="st">s*([0-9.]+)"</span>)</span>
<span id="cb25-175"><a href="#cb25-175" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(lang_match[<span class="dv">1</span>, <span class="dv">2</span>])){</span>
<span id="cb25-176"><a href="#cb25-176" aria-hidden="true" tabindex="-1"></a>    lang_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*Language:?</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*[^0-9]*([0-9.]+)"</span>)</span>
<span id="cb25-177"><a href="#cb25-177" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-178"><a href="#cb25-178" aria-hidden="true" tabindex="-1"></a>  language <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(lang_match[<span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb25-179"><a href="#cb25-179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-180"><a href="#cb25-180" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract Total score</span></span>
<span id="cb25-181"><a href="#cb25-181" aria-hidden="true" tabindex="-1"></a>  total_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"Total:?</span><span class="sc">\\</span><span class="st">s*([0-9.]+)"</span>)</span>
<span id="cb25-182"><a href="#cb25-182" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(total_match[<span class="dv">1</span>, <span class="dv">2</span>])){</span>
<span id="cb25-183"><a href="#cb25-183" aria-hidden="true" tabindex="-1"></a>    total_match <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(gpt_output, <span class="st">"</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*Total:?</span><span class="sc">\\</span><span class="st">*</span><span class="sc">\\</span><span class="st">*[^0-9]*([0-9.]+)"</span>)</span>
<span id="cb25-184"><a href="#cb25-184" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-185"><a href="#cb25-185" aria-hidden="true" tabindex="-1"></a>  total <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(total_match[<span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb25-186"><a href="#cb25-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-187"><a href="#cb25-187" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(debug){</span>
<span id="cb25-188"><a href="#cb25-188" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Extracted values:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-189"><a href="#cb25-189" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Content:"</span>, content, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-190"><a href="#cb25-190" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Organization:"</span>, organization, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-191"><a href="#cb25-191" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Language:"</span>, language, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-192"><a href="#cb25-192" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Total:"</span>, total, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb25-193"><a href="#cb25-193" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-194"><a href="#cb25-194" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-195"><a href="#cb25-195" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return as a named vector</span></span>
<span id="cb25-196"><a href="#cb25-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">content =</span> content, </span>
<span id="cb25-197"><a href="#cb25-197" aria-hidden="true" tabindex="-1"></a>    <span class="at">organization =</span> organization, </span>
<span id="cb25-198"><a href="#cb25-198" aria-hidden="true" tabindex="-1"></a>    <span class="at">language =</span> language, </span>
<span id="cb25-199"><a href="#cb25-199" aria-hidden="true" tabindex="-1"></a>    <span class="at">total =</span> total)</span>
<span id="cb25-200"><a href="#cb25-200" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-201"><a href="#cb25-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-202"><a href="#cb25-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-203"><a href="#cb25-203" aria-hidden="true" tabindex="-1"></a><span class="co"># Returns a data frame (useful for binding multiple results)</span></span>
<span id="cb25-204"><a href="#cb25-204" aria-hidden="true" tabindex="-1"></a>extract_scores_df <span class="ot">&lt;-</span> <span class="cf">function</span>(gpt_output){</span>
<span id="cb25-205"><a href="#cb25-205" aria-hidden="true" tabindex="-1"></a>  scores <span class="ot">&lt;-</span> <span class="fu">extract_scores</span>(gpt_output)</span>
<span id="cb25-206"><a href="#cb25-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb25-207"><a href="#cb25-207" aria-hidden="true" tabindex="-1"></a>    <span class="at">content =</span> scores[<span class="st">"content"</span>],</span>
<span id="cb25-208"><a href="#cb25-208" aria-hidden="true" tabindex="-1"></a>    <span class="at">organization =</span> scores[<span class="st">"organization"</span>],</span>
<span id="cb25-209"><a href="#cb25-209" aria-hidden="true" tabindex="-1"></a>    <span class="at">language =</span> scores[<span class="st">"language"</span>],</span>
<span id="cb25-210"><a href="#cb25-210" aria-hidden="true" tabindex="-1"></a>    <span class="at">total =</span> scores[<span class="st">"total"</span>]</span>
<span id="cb25-211"><a href="#cb25-211" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-212"><a href="#cb25-212" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-213"><a href="#cb25-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-214"><a href="#cb25-214" aria-hidden="true" tabindex="-1"></a>essay_score_df <span class="ot">&lt;-</span> <span class="fu">extract_scores_df</span>(one_rep_essay)</span>
<span id="cb25-215"><a href="#cb25-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-216"><a href="#cb25-216" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">18</span>){</span>
<span id="cb25-217"><a href="#cb25-217" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-218"><a href="#cb25-218" aria-hidden="true" tabindex="-1"></a>  essay_score_again <span class="ot">&lt;-</span> <span class="fu">claude_plus</span>(<span class="at">prompt =</span> <span class="fu">all_rubric_prompt</span>(focal_prompt, focal_essay))</span>
<span id="cb25-219"><a href="#cb25-219" aria-hidden="true" tabindex="-1"></a>  essay_score_one <span class="ot">&lt;-</span> <span class="fu">extract_scores_df</span>(essay_score_again)</span>
<span id="cb25-220"><a href="#cb25-220" aria-hidden="true" tabindex="-1"></a>  essay_score_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(essay_score_df, essay_score_one)</span>
<span id="cb25-221"><a href="#cb25-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-222"><a href="#cb25-222" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-223"><a href="#cb25-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-224"><a href="#cb25-224" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(essay_score_df) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb25-225"><a href="#cb25-225" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(essay_score_df, <span class="at">file =</span> <span class="st">"data/essay_score_df.Rdata"</span>)</span>
<span id="cb25-226"><a href="#cb25-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-227"><a href="#cb25-227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-228"><a href="#cb25-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-229"><a href="#cb25-229" aria-hidden="true" tabindex="-1"></a>Let's now see how consistently the model applied the scores to the essay:</span>
<span id="cb25-230"><a href="#cb25-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-233"><a href="#cb25-233" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb25-234"><a href="#cb25-234" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get summary statistics for multiple scored essays</span></span>
<span id="cb25-235"><a href="#cb25-235" aria-hidden="true" tabindex="-1"></a>summarize_scores <span class="ot">&lt;-</span> <span class="cf">function</span>(score_df){</span>
<span id="cb25-236"><a href="#cb25-236" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb25-237"><a href="#cb25-237" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate summary statistics</span></span>
<span id="cb25-238"><a href="#cb25-238" aria-hidden="true" tabindex="-1"></a>  summary_stats <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb25-239"><a href="#cb25-239" aria-hidden="true" tabindex="-1"></a>    <span class="at">criterion =</span> <span class="fu">c</span>(<span class="st">"Content"</span>, <span class="st">"Organization"</span>, <span class="st">"Language"</span>, <span class="st">"Total"</span>),</span>
<span id="cb25-240"><a href="#cb25-240" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">c</span>(<span class="fu">mean</span>(score_df<span class="sc">$</span>content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-241"><a href="#cb25-241" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mean</span>(score_df<span class="sc">$</span>organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-242"><a href="#cb25-242" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mean</span>(score_df<span class="sc">$</span>language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-243"><a href="#cb25-243" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mean</span>(score_df<span class="sc">$</span>total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb25-244"><a href="#cb25-244" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">c</span>(<span class="fu">sd</span>(score_df<span class="sc">$</span>content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-245"><a href="#cb25-245" aria-hidden="true" tabindex="-1"></a>           <span class="fu">sd</span>(score_df<span class="sc">$</span>organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-246"><a href="#cb25-246" aria-hidden="true" tabindex="-1"></a>           <span class="fu">sd</span>(score_df<span class="sc">$</span>language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-247"><a href="#cb25-247" aria-hidden="true" tabindex="-1"></a>           <span class="fu">sd</span>(score_df<span class="sc">$</span>total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb25-248"><a href="#cb25-248" aria-hidden="true" tabindex="-1"></a>    <span class="at">min =</span> <span class="fu">c</span>(<span class="fu">min</span>(score_df<span class="sc">$</span>content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-249"><a href="#cb25-249" aria-hidden="true" tabindex="-1"></a>            <span class="fu">min</span>(score_df<span class="sc">$</span>organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-250"><a href="#cb25-250" aria-hidden="true" tabindex="-1"></a>            <span class="fu">min</span>(score_df<span class="sc">$</span>language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-251"><a href="#cb25-251" aria-hidden="true" tabindex="-1"></a>            <span class="fu">min</span>(score_df<span class="sc">$</span>total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb25-252"><a href="#cb25-252" aria-hidden="true" tabindex="-1"></a>    <span class="at">max =</span> <span class="fu">c</span>(<span class="fu">max</span>(score_df<span class="sc">$</span>content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-253"><a href="#cb25-253" aria-hidden="true" tabindex="-1"></a>            <span class="fu">max</span>(score_df<span class="sc">$</span>organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-254"><a href="#cb25-254" aria-hidden="true" tabindex="-1"></a>            <span class="fu">max</span>(score_df<span class="sc">$</span>language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-255"><a href="#cb25-255" aria-hidden="true" tabindex="-1"></a>            <span class="fu">max</span>(score_df<span class="sc">$</span>total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb25-256"><a href="#cb25-256" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-257"><a href="#cb25-257" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-258"><a href="#cb25-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(summary_stats)</span>
<span id="cb25-259"><a href="#cb25-259" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-260"><a href="#cb25-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-261"><a href="#cb25-261" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/essay_score_df.Rdata"</span>)</span>
<span id="cb25-262"><a href="#cb25-262" aria-hidden="true" tabindex="-1"></a>score_summary <span class="ot">&lt;-</span> <span class="fu">summarize_scores</span>(essay_score_df)</span>
<span id="cb25-263"><a href="#cb25-263" aria-hidden="true" tabindex="-1"></a>score_summary</span>
<span id="cb25-264"><a href="#cb25-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-265"><a href="#cb25-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-266"><a href="#cb25-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-267"><a href="#cb25-267" aria-hidden="true" tabindex="-1"></a>Pretty good! There is only .5 variation in scores for <span class="in">`Content`</span> and <span class="in">`Organization`</span>, and no variation in <span class="in">`Language`</span> scores.</span>
<span id="cb25-268"><a href="#cb25-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-269"><a href="#cb25-269" aria-hidden="true" tabindex="-1"></a><span class="fu">### Repeating Score Task (`Temp = 0`)</span></span>
<span id="cb25-270"><a href="#cb25-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-271"><a href="#cb25-271" aria-hidden="true" tabindex="-1"></a>Let's now repeat the task, but turn the temperature down and see how this affects score variability.</span>
<span id="cb25-272"><a href="#cb25-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-273"><a href="#cb25-273" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb25-274"><a href="#cb25-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-275"><a href="#cb25-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-276"><a href="#cb25-276" aria-hidden="true" tabindex="-1"></a>low_temp_essay <span class="ot">&lt;-</span> <span class="fu">claude_plus</span>(<span class="at">prompt =</span> <span class="fu">all_rubric_prompt</span>(focal_prompt, focal_essay),</span>
<span id="cb25-277"><a href="#cb25-277" aria-hidden="true" tabindex="-1"></a>                              <span class="at">temperature =</span> <span class="dv">0</span>)</span>
<span id="cb25-278"><a href="#cb25-278" aria-hidden="true" tabindex="-1"></a>low_temp_df <span class="ot">&lt;-</span> <span class="fu">extract_scores_df</span>(low_temp_essay)</span>
<span id="cb25-279"><a href="#cb25-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-280"><a href="#cb25-280" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">19</span>){</span>
<span id="cb25-281"><a href="#cb25-281" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-282"><a href="#cb25-282" aria-hidden="true" tabindex="-1"></a>  low_temp_score_again <span class="ot">&lt;-</span> <span class="fu">claude_plus</span>(<span class="at">prompt =</span> <span class="fu">all_rubric_prompt</span>(focal_prompt, focal_essay),</span>
<span id="cb25-283"><a href="#cb25-283" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">temperature =</span> <span class="dv">0</span>)</span>
<span id="cb25-284"><a href="#cb25-284" aria-hidden="true" tabindex="-1"></a>  low_temp_score_one <span class="ot">&lt;-</span> <span class="fu">extract_scores_df</span>(low_temp_score_again)</span>
<span id="cb25-285"><a href="#cb25-285" aria-hidden="true" tabindex="-1"></a>  low_temp_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(low_temp_df, low_temp_score_one)</span>
<span id="cb25-286"><a href="#cb25-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-287"><a href="#cb25-287" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-288"><a href="#cb25-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-289"><a href="#cb25-289" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(low_temp_df) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb25-290"><a href="#cb25-290" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(low_temp_df, <span class="at">file =</span> <span class="st">"data/low_temp_df.Rdata"</span>)</span>
<span id="cb25-291"><a href="#cb25-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-292"><a href="#cb25-292" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-295"><a href="#cb25-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb25-296"><a href="#cb25-296" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/low_temp_df.Rdata"</span>)</span>
<span id="cb25-297"><a href="#cb25-297" aria-hidden="true" tabindex="-1"></a>low_temp_summary <span class="ot">&lt;-</span> <span class="fu">summarize_scores</span>(low_temp_df)</span>
<span id="cb25-298"><a href="#cb25-298" aria-hidden="true" tabindex="-1"></a>low_temp_summary</span>
<span id="cb25-299"><a href="#cb25-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-300"><a href="#cb25-300" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-301"><a href="#cb25-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-302"><a href="#cb25-302" aria-hidden="true" tabindex="-1"></a>Nice! </span>
<span id="cb25-303"><a href="#cb25-303" aria-hidden="true" tabindex="-1"></a>The eliminated all of the score variability. However, given the vague nature of the rubric, we still don't know if these scores are _accurate_ - we may be consistently missing the mark on what the true score should be.</span>
<span id="cb25-304"><a href="#cb25-304" aria-hidden="true" tabindex="-1"></a>The rubric criteria are broad and it's unclear how one should apply the rubric.</span>
<span id="cb25-305"><a href="#cb25-305" aria-hidden="true" tabindex="-1"></a>What constitutes each score level for the individual criteria?</span>
<span id="cb25-306"><a href="#cb25-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-307"><a href="#cb25-307" aria-hidden="true" tabindex="-1"></a>Interestingly, when I asked Anthropic for help in developing a scoring rubric for the essays, it recognized that having clear descriptions of the different scoring categories was important, so it made them up!</span>
<span id="cb25-308"><a href="#cb25-308" aria-hidden="true" tabindex="-1"></a>The prompt below shows how the model decided to describe each of the score categories.</span>
<span id="cb25-309"><a href="#cb25-309" aria-hidden="true" tabindex="-1"></a>Obviously these descriptions should be developed and reviewed by subject matter experts, but for the purposes of the workshop we'll just use what Claude generated.</span>
<span id="cb25-310"><a href="#cb25-310" aria-hidden="true" tabindex="-1"></a>In your process you also want to check that your generative AI model is utilizing the rubric correctly - supplying a detailed rubric and obtaining consistent results alone isn't sufficient.</span>
<span id="cb25-311"><a href="#cb25-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-312"><a href="#cb25-312" aria-hidden="true" tabindex="-1"></a><span class="fu">### Scoring with Detailed Rubric </span></span>
<span id="cb25-313"><a href="#cb25-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-314"><a href="#cb25-314" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb25-315"><a href="#cb25-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-316"><a href="#cb25-316" aria-hidden="true" tabindex="-1"></a>claude_all_rubric_prompt <span class="ot">&lt;-</span> <span class="cf">function</span>(prompt, essay){</span>
<span id="cb25-317"><a href="#cb25-317" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb25-318"><a href="#cb25-318" aria-hidden="true" tabindex="-1"></a><span class="st">You are an expert essay grader. Score the following student essay based on three criteria: Content, Organization, and Language. Each criterion should be scored from 1 to 5 in increments of 0.5 (e.g., 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5).</span></span>
<span id="cb25-319"><a href="#cb25-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-320"><a href="#cb25-320" aria-hidden="true" tabindex="-1"></a><span class="st">RUBRIC:</span></span>
<span id="cb25-321"><a href="#cb25-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-322"><a href="#cb25-322" aria-hidden="true" tabindex="-1"></a><span class="st">**Content (1-5):**</span></span>
<span id="cb25-323"><a href="#cb25-323" aria-hidden="true" tabindex="-1"></a><span class="st">- 5: Paragraph is exceptionally well-developed and highly relevant to the argument, supported with strong, specific reasons and compelling examples.</span></span>
<span id="cb25-324"><a href="#cb25-324" aria-hidden="true" tabindex="-1"></a><span class="st">- 4: Paragraph is well-developed and relevant to the argument, supported with clear reasons and good examples.</span></span>
<span id="cb25-325"><a href="#cb25-325" aria-hidden="true" tabindex="-1"></a><span class="st">- 3: Paragraph is adequately developed with some relevance to the argument, supported with acceptable reasons and examples.</span></span>
<span id="cb25-326"><a href="#cb25-326" aria-hidden="true" tabindex="-1"></a><span class="st">- 2: Paragraph is underdeveloped or somewhat irrelevant to the argument, with weak or insufficient reasons and examples.</span></span>
<span id="cb25-327"><a href="#cb25-327" aria-hidden="true" tabindex="-1"></a><span class="st">- 1: Paragraph is poorly developed and largely irrelevant to the argument, lacking meaningful reasons and examples.</span></span>
<span id="cb25-328"><a href="#cb25-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-329"><a href="#cb25-329" aria-hidden="true" tabindex="-1"></a><span class="st">**Organization (1-5):**</span></span>
<span id="cb25-330"><a href="#cb25-330" aria-hidden="true" tabindex="-1"></a><span class="st">- 5: The argument is exceptionally well-structured and developed, making it very easy for the reader to follow ideas and understand how the argument is built. Paragraphs use coherence devices expertly while maintaining clear focus on main ideas.</span></span>
<span id="cb25-331"><a href="#cb25-331" aria-hidden="true" tabindex="-1"></a><span class="st">- 4: The argument is effectively structured and developed, making it easy for the reader to follow ideas. Paragraphs use coherence devices well and focus on main ideas.</span></span>
<span id="cb25-332"><a href="#cb25-332" aria-hidden="true" tabindex="-1"></a><span class="st">- 3: The argument has adequate structure and development. The reader can follow most ideas. Paragraphs use some coherence devices and generally focus on main ideas.</span></span>
<span id="cb25-333"><a href="#cb25-333" aria-hidden="true" tabindex="-1"></a><span class="st">- 2: The argument has weak structure and development. Ideas are sometimes difficult to follow. Paragraphs use few coherence devices and may lose focus.</span></span>
<span id="cb25-334"><a href="#cb25-334" aria-hidden="true" tabindex="-1"></a><span class="st">- 1: The argument lacks clear structure and development. Ideas are confusing and hard to follow. Paragraphs lack coherence devices and focus.</span></span>
<span id="cb25-335"><a href="#cb25-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-336"><a href="#cb25-336" aria-hidden="true" tabindex="-1"></a><span class="st">**Language (1-5):**</span></span>
<span id="cb25-337"><a href="#cb25-337" aria-hidden="true" tabindex="-1"></a><span class="st">- 5: The writing displays sophisticated control of a wide range of vocabulary and collocations. Grammar and usage are correct throughout. Spelling and punctuation are correct throughout.</span></span>
<span id="cb25-338"><a href="#cb25-338" aria-hidden="true" tabindex="-1"></a><span class="st">- 4: The writing displays good control of vocabulary and collocations. Grammar and usage are generally correct with only minor errors. Spelling and punctuation are generally correct.</span></span>
<span id="cb25-339"><a href="#cb25-339" aria-hidden="true" tabindex="-1"></a><span class="st">- 3: The writing displays adequate vocabulary with some variety. Grammar and usage are acceptable with some errors that do not impede understanding. Spelling and punctuation are mostly correct.</span></span>
<span id="cb25-340"><a href="#cb25-340" aria-hidden="true" tabindex="-1"></a><span class="st">- 2: The writing displays limited vocabulary with little variety. Grammar and usage contain frequent errors that sometimes impede understanding. Spelling and punctuation errors are noticeable.</span></span>
<span id="cb25-341"><a href="#cb25-341" aria-hidden="true" tabindex="-1"></a><span class="st">- 1: The writing displays very limited vocabulary. Grammar and usage contain numerous errors that significantly impede understanding. Spelling and punctuation errors are frequent.</span></span>
<span id="cb25-342"><a href="#cb25-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-343"><a href="#cb25-343" aria-hidden="true" tabindex="-1"></a><span class="st">PROMPT: {prompt}</span></span>
<span id="cb25-344"><a href="#cb25-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-345"><a href="#cb25-345" aria-hidden="true" tabindex="-1"></a><span class="st">ESSAY: {essay}</span></span>
<span id="cb25-346"><a href="#cb25-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-347"><a href="#cb25-347" aria-hidden="true" tabindex="-1"></a><span class="st">Please provide scores for each criterion and calculate the total score. Format your response as follows:</span></span>
<span id="cb25-348"><a href="#cb25-348" aria-hidden="true" tabindex="-1"></a><span class="st">Content: [score]</span></span>
<span id="cb25-349"><a href="#cb25-349" aria-hidden="true" tabindex="-1"></a><span class="st">Organization: [score]</span></span>
<span id="cb25-350"><a href="#cb25-350" aria-hidden="true" tabindex="-1"></a><span class="st">Language: [score]</span></span>
<span id="cb25-351"><a href="#cb25-351" aria-hidden="true" tabindex="-1"></a><span class="st">Total: [sum of three scores]</span></span>
<span id="cb25-352"><a href="#cb25-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-353"><a href="#cb25-353" aria-hidden="true" tabindex="-1"></a><span class="st">Provide a brief justification (1-2 sentences) for each score.</span></span>
<span id="cb25-354"><a href="#cb25-354" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb25-355"><a href="#cb25-355" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-356"><a href="#cb25-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-357"><a href="#cb25-357" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-358"><a href="#cb25-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-359"><a href="#cb25-359" aria-hidden="true" tabindex="-1"></a>Let's now apply this rubric to the example essay and see how it might impact model-generated scores.</span>
<span id="cb25-360"><a href="#cb25-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-361"><a href="#cb25-361" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb25-362"><a href="#cb25-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-363"><a href="#cb25-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-364"><a href="#cb25-364" aria-hidden="true" tabindex="-1"></a>claude_rubric_score <span class="ot">&lt;-</span> <span class="fu">claude_plus</span>(<span class="at">prompt =</span> <span class="fu">claude_all_rubric_prompt</span>(focal_prompt, focal_essay),</span>
<span id="cb25-365"><a href="#cb25-365" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">temperature =</span> <span class="dv">0</span>)</span>
<span id="cb25-366"><a href="#cb25-366" aria-hidden="true" tabindex="-1"></a>claude_rubric_df <span class="ot">&lt;-</span> <span class="fu">extract_scores_df</span>(claude_rubric_score)</span>
<span id="cb25-367"><a href="#cb25-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-368"><a href="#cb25-368" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">19</span>){</span>
<span id="cb25-369"><a href="#cb25-369" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-370"><a href="#cb25-370" aria-hidden="true" tabindex="-1"></a>  claude_rubric_score_again <span class="ot">&lt;-</span> <span class="fu">claude_plus</span>(<span class="at">prompt =</span> <span class="fu">claude_all_rubric_prompt</span>(focal_prompt, focal_essay),</span>
<span id="cb25-371"><a href="#cb25-371" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">temperature =</span> <span class="dv">0</span>)</span>
<span id="cb25-372"><a href="#cb25-372" aria-hidden="true" tabindex="-1"></a>  claude_rubric_one <span class="ot">&lt;-</span> <span class="fu">extract_scores_df</span>(claude_rubric_score_again)</span>
<span id="cb25-373"><a href="#cb25-373" aria-hidden="true" tabindex="-1"></a>  claude_rubric_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(claude_rubric_df, claude_rubric_one)</span>
<span id="cb25-374"><a href="#cb25-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-375"><a href="#cb25-375" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-376"><a href="#cb25-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-377"><a href="#cb25-377" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(claude_rubric_df) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb25-378"><a href="#cb25-378" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(claude_rubric_df, <span class="at">file =</span> <span class="st">"data/claude_rubric_df.Rdata"</span>)</span>
<span id="cb25-379"><a href="#cb25-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-380"><a href="#cb25-380" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-383"><a href="#cb25-383" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb25-384"><a href="#cb25-384" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/claude_rubric_df.Rdata"</span>)</span>
<span id="cb25-385"><a href="#cb25-385" aria-hidden="true" tabindex="-1"></a>claude_rubric_summary <span class="ot">&lt;-</span> <span class="fu">summarize_scores</span>(claude_rubric_df)</span>
<span id="cb25-386"><a href="#cb25-386" aria-hidden="true" tabindex="-1"></a>claude_rubric_summary</span>
<span id="cb25-387"><a href="#cb25-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-388"><a href="#cb25-388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-389"><a href="#cb25-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-390"><a href="#cb25-390" aria-hidden="true" tabindex="-1"></a>Whoa! These are the exact same scores as when we didn't provide detailed rubric explanation in our prompt.</span>
<span id="cb25-391"><a href="#cb25-391" aria-hidden="true" tabindex="-1"></a>This suggests to me that the model is generating a similar rubric each time through <span class="co">[</span><span class="ot">invisible instructions</span><span class="co">](@sec-invisble)</span>, but I can't know this for sure.</span>
<span id="cb25-392"><a href="#cb25-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-393"><a href="#cb25-393" aria-hidden="true" tabindex="-1"></a>It has also been empirically demonstrated (find the citations, Chris) that these models don't apply rubrics well at the extremes - the lowest and highest scores. </span>
<span id="cb25-394"><a href="#cb25-394" aria-hidden="true" tabindex="-1"></a>When I used Claude to help generate synthetic student responses, I asked it have a range of score values represented in the 10 generated essays.</span>
<span id="cb25-395"><a href="#cb25-395" aria-hidden="true" tabindex="-1"></a>It'll be useful to repeat the same experiment on all 10 essays to see if the scoring variability is consistent across the score range.</span>
<span id="cb25-396"><a href="#cb25-396" aria-hidden="true" tabindex="-1"></a>(There's a strong possibility that it will be - I asked Claude to generate the essays and now I'm asking it to score essays it generated.)</span>
<span id="cb25-397"><a href="#cb25-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-398"><a href="#cb25-398" aria-hidden="true" tabindex="-1"></a><span class="fu">### Batch Scoring</span></span>
<span id="cb25-399"><a href="#cb25-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-400"><a href="#cb25-400" aria-hidden="true" tabindex="-1"></a>Now that we're repeating the same task across a batch of essays, it's a great time to introduce batch scoring!</span>
<span id="cb25-401"><a href="#cb25-401" aria-hidden="true" tabindex="-1"></a>This generally works as you'd think - you submit multiple tasks at once to the API to complete in parallel - with the one wrinkle that Anthropic requires that the requests be in the JSONL format.</span>
<span id="cb25-402"><a href="#cb25-402" aria-hidden="true" tabindex="-1"></a>In addition to being able to submit multiple requests at once, it's also cheaper to use than single-call API interactions.</span>
<span id="cb25-403"><a href="#cb25-403" aria-hidden="true" tabindex="-1"></a>As of this writing (Oct 19, 2025), you save 50% with batch pricing. </span>
<span id="cb25-404"><a href="#cb25-404" aria-hidden="true" tabindex="-1"></a>This drops input costs from \$3 per 1M tokens to \$1.50 per 1M token, and output costs from \$15 per 1M tokens to \$7.50 per 1M tokens.</span>
<span id="cb25-405"><a href="#cb25-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-406"><a href="#cb25-406" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Creating Batch Requests</span></span>
<span id="cb25-407"><a href="#cb25-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-408"><a href="#cb25-408" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb25-409"><a href="#cb25-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-410"><a href="#cb25-410" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Read essays and create batch requests</span></span>
<span id="cb25-411"><a href="#cb25-411" aria-hidden="true" tabindex="-1"></a>create_batch_requests <span class="ot">&lt;-</span> <span class="cf">function</span>(essays_df, <span class="at">n_repetitions =</span> <span class="dv">20</span>){</span>
<span id="cb25-412"><a href="#cb25-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-413"><a href="#cb25-413" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a list to store batch requests</span></span>
<span id="cb25-414"><a href="#cb25-414" aria-hidden="true" tabindex="-1"></a>  batch_requests <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb25-415"><a href="#cb25-415" aria-hidden="true" tabindex="-1"></a>  request_counter <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb25-416"><a href="#cb25-416" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-417"><a href="#cb25-417" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create n_repetitions requests for each essay (grouped by essay)</span></span>
<span id="cb25-418"><a href="#cb25-418" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(essays_df)){</span>
<span id="cb25-419"><a href="#cb25-419" aria-hidden="true" tabindex="-1"></a>    essay_prompt <span class="ot">&lt;-</span> <span class="fu">claude_all_rubric_prompt</span>(essays_df<span class="sc">$</span>prompt[i], essays_df<span class="sc">$</span>essay[i])</span>
<span id="cb25-420"><a href="#cb25-420" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-421"><a href="#cb25-421" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create 20 requests for this essay</span></span>
<span id="cb25-422"><a href="#cb25-422" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(rep <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_repetitions){</span>
<span id="cb25-423"><a href="#cb25-423" aria-hidden="true" tabindex="-1"></a>      request <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb25-424"><a href="#cb25-424" aria-hidden="true" tabindex="-1"></a>        <span class="at">custom_id =</span> <span class="fu">paste0</span>(<span class="st">"essay_"</span>, essays_df<span class="sc">$</span>id[i], <span class="st">"_rep_"</span>, rep),</span>
<span id="cb25-425"><a href="#cb25-425" aria-hidden="true" tabindex="-1"></a>        <span class="at">params =</span> <span class="fu">list</span>(</span>
<span id="cb25-426"><a href="#cb25-426" aria-hidden="true" tabindex="-1"></a>          <span class="at">model =</span> <span class="st">"claude-sonnet-4-20250514"</span>,</span>
<span id="cb25-427"><a href="#cb25-427" aria-hidden="true" tabindex="-1"></a>          <span class="at">max_tokens =</span> <span class="dv">1024</span>,</span>
<span id="cb25-428"><a href="#cb25-428" aria-hidden="true" tabindex="-1"></a>          <span class="at">messages =</span> <span class="fu">list</span>(</span>
<span id="cb25-429"><a href="#cb25-429" aria-hidden="true" tabindex="-1"></a>            <span class="fu">list</span>(</span>
<span id="cb25-430"><a href="#cb25-430" aria-hidden="true" tabindex="-1"></a>              <span class="at">role =</span> <span class="st">"user"</span>,</span>
<span id="cb25-431"><a href="#cb25-431" aria-hidden="true" tabindex="-1"></a>              <span class="at">content =</span> essay_prompt</span>
<span id="cb25-432"><a href="#cb25-432" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb25-433"><a href="#cb25-433" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb25-434"><a href="#cb25-434" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-435"><a href="#cb25-435" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb25-436"><a href="#cb25-436" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-437"><a href="#cb25-437" aria-hidden="true" tabindex="-1"></a>      batch_requests[[request_counter]] <span class="ot">&lt;-</span> request</span>
<span id="cb25-438"><a href="#cb25-438" aria-hidden="true" tabindex="-1"></a>      request_counter <span class="ot">&lt;-</span> request_counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb25-439"><a href="#cb25-439" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-440"><a href="#cb25-440" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-441"><a href="#cb25-441" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-442"><a href="#cb25-442" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Created"</span>, <span class="fu">length</span>(batch_requests), <span class="st">"batch requests for"</span>, <span class="fu">nrow</span>(essays_df), <span class="st">"essays</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-443"><a href="#cb25-443" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-444"><a href="#cb25-444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(batch_requests)</span>
<span id="cb25-445"><a href="#cb25-445" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-446"><a href="#cb25-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-447"><a href="#cb25-447" aria-hidden="true" tabindex="-1"></a>essay_batch_requests <span class="ot">&lt;-</span> <span class="fu">create_batch_requests</span>(student_essays)</span>
<span id="cb25-448"><a href="#cb25-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-449"><a href="#cb25-449" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-450"><a href="#cb25-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-451"><a href="#cb25-451" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Writing Requests to JSONL</span></span>
<span id="cb25-452"><a href="#cb25-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-453"><a href="#cb25-453" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb25-454"><a href="#cb25-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-455"><a href="#cb25-455" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Write requests to JSONL file</span></span>
<span id="cb25-456"><a href="#cb25-456" aria-hidden="true" tabindex="-1"></a>write_batch_file <span class="ot">&lt;-</span> <span class="cf">function</span>(batch_requests, <span class="at">output_file =</span> <span class="st">"batch_requests.jsonl"</span>){</span>
<span id="cb25-457"><a href="#cb25-457" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Write each request as a JSON line</span></span>
<span id="cb25-458"><a href="#cb25-458" aria-hidden="true" tabindex="-1"></a>  jsonl_lines <span class="ot">&lt;-</span> <span class="fu">sapply</span>(batch_requests, <span class="cf">function</span>(req){</span>
<span id="cb25-459"><a href="#cb25-459" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toJSON</span>(req, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-460"><a href="#cb25-460" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb25-461"><a href="#cb25-461" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-462"><a href="#cb25-462" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(jsonl_lines, output_file)</span>
<span id="cb25-463"><a href="#cb25-463" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output_file)</span>
<span id="cb25-464"><a href="#cb25-464" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-465"><a href="#cb25-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-466"><a href="#cb25-466" aria-hidden="true" tabindex="-1"></a>essay_batch_jsonl <span class="ot">&lt;-</span> <span class="fu">write_batch_file</span>(essay_batch_requests)</span>
<span id="cb25-467"><a href="#cb25-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-468"><a href="#cb25-468" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-469"><a href="#cb25-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-470"><a href="#cb25-470" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Submitting Batch Request</span></span>
<span id="cb25-471"><a href="#cb25-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-472"><a href="#cb25-472" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb25-473"><a href="#cb25-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-474"><a href="#cb25-474" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Submit batch job to Anthropic</span></span>
<span id="cb25-475"><a href="#cb25-475" aria-hidden="true" tabindex="-1"></a>submit_batch <span class="ot">&lt;-</span> <span class="cf">function</span>(jsonl_file){</span>
<span id="cb25-476"><a href="#cb25-476" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read and parse each line of the JSONL file</span></span>
<span id="cb25-477"><a href="#cb25-477" aria-hidden="true" tabindex="-1"></a>  jsonl_lines <span class="ot">&lt;-</span> <span class="fu">readLines</span>(jsonl_file)</span>
<span id="cb25-478"><a href="#cb25-478" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-479"><a href="#cb25-479" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse each JSON line into a list</span></span>
<span id="cb25-480"><a href="#cb25-480" aria-hidden="true" tabindex="-1"></a>  requests_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(jsonl_lines, <span class="cf">function</span>(line){</span>
<span id="cb25-481"><a href="#cb25-481" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fromJSON</span>(line, <span class="at">simplifyVector =</span> <span class="cn">FALSE</span>)</span>
<span id="cb25-482"><a href="#cb25-482" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb25-483"><a href="#cb25-483" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-484"><a href="#cb25-484" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create batch</span></span>
<span id="cb25-485"><a href="#cb25-485" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> <span class="fu">POST</span>(</span>
<span id="cb25-486"><a href="#cb25-486" aria-hidden="true" tabindex="-1"></a>    <span class="at">url =</span> <span class="st">"https://api.anthropic.com/v1/messages/batches"</span>,</span>
<span id="cb25-487"><a href="#cb25-487" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_headers</span>(</span>
<span id="cb25-488"><a href="#cb25-488" aria-hidden="true" tabindex="-1"></a>      <span class="st">"x-api-key"</span> <span class="ot">=</span> <span class="fu">Sys.getenv</span>(<span class="st">"ANTHROPIC_API_KEY"</span>),</span>
<span id="cb25-489"><a href="#cb25-489" aria-hidden="true" tabindex="-1"></a>      <span class="st">"anthropic-version"</span> <span class="ot">=</span> <span class="st">"2023-06-01"</span>,</span>
<span id="cb25-490"><a href="#cb25-490" aria-hidden="true" tabindex="-1"></a>      <span class="st">"content-type"</span> <span class="ot">=</span> <span class="st">"application/json"</span></span>
<span id="cb25-491"><a href="#cb25-491" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb25-492"><a href="#cb25-492" aria-hidden="true" tabindex="-1"></a>    <span class="at">body =</span> <span class="fu">toJSON</span>(<span class="fu">list</span>(</span>
<span id="cb25-493"><a href="#cb25-493" aria-hidden="true" tabindex="-1"></a>      <span class="at">requests =</span> requests_list</span>
<span id="cb25-494"><a href="#cb25-494" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-495"><a href="#cb25-495" aria-hidden="true" tabindex="-1"></a>    <span class="at">encode =</span> <span class="st">"json"</span></span>
<span id="cb25-496"><a href="#cb25-496" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-497"><a href="#cb25-497" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-498"><a href="#cb25-498" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">status_code</span>(response) <span class="sc">!=</span> <span class="dv">200</span>){</span>
<span id="cb25-499"><a href="#cb25-499" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Error submitting batch: "</span>, <span class="fu">content</span>(response, <span class="st">"text"</span>))</span>
<span id="cb25-500"><a href="#cb25-500" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-501"><a href="#cb25-501" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-502"><a href="#cb25-502" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">content</span>(response, <span class="st">"parsed"</span>)</span>
<span id="cb25-503"><a href="#cb25-503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Batch submitted successfully!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-504"><a href="#cb25-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Batch ID:"</span>, result<span class="sc">$</span>id, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-505"><a href="#cb25-505" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-506"><a href="#cb25-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb25-507"><a href="#cb25-507" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-508"><a href="#cb25-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-509"><a href="#cb25-509" aria-hidden="true" tabindex="-1"></a>essay_batch_info <span class="ot">&lt;-</span> <span class="fu">submit_batch</span>(essay_batch_jsonl)</span>
<span id="cb25-510"><a href="#cb25-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-511"><a href="#cb25-511" aria-hidden="true" tabindex="-1"></a><span class="co"># Batch submitted successfully!</span></span>
<span id="cb25-512"><a href="#cb25-512" aria-hidden="true" tabindex="-1"></a><span class="co"># Batch ID: msgbatch_018m5hGS9Lm3Gi28UorfsVTS</span></span>
<span id="cb25-513"><a href="#cb25-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-514"><a href="#cb25-514" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-515"><a href="#cb25-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-516"><a href="#cb25-516" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Checking Batch Status</span></span>
<span id="cb25-517"><a href="#cb25-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-518"><a href="#cb25-518" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb25-519"><a href="#cb25-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-520"><a href="#cb25-520" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Check batch status</span></span>
<span id="cb25-521"><a href="#cb25-521" aria-hidden="true" tabindex="-1"></a>check_batch_status <span class="ot">&lt;-</span> <span class="cf">function</span>(batch_id){</span>
<span id="cb25-522"><a href="#cb25-522" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> <span class="fu">GET</span>(</span>
<span id="cb25-523"><a href="#cb25-523" aria-hidden="true" tabindex="-1"></a>    <span class="at">url =</span> <span class="fu">paste0</span>(<span class="st">"https://api.anthropic.com/v1/messages/batches/"</span>, batch_id),</span>
<span id="cb25-524"><a href="#cb25-524" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_headers</span>(</span>
<span id="cb25-525"><a href="#cb25-525" aria-hidden="true" tabindex="-1"></a>      <span class="st">"x-api-key"</span> <span class="ot">=</span> <span class="fu">Sys.getenv</span>(<span class="st">"ANTHROPIC_API_KEY"</span>),</span>
<span id="cb25-526"><a href="#cb25-526" aria-hidden="true" tabindex="-1"></a>      <span class="st">"anthropic-version"</span> <span class="ot">=</span> <span class="st">"2023-06-01"</span></span>
<span id="cb25-527"><a href="#cb25-527" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-528"><a href="#cb25-528" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-529"><a href="#cb25-529" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-530"><a href="#cb25-530" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">status_code</span>(response) <span class="sc">!=</span> <span class="dv">200</span>){</span>
<span id="cb25-531"><a href="#cb25-531" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Error checking batch status: "</span>, <span class="fu">content</span>(response, <span class="st">"text"</span>))</span>
<span id="cb25-532"><a href="#cb25-532" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-533"><a href="#cb25-533" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-534"><a href="#cb25-534" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">content</span>(response, <span class="st">"parsed"</span>)</span>
<span id="cb25-535"><a href="#cb25-535" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb25-536"><a href="#cb25-536" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-537"><a href="#cb25-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-538"><a href="#cb25-538" aria-hidden="true" tabindex="-1"></a>essay_status <span class="ot">&lt;-</span> <span class="fu">check_batch_status</span>(essay_batch_info<span class="sc">$</span>id)</span>
<span id="cb25-539"><a href="#cb25-539" aria-hidden="true" tabindex="-1"></a><span class="co"># Finished!</span></span>
<span id="cb25-540"><a href="#cb25-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-541"><a href="#cb25-541" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb25-542"><a href="#cb25-542" aria-hidden="true" tabindex="-1"></a>batch_start_time <span class="ot">&lt;-</span> <span class="fu">ymd_hms</span>(essay_status<span class="sc">$</span>created_at)</span>
<span id="cb25-543"><a href="#cb25-543" aria-hidden="true" tabindex="-1"></a>batch_stop_time <span class="ot">&lt;-</span> <span class="fu">ymd_hms</span>(essay_status<span class="sc">$</span>ended_at)</span>
<span id="cb25-544"><a href="#cb25-544" aria-hidden="true" tabindex="-1"></a>batch_run_time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(batch_stop_time <span class="sc">-</span> batch_start_time)</span>
<span id="cb25-545"><a href="#cb25-545" aria-hidden="true" tabindex="-1"></a><span class="co"># Time difference of 1.644671 mins</span></span>
<span id="cb25-546"><a href="#cb25-546" aria-hidden="true" tabindex="-1"></a><span class="co"># Less than 2 minutes to score 200 essays!</span></span>
<span id="cb25-547"><a href="#cb25-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-548"><a href="#cb25-548" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-549"><a href="#cb25-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-550"><a href="#cb25-550" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Saving Batch Results</span></span>
<span id="cb25-551"><a href="#cb25-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-552"><a href="#cb25-552" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb25-553"><a href="#cb25-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-554"><a href="#cb25-554" aria-hidden="true" tabindex="-1"></a>get_batch_results <span class="ot">&lt;-</span> <span class="cf">function</span>(batch_id){</span>
<span id="cb25-555"><a href="#cb25-555" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> <span class="fu">GET</span>(</span>
<span id="cb25-556"><a href="#cb25-556" aria-hidden="true" tabindex="-1"></a>    <span class="at">url =</span> <span class="fu">paste0</span>(<span class="st">"https://api.anthropic.com/v1/messages/batches/"</span>, batch_id, <span class="st">"/results"</span>),</span>
<span id="cb25-557"><a href="#cb25-557" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_headers</span>(</span>
<span id="cb25-558"><a href="#cb25-558" aria-hidden="true" tabindex="-1"></a>      <span class="st">"x-api-key"</span> <span class="ot">=</span> <span class="fu">Sys.getenv</span>(<span class="st">"ANTHROPIC_API_KEY"</span>),</span>
<span id="cb25-559"><a href="#cb25-559" aria-hidden="true" tabindex="-1"></a>      <span class="st">"anthropic-version"</span> <span class="ot">=</span> <span class="st">"2023-06-01"</span></span>
<span id="cb25-560"><a href="#cb25-560" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-561"><a href="#cb25-561" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-562"><a href="#cb25-562" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-563"><a href="#cb25-563" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">status_code</span>(response) <span class="sc">!=</span> <span class="dv">200</span>){</span>
<span id="cb25-564"><a href="#cb25-564" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Error retrieving results: "</span>, <span class="fu">content</span>(response, <span class="st">"text"</span>))</span>
<span id="cb25-565"><a href="#cb25-565" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-566"><a href="#cb25-566" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-567"><a href="#cb25-567" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse JSONL results</span></span>
<span id="cb25-568"><a href="#cb25-568" aria-hidden="true" tabindex="-1"></a>  results_text <span class="ot">&lt;-</span> <span class="fu">content</span>(response, <span class="st">"text"</span>, <span class="at">encoding =</span> <span class="st">"UTF-8"</span>)</span>
<span id="cb25-569"><a href="#cb25-569" aria-hidden="true" tabindex="-1"></a>  results_lines <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(results_text, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)[[<span class="dv">1</span>]]</span>
<span id="cb25-570"><a href="#cb25-570" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(results_lines[results_lines <span class="sc">!=</span> <span class="st">""</span>], fromJSON)</span>
<span id="cb25-571"><a href="#cb25-571" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-572"><a href="#cb25-572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb25-573"><a href="#cb25-573" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-574"><a href="#cb25-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-575"><a href="#cb25-575" aria-hidden="true" tabindex="-1"></a>essay_batch_results <span class="ot">&lt;-</span> <span class="fu">get_batch_results</span>(essay_batch_info<span class="sc">$</span>id)</span>
<span id="cb25-576"><a href="#cb25-576" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(essay_batch_results, <span class="at">file =</span> <span class="st">"data/essay_batch_results.Rdata"</span>)</span>
<span id="cb25-577"><a href="#cb25-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-578"><a href="#cb25-578" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-579"><a href="#cb25-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-580"><a href="#cb25-580" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Extracting Score from Results</span></span>
<span id="cb25-581"><a href="#cb25-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-582"><a href="#cb25-582" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb25-583"><a href="#cb25-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-584"><a href="#cb25-584" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Extract scores from batch results</span></span>
<span id="cb25-585"><a href="#cb25-585" aria-hidden="true" tabindex="-1"></a>extract_batch_scores <span class="ot">&lt;-</span> <span class="cf">function</span>(results_list, <span class="at">debug =</span> <span class="cn">FALSE</span>){</span>
<span id="cb25-586"><a href="#cb25-586" aria-hidden="true" tabindex="-1"></a>  scores_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb25-587"><a href="#cb25-587" aria-hidden="true" tabindex="-1"></a>    <span class="at">essay_id =</span> <span class="fu">character</span>(),</span>
<span id="cb25-588"><a href="#cb25-588" aria-hidden="true" tabindex="-1"></a>    <span class="at">repetition =</span> <span class="fu">integer</span>(),</span>
<span id="cb25-589"><a href="#cb25-589" aria-hidden="true" tabindex="-1"></a>    <span class="at">content =</span> <span class="fu">numeric</span>(),</span>
<span id="cb25-590"><a href="#cb25-590" aria-hidden="true" tabindex="-1"></a>    <span class="at">organization =</span> <span class="fu">numeric</span>(),</span>
<span id="cb25-591"><a href="#cb25-591" aria-hidden="true" tabindex="-1"></a>    <span class="at">language =</span> <span class="fu">numeric</span>(),</span>
<span id="cb25-592"><a href="#cb25-592" aria-hidden="true" tabindex="-1"></a>    <span class="at">total =</span> <span class="fu">numeric</span>(),</span>
<span id="cb25-593"><a href="#cb25-593" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb25-594"><a href="#cb25-594" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-595"><a href="#cb25-595" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-596"><a href="#cb25-596" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(results_list)){</span>
<span id="cb25-597"><a href="#cb25-597" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> results_list[[i]]</span>
<span id="cb25-598"><a href="#cb25-598" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-599"><a href="#cb25-599" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(result<span class="sc">$</span>result<span class="sc">$</span>type <span class="sc">==</span> <span class="st">"succeeded"</span>){</span>
<span id="cb25-600"><a href="#cb25-600" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Extract the response text - handle different possible structures</span></span>
<span id="cb25-601"><a href="#cb25-601" aria-hidden="true" tabindex="-1"></a>      message_content <span class="ot">&lt;-</span> result<span class="sc">$</span>result<span class="sc">$</span>message<span class="sc">$</span>content</span>
<span id="cb25-602"><a href="#cb25-602" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-603"><a href="#cb25-603" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Debug: Print structure if requested</span></span>
<span id="cb25-604"><a href="#cb25-604" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(debug <span class="sc">&amp;&amp;</span> i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb25-605"><a href="#cb25-605" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"=== DEBUG: First result structure ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-606"><a href="#cb25-606" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Content class:"</span>, <span class="fu">class</span>(message_content), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-607"><a href="#cb25-607" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Content length:"</span>, <span class="fu">length</span>(message_content), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-608"><a href="#cb25-608" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is.list</span>(message_content) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(message_content) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb25-609"><a href="#cb25-609" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"First element class:"</span>, <span class="fu">class</span>(message_content[[<span class="dv">1</span>]]), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-610"><a href="#cb25-610" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(<span class="fu">str</span>(message_content[[<span class="dv">1</span>]]))</span>
<span id="cb25-611"><a href="#cb25-611" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb25-612"><a href="#cb25-612" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb25-613"><a href="#cb25-613" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-614"><a href="#cb25-614" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Extract text from various possible structures</span></span>
<span id="cb25-615"><a href="#cb25-615" aria-hidden="true" tabindex="-1"></a>      response_text <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb25-616"><a href="#cb25-616" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-617"><a href="#cb25-617" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.data.frame</span>(message_content)){</span>
<span id="cb25-618"><a href="#cb25-618" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If it's a data frame, look for a 'text' column</span></span>
<span id="cb25-619"><a href="#cb25-619" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="st">"text"</span> <span class="sc">%in%</span> <span class="fu">names</span>(message_content)){</span>
<span id="cb25-620"><a href="#cb25-620" aria-hidden="true" tabindex="-1"></a>          response_text <span class="ot">&lt;-</span> message_content<span class="sc">$</span>text[<span class="dv">1</span>]</span>
<span id="cb25-621"><a href="#cb25-621" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb25-622"><a href="#cb25-622" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is.list</span>(message_content) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(message_content) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb25-623"><a href="#cb25-623" aria-hidden="true" tabindex="-1"></a>        first_elem <span class="ot">&lt;-</span> message_content[[<span class="dv">1</span>]]</span>
<span id="cb25-624"><a href="#cb25-624" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-625"><a href="#cb25-625" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is.list</span>(first_elem)){</span>
<span id="cb25-626"><a href="#cb25-626" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Check for $text field</span></span>
<span id="cb25-627"><a href="#cb25-627" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(first_elem<span class="sc">$</span>text)){</span>
<span id="cb25-628"><a href="#cb25-628" aria-hidden="true" tabindex="-1"></a>            response_text <span class="ot">&lt;-</span> first_elem<span class="sc">$</span>text</span>
<span id="cb25-629"><a href="#cb25-629" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(first_elem<span class="sc">$</span>type) <span class="sc">&amp;&amp;</span> first_elem<span class="sc">$</span>type <span class="sc">==</span> <span class="st">"text"</span> <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(first_elem<span class="sc">$</span>text)){</span>
<span id="cb25-630"><a href="#cb25-630" aria-hidden="true" tabindex="-1"></a>            response_text <span class="ot">&lt;-</span> first_elem<span class="sc">$</span>text</span>
<span id="cb25-631"><a href="#cb25-631" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb25-632"><a href="#cb25-632" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is.character</span>(first_elem)){</span>
<span id="cb25-633"><a href="#cb25-633" aria-hidden="true" tabindex="-1"></a>          response_text <span class="ot">&lt;-</span> first_elem</span>
<span id="cb25-634"><a href="#cb25-634" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb25-635"><a href="#cb25-635" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is.character</span>(message_content)){</span>
<span id="cb25-636"><a href="#cb25-636" aria-hidden="true" tabindex="-1"></a>        response_text <span class="ot">&lt;-</span> message_content</span>
<span id="cb25-637"><a href="#cb25-637" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb25-638"><a href="#cb25-638" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-639"><a href="#cb25-639" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If we still don't have text, try to extract it more aggressively</span></span>
<span id="cb25-640"><a href="#cb25-640" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.null</span>(response_text) <span class="sc">||</span> <span class="fu">length</span>(response_text) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb25-641"><a href="#cb25-641" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try to find any 'text' field in the structure</span></span>
<span id="cb25-642"><a href="#cb25-642" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is.list</span>(message_content)){</span>
<span id="cb25-643"><a href="#cb25-643" aria-hidden="true" tabindex="-1"></a>          text_fields <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(message_content, <span class="cf">function</span>(x) {</span>
<span id="cb25-644"><a href="#cb25-644" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">is.list</span>(x) <span class="sc">&amp;&amp;</span> <span class="st">"text"</span> <span class="sc">%in%</span> <span class="fu">names</span>(x)) x<span class="sc">$</span>text <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb25-645"><a href="#cb25-645" aria-hidden="true" tabindex="-1"></a>          }))</span>
<span id="cb25-646"><a href="#cb25-646" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">length</span>(text_fields) <span class="sc">&gt;</span> <span class="dv">0</span>) response_text <span class="ot">&lt;-</span> text_fields[<span class="dv">1</span>]</span>
<span id="cb25-647"><a href="#cb25-647" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb25-648"><a href="#cb25-648" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb25-649"><a href="#cb25-649" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-650"><a href="#cb25-650" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.null</span>(response_text) <span class="sc">||</span> <span class="fu">length</span>(response_text) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb25-651"><a href="#cb25-651" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">"Could not extract text for "</span>, result<span class="sc">$</span>custom_id)</span>
<span id="cb25-652"><a href="#cb25-652" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(debug){</span>
<span id="cb25-653"><a href="#cb25-653" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"=== Full structure for "</span>, result<span class="sc">$</span>custom_id, <span class="st">" ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-654"><a href="#cb25-654" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(<span class="fu">str</span>(message_content))</span>
<span id="cb25-655"><a href="#cb25-655" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb25-656"><a href="#cb25-656" aria-hidden="true" tabindex="-1"></a>        <span class="cf">next</span></span>
<span id="cb25-657"><a href="#cb25-657" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb25-658"><a href="#cb25-658" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-659"><a href="#cb25-659" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Debug: Print first response text</span></span>
<span id="cb25-660"><a href="#cb25-660" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(debug <span class="sc">&amp;&amp;</span> i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb25-661"><a href="#cb25-661" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== First response text (first 500 chars) ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-662"><a href="#cb25-662" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">substr</span>(response_text, <span class="dv">1</span>, <span class="dv">500</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb25-663"><a href="#cb25-663" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb25-664"><a href="#cb25-664" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-665"><a href="#cb25-665" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Extract scores using our previous function</span></span>
<span id="cb25-666"><a href="#cb25-666" aria-hidden="true" tabindex="-1"></a>      scores <span class="ot">&lt;-</span> <span class="fu">extract_scores</span>(response_text, <span class="at">debug =</span> debug <span class="sc">&amp;&amp;</span> i <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb25-667"><a href="#cb25-667" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-668"><a href="#cb25-668" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Debug: Check if scores were extracted</span></span>
<span id="cb25-669"><a href="#cb25-669" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(debug <span class="sc">&amp;&amp;</span> i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb25-670"><a href="#cb25-670" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"=== Extracted scores ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-671"><a href="#cb25-671" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(scores)</span>
<span id="cb25-672"><a href="#cb25-672" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb25-673"><a href="#cb25-673" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-674"><a href="#cb25-674" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Parse custom_id to extract essay_id and repetition</span></span>
<span id="cb25-675"><a href="#cb25-675" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Format: essay_2001_rep_1</span></span>
<span id="cb25-676"><a href="#cb25-676" aria-hidden="true" tabindex="-1"></a>      custom_id_parts <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(result<span class="sc">$</span>custom_id, <span class="st">"_"</span>)[[<span class="dv">1</span>]]</span>
<span id="cb25-677"><a href="#cb25-677" aria-hidden="true" tabindex="-1"></a>      essay_id <span class="ot">&lt;-</span> custom_id_parts[<span class="dv">2</span>]</span>
<span id="cb25-678"><a href="#cb25-678" aria-hidden="true" tabindex="-1"></a>      repetition <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(custom_id_parts[<span class="dv">4</span>])</span>
<span id="cb25-679"><a href="#cb25-679" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-680"><a href="#cb25-680" aria-hidden="true" tabindex="-1"></a>      scores_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(scores_df, <span class="fu">data.frame</span>(</span>
<span id="cb25-681"><a href="#cb25-681" aria-hidden="true" tabindex="-1"></a>        <span class="at">essay_id =</span> essay_id,</span>
<span id="cb25-682"><a href="#cb25-682" aria-hidden="true" tabindex="-1"></a>        <span class="at">repetition =</span> repetition,</span>
<span id="cb25-683"><a href="#cb25-683" aria-hidden="true" tabindex="-1"></a>        <span class="at">content =</span> scores[<span class="st">"content"</span>],</span>
<span id="cb25-684"><a href="#cb25-684" aria-hidden="true" tabindex="-1"></a>        <span class="at">organization =</span> scores[<span class="st">"organization"</span>],</span>
<span id="cb25-685"><a href="#cb25-685" aria-hidden="true" tabindex="-1"></a>        <span class="at">language =</span> scores[<span class="st">"language"</span>],</span>
<span id="cb25-686"><a href="#cb25-686" aria-hidden="true" tabindex="-1"></a>        <span class="at">total =</span> scores[<span class="st">"total"</span>]</span>
<span id="cb25-687"><a href="#cb25-687" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb25-688"><a href="#cb25-688" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb25-689"><a href="#cb25-689" aria-hidden="true" tabindex="-1"></a>      <span class="fu">warning</span>(<span class="st">"Request "</span>, result<span class="sc">$</span>custom_id, <span class="st">" failed: "</span>, result<span class="sc">$</span>result<span class="sc">$</span>error<span class="sc">$</span>message)</span>
<span id="cb25-690"><a href="#cb25-690" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-691"><a href="#cb25-691" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-692"><a href="#cb25-692" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-693"><a href="#cb25-693" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(scores_df)</span>
<span id="cb25-694"><a href="#cb25-694" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-695"><a href="#cb25-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-696"><a href="#cb25-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-697"><a href="#cb25-697" aria-hidden="true" tabindex="-1"></a>essay_batch_df <span class="ot">&lt;-</span> <span class="fu">extract_batch_scores</span>(essay_batch_results, <span class="at">debug =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-698"><a href="#cb25-698" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(essay_batch_df, <span class="at">file =</span> <span class="st">'data/essay_batch_df.Rdata'</span>)</span>
<span id="cb25-699"><a href="#cb25-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-700"><a href="#cb25-700" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-703"><a href="#cb25-703" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb25-704"><a href="#cb25-704" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb25-705"><a href="#cb25-705" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb25-706"><a href="#cb25-706" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">'data/essay_batch_df.Rdata'</span>)</span>
<span id="cb25-707"><a href="#cb25-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-708"><a href="#cb25-708" aria-hidden="true" tabindex="-1"></a>essay_summary_detailed <span class="ot">&lt;-</span> essay_batch_df <span class="sc">%&gt;%</span></span>
<span id="cb25-709"><a href="#cb25-709" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(essay_id) <span class="sc">%&gt;%</span></span>
<span id="cb25-710"><a href="#cb25-710" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb25-711"><a href="#cb25-711" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb25-712"><a href="#cb25-712" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Content</span></span>
<span id="cb25-713"><a href="#cb25-713" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_mean =</span> <span class="fu">mean</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-714"><a href="#cb25-714" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_sd =</span> <span class="fu">sd</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-715"><a href="#cb25-715" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_min =</span> <span class="fu">min</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-716"><a href="#cb25-716" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_max =</span> <span class="fu">max</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-717"><a href="#cb25-717" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Organization</span></span>
<span id="cb25-718"><a href="#cb25-718" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_mean =</span> <span class="fu">mean</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-719"><a href="#cb25-719" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_sd =</span> <span class="fu">sd</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-720"><a href="#cb25-720" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_min =</span> <span class="fu">min</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-721"><a href="#cb25-721" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_max =</span> <span class="fu">max</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-722"><a href="#cb25-722" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Language</span></span>
<span id="cb25-723"><a href="#cb25-723" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_mean =</span> <span class="fu">mean</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-724"><a href="#cb25-724" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_sd =</span> <span class="fu">sd</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-725"><a href="#cb25-725" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_min =</span> <span class="fu">min</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-726"><a href="#cb25-726" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_max =</span> <span class="fu">max</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-727"><a href="#cb25-727" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total</span></span>
<span id="cb25-728"><a href="#cb25-728" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_mean =</span> <span class="fu">mean</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-729"><a href="#cb25-729" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_sd =</span> <span class="fu">sd</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-730"><a href="#cb25-730" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_min =</span> <span class="fu">min</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-731"><a href="#cb25-731" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_max =</span> <span class="fu">max</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-732"><a href="#cb25-732" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-733"><a href="#cb25-733" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(total_mean)</span>
<span id="cb25-734"><a href="#cb25-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-735"><a href="#cb25-735" aria-hidden="true" tabindex="-1"></a>essay_summary_detailed <span class="ot">&lt;-</span> essay_summary_detailed <span class="sc">%&gt;%</span></span>
<span id="cb25-736"><a href="#cb25-736" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">round</span>(.x, <span class="dv">2</span>)))</span>
<span id="cb25-737"><a href="#cb25-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-738"><a href="#cb25-738" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(essay_summary_detailed, </span>
<span id="cb25-739"><a href="#cb25-739" aria-hidden="true" tabindex="-1"></a>          <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>, <span class="at">scrollX =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-740"><a href="#cb25-740" aria-hidden="true" tabindex="-1"></a>          <span class="at">caption =</span> <span class="st">"Summary Statistics by Essay (20 repetitions each)"</span>)</span>
<span id="cb25-741"><a href="#cb25-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-742"><a href="#cb25-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-743"><a href="#cb25-743" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-744"><a href="#cb25-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-745"><a href="#cb25-745" aria-hidden="true" tabindex="-1"></a>So we did see some variation, but I also used the default temperature. </span>
<span id="cb25-746"><a href="#cb25-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-747"><a href="#cb25-747" aria-hidden="true" tabindex="-1"></a><span class="fu">### Batch Scoring (`Temp = 0`)</span></span>
<span id="cb25-748"><a href="#cb25-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-749"><a href="#cb25-749" aria-hidden="true" tabindex="-1"></a>Let's redo the batch call with <span class="in">`temperature = 0`</span>. </span>
<span id="cb25-750"><a href="#cb25-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-751"><a href="#cb25-751" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb25-752"><a href="#cb25-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-753"><a href="#cb25-753" aria-hidden="true" tabindex="-1"></a>create_lowtemp_requests <span class="ot">&lt;-</span> <span class="cf">function</span>(essays_df, <span class="at">n_repetitions =</span> <span class="dv">20</span>){</span>
<span id="cb25-754"><a href="#cb25-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-755"><a href="#cb25-755" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a list to store batch requests</span></span>
<span id="cb25-756"><a href="#cb25-756" aria-hidden="true" tabindex="-1"></a>  batch_requests <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb25-757"><a href="#cb25-757" aria-hidden="true" tabindex="-1"></a>  request_counter <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb25-758"><a href="#cb25-758" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-759"><a href="#cb25-759" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create n_repetitions requests for each essay (grouped by essay)</span></span>
<span id="cb25-760"><a href="#cb25-760" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(essays_df)){</span>
<span id="cb25-761"><a href="#cb25-761" aria-hidden="true" tabindex="-1"></a>    essay_prompt <span class="ot">&lt;-</span> <span class="fu">claude_all_rubric_prompt</span>(essays_df<span class="sc">$</span>prompt[i], essays_df<span class="sc">$</span>essay[i])</span>
<span id="cb25-762"><a href="#cb25-762" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-763"><a href="#cb25-763" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create 20 requests for this essay</span></span>
<span id="cb25-764"><a href="#cb25-764" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(rep <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_repetitions){</span>
<span id="cb25-765"><a href="#cb25-765" aria-hidden="true" tabindex="-1"></a>      request <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb25-766"><a href="#cb25-766" aria-hidden="true" tabindex="-1"></a>        <span class="at">custom_id =</span> <span class="fu">paste0</span>(<span class="st">"essay_"</span>, essays_df<span class="sc">$</span>id[i], <span class="st">"_rep_"</span>, rep),</span>
<span id="cb25-767"><a href="#cb25-767" aria-hidden="true" tabindex="-1"></a>        <span class="at">params =</span> <span class="fu">list</span>(</span>
<span id="cb25-768"><a href="#cb25-768" aria-hidden="true" tabindex="-1"></a>          <span class="at">model =</span> <span class="st">"claude-sonnet-4-20250514"</span>,</span>
<span id="cb25-769"><a href="#cb25-769" aria-hidden="true" tabindex="-1"></a>          <span class="at">max_tokens =</span> <span class="dv">1024</span>,</span>
<span id="cb25-770"><a href="#cb25-770" aria-hidden="true" tabindex="-1"></a>          <span class="at">temperature =</span> <span class="dv">0</span>, <span class="co"># added low temp</span></span>
<span id="cb25-771"><a href="#cb25-771" aria-hidden="true" tabindex="-1"></a>          <span class="at">messages =</span> <span class="fu">list</span>(</span>
<span id="cb25-772"><a href="#cb25-772" aria-hidden="true" tabindex="-1"></a>            <span class="fu">list</span>(</span>
<span id="cb25-773"><a href="#cb25-773" aria-hidden="true" tabindex="-1"></a>              <span class="at">role =</span> <span class="st">"user"</span>,</span>
<span id="cb25-774"><a href="#cb25-774" aria-hidden="true" tabindex="-1"></a>              <span class="at">content =</span> essay_prompt</span>
<span id="cb25-775"><a href="#cb25-775" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb25-776"><a href="#cb25-776" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb25-777"><a href="#cb25-777" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-778"><a href="#cb25-778" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb25-779"><a href="#cb25-779" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-780"><a href="#cb25-780" aria-hidden="true" tabindex="-1"></a>      batch_requests[[request_counter]] <span class="ot">&lt;-</span> request</span>
<span id="cb25-781"><a href="#cb25-781" aria-hidden="true" tabindex="-1"></a>      request_counter <span class="ot">&lt;-</span> request_counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb25-782"><a href="#cb25-782" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-783"><a href="#cb25-783" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-784"><a href="#cb25-784" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-785"><a href="#cb25-785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Created"</span>, <span class="fu">length</span>(batch_requests), <span class="st">"batch requests for"</span>, <span class="fu">nrow</span>(essays_df), <span class="st">"essays</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-786"><a href="#cb25-786" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-787"><a href="#cb25-787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(batch_requests)</span>
<span id="cb25-788"><a href="#cb25-788" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-789"><a href="#cb25-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-790"><a href="#cb25-790" aria-hidden="true" tabindex="-1"></a>lowtemp_batch_requests <span class="ot">&lt;-</span> <span class="fu">create_lowtemp_requests</span>(student_essays)</span>
<span id="cb25-791"><a href="#cb25-791" aria-hidden="true" tabindex="-1"></a>lowtemp_batch_jsonl <span class="ot">&lt;-</span> <span class="fu">write_batch_file</span>(lowtemp_batch_requests)</span>
<span id="cb25-792"><a href="#cb25-792" aria-hidden="true" tabindex="-1"></a>lowtemp_batch_info <span class="ot">&lt;-</span> <span class="fu">submit_batch</span>(lowtemp_batch_jsonl)</span>
<span id="cb25-793"><a href="#cb25-793" aria-hidden="true" tabindex="-1"></a><span class="co"># Batch submitted successfully!</span></span>
<span id="cb25-794"><a href="#cb25-794" aria-hidden="true" tabindex="-1"></a><span class="co"># Batch ID: msgbatch_0184nJ7Kui9v6WVVh47939mn </span></span>
<span id="cb25-795"><a href="#cb25-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-796"><a href="#cb25-796" aria-hidden="true" tabindex="-1"></a>lowtemp_status <span class="ot">&lt;-</span> <span class="fu">check_batch_status</span>(lowtemp_batch_info<span class="sc">$</span>id)</span>
<span id="cb25-797"><a href="#cb25-797" aria-hidden="true" tabindex="-1"></a>lowtemp_start_time <span class="ot">&lt;-</span> <span class="fu">ymd_hms</span>(lowtemp_status<span class="sc">$</span>created_at)</span>
<span id="cb25-798"><a href="#cb25-798" aria-hidden="true" tabindex="-1"></a>lowtemp_stop_time <span class="ot">&lt;-</span> <span class="fu">ymd_hms</span>(lowtemp_status<span class="sc">$</span>ended_at)</span>
<span id="cb25-799"><a href="#cb25-799" aria-hidden="true" tabindex="-1"></a>lowtemp_run_time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(lowtemp_stop_time <span class="sc">-</span> lowtemp_start_time)</span>
<span id="cb25-800"><a href="#cb25-800" aria-hidden="true" tabindex="-1"></a><span class="co"># Time difference of 1.473892 mins</span></span>
<span id="cb25-801"><a href="#cb25-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-802"><a href="#cb25-802" aria-hidden="true" tabindex="-1"></a>lowtemp_batch_results <span class="ot">&lt;-</span> <span class="fu">get_batch_results</span>(lowtemp_batch_info<span class="sc">$</span>id)</span>
<span id="cb25-803"><a href="#cb25-803" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(lowtemp_batch_results, <span class="at">file =</span> <span class="st">"data/lowtemp_batch_results.Rdata"</span>)</span>
<span id="cb25-804"><a href="#cb25-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-805"><a href="#cb25-805" aria-hidden="true" tabindex="-1"></a>lowtemp_batch_df <span class="ot">&lt;-</span> <span class="fu">extract_batch_scores</span>(lowtemp_batch_results)</span>
<span id="cb25-806"><a href="#cb25-806" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(lowtemp_batch_df, <span class="at">file =</span> <span class="st">'data/lowtemp_batch_df.Rdata'</span>)</span>
<span id="cb25-807"><a href="#cb25-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-808"><a href="#cb25-808" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-811"><a href="#cb25-811" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb25-812"><a href="#cb25-812" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">'data/lowtemp_batch_df.Rdata'</span>)</span>
<span id="cb25-813"><a href="#cb25-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-814"><a href="#cb25-814" aria-hidden="true" tabindex="-1"></a>lowtemp_summary_detailed <span class="ot">&lt;-</span> lowtemp_batch_df <span class="sc">%&gt;%</span></span>
<span id="cb25-815"><a href="#cb25-815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(essay_id) <span class="sc">%&gt;%</span></span>
<span id="cb25-816"><a href="#cb25-816" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb25-817"><a href="#cb25-817" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb25-818"><a href="#cb25-818" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Content</span></span>
<span id="cb25-819"><a href="#cb25-819" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_mean =</span> <span class="fu">mean</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-820"><a href="#cb25-820" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_sd =</span> <span class="fu">sd</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-821"><a href="#cb25-821" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_min =</span> <span class="fu">min</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-822"><a href="#cb25-822" aria-hidden="true" tabindex="-1"></a>    <span class="at">content_max =</span> <span class="fu">max</span>(content, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-823"><a href="#cb25-823" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Organization</span></span>
<span id="cb25-824"><a href="#cb25-824" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_mean =</span> <span class="fu">mean</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-825"><a href="#cb25-825" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_sd =</span> <span class="fu">sd</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-826"><a href="#cb25-826" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_min =</span> <span class="fu">min</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-827"><a href="#cb25-827" aria-hidden="true" tabindex="-1"></a>    <span class="at">org_max =</span> <span class="fu">max</span>(organization, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-828"><a href="#cb25-828" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Language</span></span>
<span id="cb25-829"><a href="#cb25-829" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_mean =</span> <span class="fu">mean</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-830"><a href="#cb25-830" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_sd =</span> <span class="fu">sd</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-831"><a href="#cb25-831" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_min =</span> <span class="fu">min</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-832"><a href="#cb25-832" aria-hidden="true" tabindex="-1"></a>    <span class="at">lang_max =</span> <span class="fu">max</span>(language, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-833"><a href="#cb25-833" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total</span></span>
<span id="cb25-834"><a href="#cb25-834" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_mean =</span> <span class="fu">mean</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-835"><a href="#cb25-835" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_sd =</span> <span class="fu">sd</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-836"><a href="#cb25-836" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_min =</span> <span class="fu">min</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-837"><a href="#cb25-837" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_max =</span> <span class="fu">max</span>(total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-838"><a href="#cb25-838" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-839"><a href="#cb25-839" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(total_mean)</span>
<span id="cb25-840"><a href="#cb25-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-841"><a href="#cb25-841" aria-hidden="true" tabindex="-1"></a>lowtemp_summary_detailed <span class="ot">&lt;-</span> lowtemp_summary_detailed <span class="sc">%&gt;%</span></span>
<span id="cb25-842"><a href="#cb25-842" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">round</span>(.x, <span class="dv">2</span>)))</span>
<span id="cb25-843"><a href="#cb25-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-844"><a href="#cb25-844" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(lowtemp_summary_detailed, </span>
<span id="cb25-845"><a href="#cb25-845" aria-hidden="true" tabindex="-1"></a>          <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>, <span class="at">scrollX =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-846"><a href="#cb25-846" aria-hidden="true" tabindex="-1"></a>          <span class="at">caption =</span> <span class="st">"Summary Statistics by Essay (20 repetitions each) - Temperature = 0"</span>)</span>
<span id="cb25-847"><a href="#cb25-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-848"><a href="#cb25-848" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-849"><a href="#cb25-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-850"><a href="#cb25-850" aria-hidden="true" tabindex="-1"></a>Now we're seeing more consistent scores, and it took less than 90 seconds to process all 200 requests.</span>
<span id="cb25-851"><a href="#cb25-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-852"><a href="#cb25-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-853"><a href="#cb25-853" aria-hidden="true" tabindex="-1"></a><span class="fu">### Batch Processing Notes</span></span>
<span id="cb25-854"><a href="#cb25-854" aria-hidden="true" tabindex="-1"></a>More notes on batch processing (<span class="co">[</span><span class="ot">via the Anthropic page about batching</span><span class="co">](https://docs.claude.com/en/docs/build-with-claude/batch-processing)</span>; each provider will likely have different functionality):</span>
<span id="cb25-855"><a href="#cb25-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-856"><a href="#cb25-856" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>This approach is well-suited to tasks that do not require immediate responses, with most batches finishing in less than 1 hour while reducing costs by 50% and increasing throughput.</span>
<span id="cb25-857"><a href="#cb25-857" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A Message Batch is limited to either 100,000 Message requests or 256 MB in size, whichever is reached first.</span>
<span id="cb25-858"><a href="#cb25-858" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We process each batch as fast as possible, with most batches completing within 1 hour. You will be able to access batch results when all messages have completed or after 24 hours, whichever comes first. Batches will expire if processing does not complete within 24 hours.</span>
<span id="cb25-859"><a href="#cb25-859" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Batch results are available for 29 days after creation. After that, you may still view the Batch, but its results will no longer be available for download.</span>
<span id="cb25-860"><a href="#cb25-860" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Rate limits apply to both Batches API HTTP requests and the number of requests within a batch waiting to be processed. <span class="co">[</span><span class="ot">See Message Batches API rate limits.</span><span class="co">](https://docs.claude.com/en/api/rate-limits#message-batches-api)</span> Additionally, we may slow down processing based on current demand and your request volume. In that case, you may see more requests expiring after 24 hours.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>This workshop was developed by Christopher Runyon.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


</body></html>